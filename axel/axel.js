/* ***** BEGIN LICENSE BLOCK *****
 *
 * Copyright (C) 2009-2012  Stéphane Sire
 *
 * This file contains files from the Adaptable XML Editing Library (AXEL)
 * Version 1.4 (Rev git rep)
 *
 * Adaptable XML Editing Library (AXEL) is free software ; you can redistribute it 
 * and/or modify it under the terms of the GNU Lesser General Public License (the "LGPL")
 * as published by the Free Software Foundation ; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * The library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY ; 
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR 
 * PURPOSE. See the GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this library ; 
 * if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, 
 * Boston, MA 02111-1307 USA.
 *
 * Web site : http://media.epfl.ch/Templates/
 * 
 * Contributors(s) : Stephane Sire, Antoine Yersin, Jonathan Wafellmann, Useful Web Sàrl 
 * 
 * ***** END LICENSE BLOCK ***** */
 if(typeof xtiger=="undefined"||!xtiger){var xtiger={};xtiger.COMPONENT=1;xtiger.REPEAT=2;xtiger.USE=3;xtiger.BAG=4;xtiger.ATTRIBUTE=5;xtiger.UNKNOWN=-1}xtiger.parser={};xtiger.editor={};xtiger.cross={};xtiger.util={};xtiger.defaults={};if(typeof xtdom=="undefined"||!xtdom){xtdom={}}xtiger.util.Session=function(){this.store={}};xtiger.util.Session.prototype={save:function(b,a){this.store[b]=a},load:function(a){return this.store[a]}};xtiger.session=function(a){if(!a._xtigerSession){a._xtigerSession=new xtiger.util.Session()}return a._xtigerSession};xtiger.util.Resources=function(){this.bundles={};xtiger.bundles={}};xtiger.util.Resources.prototype={_mountBundle:function(c,e){var a=this.bundles[c];var d=xtiger.bundles[c];for(var b in a){d[b]=e+c+"/"+a[b]}},addBundle:function(c,a){this.bundles[c]=a;xtiger.bundles[c]={};for(var b in a){xtiger.bundles[c][b]=a[b]}},setBase:function(a){if(a.charAt(a.length-1)!="/"){a=a+"/"}for(var b in this.bundles){this._mountBundle(b,a)}}};xtiger.resources=new xtiger.util.Resources();xtiger.util.FactoryRegistry=function(){this.store={}};xtiger.util.FactoryRegistry.prototype={registerFactory:function(b,a){if(this.store[b]){alert("Error (AXEL) attempt to register an already registered factory : '"+b+"' !")}else{this.store[b]=a}},getFactoryFor:function(a){if(!this.store[a]){alert("Fatal Error (AXEL) unkown factory required : '"+a+"' \nYour editor will NOT be generated !")}else{return this.store[a]}},hasFactoryFor:function(a){return !!this.store[a]}};xtiger.registry=new xtiger.util.FactoryRegistry();xtiger.factory=function(a){return xtiger.registry.getFactoryFor(a)};xtdom.counterId=0;xtdom.genId=function(){return xtdom.counterId++};xtdom.createTextNode=function(a,b){return a.createTextNode(b)};xtdom.hasAttribute=function(b,a){return b.hasAttribute(a)};xtdom.removeElement=function(a){var b=a.parentNode;if(!b){return}b.removeChild(a)};xtdom.containsXT=function(b){if(b.nodeType===xtdom.ELEMENT_NODE){if(xtdom.isXT(b)){return true}else{if(b.childNodes&&b.childNodes.length>0){for(var a=0;a<b.childNodes.length;a++){if(xtdom.containsXT(b.childNodes[a])){return true}}}}}return false};xtdom.getMenuMarkerXT=function(e,d){var f,c,b=false;var a=xtdom.getElementsByTagNameXT(e,"menu-marker");if(a.length>0){for(c=0;c<a.length;c++){f=a.item(c);if(((d===undefined)&&(!xtdom.hasAttribute(f,"target")))||(f.getAttribute("target")===d)){b=f;break}}}return b};xtdom.getTagNameXT=function(b){var a=(xtiger.ATTRIBUTE==xtdom.getNodeTypeXT(b))?"name":"label";return b.getAttribute(a)};xtdom.extractDefaultContentXT=function(b){var c;if(xtiger.ATTRIBUTE==xtdom.getNodeTypeXT(b)){c=b.getAttribute("default")}else{if(b.childNodes){for(var a=0;a<b.childNodes.length;a++){var e;var d=b.childNodes[a];if(d.nodeType==xtdom.ELEMENT_NODE){e=d.innerHTML}else{e=d.nodeValue}if(c){c+=e}else{c=e}}}}if(c&&(-1===c.search(/\S/))){c=null}return c};xtdom.getFirstElementChildOf=function(c){var b;for(var a=0;a<c.childNodes.length;a++){if(c.childNodes[a].nodeType==xtdom.ELEMENT_NODE){b=c.childNodes[a];break}}return b};xtdom.moveNodesAfter=function(a,c){var d;if(c.nextSibling){var b=c.nextSibling;while(d=a.shift()){b.parentNode.insertBefore(d,b)}}else{while(d=a.shift()){c.parentNode.appendChild(d)}}};xtdom.moveChildrenOfAfter=function(c,b){var d;if(b.nextSibling){var a=b.nextSibling;while(d=c.firstChild){c.removeChild(d);a.parentNode.insertBefore(d,a)}}else{while(d=c.firstChild){c.removeChild(d);b.parentNode.appendChild(d)}}};xtdom.importChildOfInto=function(b,c,e){for(var a=0;a<c.childNodes.length;a++){var d=c.childNodes[a];var f=xtdom.importNode(b,c.childNodes[a],true);e.appendChild(f)}};xtdom.replaceNodeByChildOf=function(c,a,d){var b=c.parentNode;var e;while(e=a.firstChild){a.removeChild(e);b.insertBefore(e,c,true);if(d){d.push(e)}}b.removeChild(c)};xtdom.removeChildrenOf=function(a){a.innerHTML=""};xtdom.moveChildOfInto=function(b,a,c){var d;while(d=b.firstChild){b.removeChild(d);a.appendChild(d);if(c){c.push(d)}}};xtdom.getInlineDisplay=function(a){var b="";if((a.style)&&(a.style.display)){b=a.style.display}return b};xtdom.getSelectedOpt=function(b){for(var a=0;a<b.options.length;a++){if(b.options[a].selected){break}}return a};xtdom.setSelectedOpt=function(b,a){b.selectedIndex=a};xtdom.addClassName=function(b,a){if(b.className){if(b.className.search(a)==-1){if(b.className.length==0){b.className=a}else{b.className+=" "+a}}}else{b.className=a}};xtdom.removeClassName=function(c,b){if(c.className){var a=c.className.search(b);if(a!=-1){c.className=c.className.substr(0,a)+c.className.substr(a+b.length)}}};xtdom.replaceClassNameBy=function(d,a,b){var c=d.className.search(a);if(c!=-1){d.className=d.className.substr(0,c)+b+d.className.substr(c+a.length)}else{xtdom.addClassName(d,b)}};xtdom.getComputedStyle=function(a,b){if(!a||!a.ownerDocument){return null}var c=a.ownerDocument;if(window.getComputedStyle){return window.getComputedStyle(a,null).getPropertyValue(b)}else{if(a.currentStyle){b=b.replace(/\-(\w)/g,function(d,e){return e.toUpperCase()});return a.currentStyle[b]}}return null};xtdom.findPos=function(b){var c=curtop=0;if(b.offsetParent){c=b.offsetLeft;curtop=b.offsetTop;if(document.defaultView){var a=document.defaultView.getComputedStyle(b,null).getPropertyValue("position")}else{if(document.uniqueID){var a=b.currentStyle.position}}if(b.scrollTop&&(a=="absolute")){curtop-=b.scrollTop}if(b.scrollLeft&&(a=="absolute")){c-=b.scrollLeft}while(b=b.offsetParent){c+=b.offsetLeft;curtop+=b.offsetTop;if(document.defaultView){var a=document.defaultView.getComputedStyle(b,null).getPropertyValue("position")}else{if(document.uniqueID){var a=b.currentStyle.position}}if(b.scrollTop&&(a=="absolute")){curtop-=b.scrollTop}if(b.scrollLeft&&(a=="absolute")){c-=b.scrollLeft}}}return[c,curtop]};xtdom.getWindowLimitFrom=function(d){var c=0,b=0,g=0,f=0;var a=d.ownerDocument;var e=a.defaultView||a.parentWindow;if(typeof(e.innerWidth)=="number"){c=e.innerWidth;b=e.innerHeight}else{if(a.documentElement&&(a.documentElement.clientWidth||a.documentElement.clientHeight)){c=a.documentElement.clientWidth;b=a.documentElement.clientHeight}else{if(a.body&&(a.body.clientWidth||a.body.clientHeight)){c=a.body.clientWidth;b=a.body.clientHeight}}}if(typeof(e.pageYOffset)=="number"){f=e.pageYOffset;g=e.pageXOffset}else{if(document.body&&(document.body.scrollLeft||document.body.scrollTop)){f=document.body.scrollTop;g=document.body.scrollLeft}else{if(document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)){f=document.documentElement.scrollTop;g=document.documentElement.scrollLeft}}}return[c+g,b+f]};xtiger.util.DOMDataSource=function(a){var b;this.xml=null;this.stack=[];if(typeof a==="string"){this.initFromString(a)}else{this.initFromDocument(a)}};xtiger.util.DOMDataSource.prototype={hasData:function(){return(null!=this.xml)},_setRootNode:function(a){this.xml=a},initFromDocument:function(b){var a;this.xml=null;if(b&&b.documentElement){a=b.documentElement;this._setRootNode(a)}return(this.xml!=null)},initFromString:function(d){var a=true;this.xml=null;try{var f=xtiger.cross.makeDOMParser();var c=f.parseFromString(d,"text/xml");this.initFromDocument(c)}catch(b){alert("Exception : "+b.message);a=false}return a},nameFor:function(a){if(a instanceof Array){return xtdom.getLocalName(a[0])}else{return null}},lengthFor:function(a){if(a instanceof Array){return a.length-1}else{return 0}},makeRootVector:function(a){var d=[a];if(a){var f=a.childNodes;for(var b=0;b<f.length;b++){var e=f.item(b);if(e.nodeType==xtdom.ELEMENT_NODE){d.push(e)}}}return d},getRootVector:function(){return this.makeRootVector(this.xml)},hasDataFor:function(b,a){var c=false;if("@"==b.charAt(0)){if(a!==-1){c=xtdom.hasAttribute(a[0],b.substr(1))}}else{if((a instanceof Array)&&(a.length>1)){if(a[1]&&(a[1].nodeType==xtdom.ELEMENT_NODE)){var e=xtdom.getLocalName(a[1]);var d=b.search(e);c=(d!=-1)&&(((d+e.length)==b.length)||(b.charAt(d+e.length)==" "))}}}return c},getDataFor:function(a){if((a instanceof Array)&&(a.length>1)){return a[1]}else{return null}},isEmpty:function(a){var b=false;if((a instanceof Array)&&(a.length>1)){if(a.length==2){if(typeof(a[1])=="string"){b=(a[1].search(/\S/)==-1)}}}else{b=true}return b},getPointAtIndex:function(a,e,j){var g;var b=j.splice(e,1)[0];var h=b.childNodes;if((h.length==1)&&(h.item(0).nodeType==xtdom.TEXT_NODE)){var f=h.item(0).data;g=[b,f]}else{g=[b];for(var d=0;d<h.length;d++){var k=h.item(d);if(k.nodeType==xtdom.ELEMENT_NODE){g.push(k)}}if(g.length==1){g.push(null)}}return g},hasVectorFor:function(b,a){if(a instanceof Array){for(var c=1;c<a.length;c++){if((a[c]!==null)&&(a[c].nodeType==xtdom.ELEMENT_NODE)&&(xtdom.getLocalName(a[c])==b)){return true}}}return false},getVectorFor:function(b,a){if(a instanceof Array){for(var c=1;c<a.length;c++){if((a[c]!==null)&&(a[c].nodeType==xtdom.ELEMENT_NODE)&&(xtdom.getLocalName(a[c])==b)){return this.getPointAtIndex(b,c,a)}}}return -1},hasAttributeFor:function(b,a){return(a instanceof Array)&&(a[0].getAttribute(b)!=null)},getAttributeFor:function(c,b){var d=-1;if(b instanceof Array){var e=b[0];var a=e.getAttribute(c);if(a){e.removeAttribute(c);d=[e,a]}}return d},hasVectorForAnyOf:function(d,a){if(a instanceof Array){for(var c=1;c<a.length;c++){for(var b=0;b<d.length;b++){if((a[c]!==null)&&(a[c].nodeType==xtdom.ELEMENT_NODE)&&xtdom.getLocalName(a[c])==d[b]){return true}}}}return false},getVectorForAnyOf:function(d,a){if(a instanceof Array){for(var c=1;c<a.length;c++){for(var b=0;b<d.length;b++){if((a[c]!==null)&&(a[c].nodeType==xtdom.ELEMENT_NODE)&&xtdom.getLocalName(a[c])==d[b]){return this.getPointAtIndex(d[b],c,a)}}}}return -1}};xtiger.util.PseudoNode=function(a,b){this.type=a;this.discard=false;if(a===xtiger.util.PseudoNode.ELEMENT_NODE){this.name=b;this.attributes=null;this.content=null}else{this.content=b}};xtiger.util.PseudoNode.TEXT_NODE=0;xtiger.util.PseudoNode.ELEMENT_NODE=1;xtiger.util.PseudoNode.MIXED_NODE=2;xtiger.util.PseudoNode.NEWLINE="\n";xtiger.util.PseudoNode.prototype={indent:["","  "],discardNodeIfEmpty:function(){this.discard=true},mix:function(){var a;if(this.type!==xtiger.util.PseudoNode.MIXED_NODE){if(this.content&&!(this.content instanceof Array)){a=this.content;this.content=[a]}this.type=xtiger.util.PseudoNode.MIXED_NODE}},addChild:function(a){if((this.type!==xtiger.util.PseudoNode.MIXED_NODE)&&(xtiger.util.PseudoNode.TEXT_NODE===a.type)){this.content=a}else{if(!this.content){this.content=[]}if(this.content instanceof Array){this.content.push(a)}else{xtiger.cross.log("error","Mixed content ["+this.content+"] in "+this.name)}}},addAttribute:function(a,b){if(!this.attributes){this.attributes={}}this.attributes[a]=b},getIndentForLevel:function(d,c){var a=c?0:d;if(typeof this.indent[a]!=="string"){var b=this.indent[a-1];b+=this.indent[1];this.indent[a]=b}return this.indent[a]},dumpAttributes:function(){var a,b="";for(a in this.attributes){b+=" ";b+=a;b+='="';b+=xtiger.util.encodeEntities(this.attributes[a]);b+='"'}return b},dump:function(d,b){if(xtiger.util.PseudoNode.TEXT_NODE==this.type){return xtiger.util.encodeEntities(this.content)}else{var c=this.getIndentForLevel(d,b);if(this.content){c+="<";c+=this.name;if(this.attributes){c+=this.dumpAttributes()}c+=">";if(this.content instanceof Array){if((this.type!==xtiger.util.PseudoNode.MIXED_NODE)&&!b){c+=xtiger.util.PseudoNode.NEWLINE}for(var a=0;a<this.content.length;a++){c+=this.content[a].dump(d+1,this.type===xtiger.util.PseudoNode.MIXED_NODE)}if((this.type!==xtiger.util.PseudoNode.MIXED_NODE)&&!b){c+=this.getIndentForLevel(d,b)}}else{c+=xtiger.util.encodeEntities(this.content.content)}c+="</";c+=this.name;c+=">"}else{c+="<";c+=this.name;if(this.attributes){c+=this.dumpAttributes()}else{if(this.discard){return""}}c+="/>"}if(!b){c+=xtiger.util.PseudoNode.NEWLINE}return c}}};xtiger.util.DOMLogger=function(){this.stack=[];this.curTop=null;this.curAttr=null;this.curAttrFlushed=false;this.root=null};xtiger.util.DOMLogger.prototype={discardNodeIfEmpty:function(){if(this.curAttr){this.curAttrFlushed=true}else{if(this.curTop){this.curTop.discardNodeIfEmpty()}}},allowMixedContent:function(){if(this.curTop){this.curTop.mix()}},openAttribute:function(a){this.curAttr=a;this.curAttrFlushed=false},closeAttribute:function(a){if(this.curAttr!=a){alert("Attempt to close an attribute "+a+" while in attribute "+this.curAttr+"!")}else{if(!this.curAttrFlushed){this.curTop.addAttribute(this.curAttr,"")}}this.curAttr=null},openTag:function(a){var b=new xtiger.util.PseudoNode(xtiger.util.PseudoNode.ELEMENT_NODE,a);if(!this.root){this.root=b}if(this.curTop){this.curTop.addChild(b)}this.stack.push(this.curTop);this.curTop=b},closeTag:function(a){this.curTop=this.stack.pop()},emptyTag:function(a){this.openTag(a);this.closeTag(a)},write:function(a){if(this.curAttr){this.curTop.addAttribute(this.curAttr,a);this.curAttrFlushed=true}else{var b=new xtiger.util.PseudoNode(xtiger.util.PseudoNode.TEXT_NODE,a);this.curTop.addChild(b)}},writeAttribute:function(a,b){this.curTop.addAttribute(a,b)},dump:function(){if(this.root){return this.root.dump(0)}else{return xtiger.util.PseudoNode.prototype.indent[level]+"<document/>\n"}},close:function(){}};xtiger.cross.UA={IE:!!(window.attachEvent&&navigator.userAgent.indexOf("Opera")===-1),opera:navigator.userAgent.indexOf("Opera")>-1,webKit:navigator.userAgent.indexOf("AppleWebKit/")>-1,gecko:navigator.userAgent.indexOf("Gecko")>-1&&navigator.userAgent.indexOf("KHTML")===-1,mobileSafari:!!navigator.userAgent.match(/Apple.*Mobile.*Safari/)};xtiger.cross.UA.unsafeExpando=xtiger.cross.UA.IE||(navigator.userAgent.indexOf("Trident")!==-1)||(navigator.userAgent.indexOf("Edge")!==-1);xtiger.cross.events={DOWN:(window.Modernizr&&window.Modernizr.touch)?"touchstart":"mousedown"};if(!(xtiger.cross.UA.gecko||xtiger.cross.UA.webKit||xtiger.cross.UA.IE||xtiger.cross.UA.opera||xtiger.cross.UA.mobileSafari)){xtiger.cross.log("warning","XTiger Forms could not detect user agent name, assuming a Gecko like browser");xtiger.cross.UA.gecko=true}xtiger.util.countProperties=function(c){var b=0,a;for(a in c){if(c.hasOwnProperty(a)){b++}}return b};xtiger.util.encodeEntities=function(b){if(typeof(b)!="string"){return b}var a=b;if(b.indexOf("&")!=-1){a=a.replace(/&(?![a-zA-Z]{3,5};)/g,"&amp;")}if(b.indexOf("<")!=-1){a=a.replace(/</g,"&lt;")}if(b.indexOf(">")!=-1){a=a.replace(/>/g,"&gt;")}return a};xtiger.util.decodeParameters=function(b,f){if(!b){return}var a=b.split(";");for(var e=0;e<a.length;e++){var g=a[e].indexOf("=");if(g>0){var d=a[e].substr(0,g);var c=d.replace(/^\s+/,"").replace(/\s+$/,"");if(c.length>0){if(c=="class"){c="hasClass"}f[c]=a[e].substr(g+1).replace(/^\s+/,"").replace(/\s+$/,"")}}}};xtiger.util.array_map=function array_map(d,a){if(!(typeof d=="object"&&typeof a=="function")){return d}var b=[];for(var c=0;c<d.length;c++){b[c]=a(d[c])}return b};xtiger.util.getLocaleString=function getLocaleString(d,b){var a=xtiger.defaults.locale||"en",c;if(xtiger.defaults.locales&&xtiger.defaults.locales[a]){c=xtiger.defaults.locales[a][d]}if(c===undefined){if((a!=="en")&&xtiger.defaults.locales&&xtiger.defaults.locales.en){c=xtiger.defaults.locales.en[d]}else{c="missing key: "+d}}return(typeof c==="function")?c(b):c};xtiger.cross.getXHRObject=function(){var b=false;if(window.XMLHttpRequest){b=new XMLHttpRequest()}else{if(window.ActiveXObject){try{b=new ActiveXObject("Msxml2.XMLHTTP")}catch(a){try{b=new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}}}}if(!b){alert("Your browser does not support XMLHTTPRequest")}return b};xtiger.cross.loadDocument=function(b,a){var f=xtiger.cross.getXHRObject(),c;try{f.open("GET",b,false);f.send(null);if((f.status==200)||(f.status==0)){if(f.responseXML){if(f.responseXML.childNodes.length===0){try{c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";c.loadXML(f.responseText)}catch(d){}return c}else{return f.responseXML}}else{if(a){a.logLocaleError("errNoXML",{url:b})}}}else{if(a){a.logLocaleError("errLoadDocumentStatus",{url:b,xhr:f})}}}catch(d){if(a){a.logLocaleError("errException",{url:b,e:d})}}return false};xtiger.cross.log=function(a,b){switch(a){case"error":case"fatal":xtiger.cross.print("[XX] "+b);break;case"warning":xtiger.cross.print("[!!] "+b);break;case"info":break;case"debug":xtiger.cross.print("[dd] "+b);break;case"stack-trace":xtiger.cross.print("[tt] "+b);break;default:}};xtiger.cross.print=function(b){try{if(typeof(opera)!="undefined"&&opera.log){opera.postError(b)}else{if(typeof(console)!="undefined"){if(/^\[!!\]/.test(b)&&console.warn){console.warn(b)}else{if(/^\[XX\]/.test(b)&&console.error){console.error(b)}else{if(console.log){console.log(b)}}}}else{if(typeof(window.console)!="undefined"&&window.console.log){window.console.log(b)}}}}catch(a){alert(b+"\nUnable to print on console ("+a.message+")")}};if(typeof DOMParser=="undefined"){xtiger.util.DOMParser=function(){};xtiger.util.DOMParser.prototype.parseFromString=function(c,e){if(typeof ActiveXObject!="undefined"){var b=new ActiveXObject("MSXML.DomDocument");b.loadXML(c);return b}else{if(typeof XMLHttpRequest!="undefined"){var a=new XMLHttpRequest;a.open("GET","data:"+(e||"application/xml")+";charset=utf-8,"+encodeURIComponent(c),false);if(a.overrideMimeType){a.overrideMimeType(e)}a.send(null);return a.responseXML}}};xtiger.cross.makeDOMParser=function(){return new xtiger.util.DOMParser()}}else{xtiger.cross.makeDOMParser=function(){return new DOMParser()}}if(!document.createTreeWalker){xtiger.util.TreeWalker=function(c,a,b){this.nodeList=new Array();this.nodeType=a;this.filter=b;this.nodeIndex=-1;this.currentNode=null;this.findNodes(c)};xtiger.util.TreeWalker.prototype={nextNode:function(){this.nodeIndex+=1;if(this.nodeIndex<this.nodeList.length){this.currentNode=this.nodeList[this.nodeIndex];return true}else{this.nodeIndex=-1;return false}},findNodes:function(b){if(b.nodeType==this.nodeType&&this.filter(b)==xtdom.NodeFilter.FILTER_ACCEPT){this.nodeList.push(b)}if(b.nodeType==1){for(var a=0;a<b.childNodes.length;a++){this.findNodes(b.childNodes[a])}}}};xtiger.cross.makeTreeWalker=function(c,b,a){return new xtiger.util.TreeWalker(c,b,a)}}else{xtiger.cross.makeTreeWalker=function(c,b,a){a.acceptNode=a;return c.ownerDocument.createTreeWalker(c,b,a,false)}}xtdom.getNodeTypeXT=function(a){var b=a.nodeName.toLowerCase();if((b=="use")||(b=="xt:use")){return xtiger.USE}else{if((b=="component")||(b=="xt:component")){return xtiger.COMPONENT}else{if((b=="repeat")||(b=="xt:repeat")){return xtiger.REPEAT}else{if((b=="bag")||(b=="xt:bag")){return xtiger.BAG}else{if((b=="attribute")||(b=="xt:attribute")){return xtiger.ATTRIBUTE}else{return xtiger.UNKNOWN}}}}}};xtdom.ELEMENT_NODE=1;xtdom.ATTRIBUTE_NODE=2;xtdom.TEXT_NODE=3;xtdom.CDATA_SECTION_NODE=4;xtdom.COMMENT_NODE=8;if((typeof NodeFilter=="undefined")||!NodeFilter){xtdom.NodeFilter={SHOW_ELEMENT:1,FILTER_ACCEPT:1,FILTER_SKIP:3}}else{xtdom.NodeFilter={SHOW_ELEMENT:NodeFilter.SHOW_ELEMENT,FILTER_ACCEPT:NodeFilter.FILTER_ACCEPT,FILTER_SKIP:NodeFilter.FILTER_SKIP}}xtdom.getWindow=function getWindow(a){if(window.document==a){return window}if(window.frames.length>0){for(var b=0;b<window.frames.length;b++){if(window.frames[b].document==a){return window.frames[b]}}}xtiger.cross.log("warning","The window object was not found.");return window};if(!xtiger.cross.UA.IE){xtdom.isXT=function isXT(b){var a=b.namespaceURI;return(a==xtiger.parser.nsXTiger)||(a==xtiger.parser.nsXTiger_deprecated)};xtdom.isUseXT=function isUseX(a){return(a.nodeName=="use"||a.nodeName=="xt:use")};xtdom.isBagXT=function(a){return(a.nodeName=="bag"||a.nodeName=="xt:bag")};xtdom.getElementsByTagNameXT=function(a,b){var c=a.getElementsByTagName(b);if(0==c.length){c=a.getElementsByTagName("xt:"+b)}return c};xtdom.getLocalName=function(a){return a.localName};xtdom.getTextContent=function(a){if(a.textContent){return a.textContent}else{if(a.text){return a.text}else{return""}}};xtdom.createElement=function(b,a){return b.createElementNS("http://www.w3.org/1999/xhtml",a)};xtdom.createElementNS=function(c,a,b){return c.createElementNS(b,a)};xtdom.importNode=function(c,b,a){return c.importNode(b,a)};xtdom.cloneNode=function(c,b,a){return b.cloneNode(a)};xtdom.setAttribute=function(b,a,c){b.setAttribute(a,c)};xtdom.getStyleAttribute=function(a){return a.getAttribute("style")};xtdom.getEventTarget=function(a){return a.target};xtdom.addEventListener=function(c,b,d,a){c.addEventListener(b,d,a)};xtdom.removeEventListener=function(c,b,d,a){c.removeEventListener(b,d,a)};xtdom.removeAllEvents=function(a){alert("removeAllEvents should not be called on this browser")};xtdom.preventDefault=function(a){a.preventDefault()};xtdom.stopPropagation=function(a){a.stopPropagation()};xtdom.focusAndSelect=function(a){try{a.focus();a.select()}catch(b){}};xtdom.focusAndMoveCaretTo=function(b,a){try{b.focus();if(b.setSelectionRange){b.setSelectionRange(a,a)}}catch(c){}}}if(xtiger.cross.UA.IE){xtdom.hasAttribute=function(b,a){return b.getAttribute(a)!=null};xtdom.isXT=function(a){return xtiger.parser.isXTigerName.test(a.nodeName)};xtdom.isUseXT=function(a){var b=a.nodeName.toUpperCase();return(b==="USE"||b==="XT:USE")};xtdom.isBagXT=function(a){var b=a.nodeName.toUpperCase();return(b==="BAG"||b==="XT:BAG")};xtdom.getElementsByTagNameXT=function(a,b){var c=a.getElementsByTagName(b);if(0==c.length){c=a.getElementsByTagName("xt:"+b)}return c};xtdom.getLocalName=function(a){return a.nodeName};xtdom.getTextContent=function(a){if(a.innerText){return a.innerText}else{if(a.text){return a.text}else{return""}}};xtdom.createElement=function(b,a){return b.createElement(a)};xtdom.createElementNS=function(c,a,b){if(b==xtiger.parser.nsXTiger){return c.createElement("xt:"+a)}else{return c.createElement(b+":"+a)}};xtdom.importNode=function(h,c,k){var a;switch(c.nodeType){case xtdom.ELEMENT_NODE:var b=c.nodeName.indexOf(":");var g=(b==-1)?c.nodeName:c.nodeName.substr(b+1);var j=xtdom.createElement(h,g);if(c.attributes&&c.attributes.length>0){for(var d=0;d<c.attributes.length;d++){xtdom.setAttribute(j,c.attributes[d].name,c.attributes[d].value)}}if(k&&c.childNodes&&c.childNodes.length>0){for(var d=0;d<c.childNodes.length;d++){a=xtdom.importNode(h,c.childNodes[d],k);if(a){try{j.appendChild(a)}catch(f){}}}}return j;break;case xtdom.TEXT_NODE:case xtdom.CDATA_SECTION_NODE:return xtdom.createTextNode(h,c.nodeValue);break;case xtdom.COMMENT_NODE:break}};xtdom.cloneNode=function(c,b,a){var d=b.cloneNode(a);xtdom.removeAllEvents(d);return d};xtdom.setAttribute=function(b,a,c){if(a=="class"){b.className=c}else{b.setAttribute(a,c)}};xtdom.getStyleAttribute=function(a){if(a.style){return a.style.cssText}else{if(a.attributes[0]&&a.attributes[0].nodeName=="style"){return a.attributes[0].nodeValue}}};xtdom.getEventTarget=function(a){return(a&&a.srcElement)?a.srcElement:window.event.srcElement};xtdom.addEventListener=function(c,b,d,a){c.attachEvent("on"+b,d);if(!c.events){c.events=new Array()}c.events.push([b,d])};xtdom.removeEventListener=function(c,b,d,a){c.detachEvent("on"+b,d)};xtdom.removeAllEvents=function(b){if(b.events){for(var a=0;a<b.events.length;a++){xtdom.removeEventListener(b,b.events[a][0],b.events[a][1],true)}b.events=new Array()}};xtdom.preventDefault=function(a){a.returnValue=false};xtdom.stopPropagation=function(a){a.cancelBubble=true};xtdom.focusAndSelect=function(a){try{a.focus();var c=a.createTextRange();c.moveStart("character",0);c.moveEnd("character",a.value.length);c.select()}catch(b){}};xtdom.focusAndMoveCaretTo=function(b,a){try{b.focus();var d=b.createTextRange();d.collapse(false);d.select()}catch(c){}}}xtiger.parser.NATIVE=0;xtiger.parser.CONSTRUCTED=1;xtiger.parser.nsXTiger="http://ns.inria.org/xtiger";xtiger.parser.nsXTiger_deprecated="http://wam.inrialpes.fr/xtiger";xtiger.parser.nsXHTML="http://www.w3.org/1999/xhtml";xtiger.parser.isXTiger=/<[^>]*[(component)(use)(repeat)(service)]/i;xtiger.parser.isXTigerName=/[(component)(use)(repeat)(service)]/i;xtiger.parser.Component=function(b,a){this.nature=b;this.tree=a;this.str=null};xtiger.parser.Component.prototype={isNative:function(){return(xtiger.parser.NATIVE==this.nature)},hasBeenExpanded:function(){return(xtiger.parser.NATIVE==this.nature)||(this.str!=null)},getSource:function(){if(!this.str){this.str=this.tree.innerHTML}return this.str},getTree:function(){return this.tree},getClone:function(b){var a=xtdom.cloneNode(b,this.tree,true);return a},importStructTo:function(a){var b=xtdom.importNode(a,this.tree,true);this.tree=b}};xtiger.parser.Iterator=function(b,a){this.transformer=a;this.unionList=new Object();this.componentLib=new Object();this.transformer.coupleWithIterator(this);this.acquireComponentStructs(b);this.acquireUnion(b);this.acquireHeadLabel(b)};xtiger.parser.Iterator.prototype={hasType:function(a){return this.componentLib[a]?true:false},defineType:function(a,b){this.componentLib[a]=b},defineUnion:function(a,b){this.unionList[a]=b},getComponentForType:function(a){return this.componentLib[a]},acquireHeadLabel:function(a){var b;var c=xtdom.getElementsByTagNameXT(a,"head");if(c&&(c.length>0)){b=c[0].getAttributeNode("label");if(!b){c=xtdom.getElementsByTagNameXT(c[0],"head");if(c&&(c.length>0)){b=c[0].getAttributeNode("label")}}}this.headLabel=b?b.value:undefined},acquireComponentStructs:function(a){var b=xtdom.getElementsByTagNameXT(a,"component");var c=new Array();for(var e=0;e<b.length;e++){var d=b[e].getAttribute("name");if(d){c.push(d);this.componentLib[d]=new xtiger.parser.Component(xtiger.parser.CONSTRUCTED,b[e])}}this.unionList.anyComponent=c},acquireUnion:function(g){var f=xtdom.getElementsByTagNameXT(g,"union");for(var b=0;b<f.length;b++){var c;var a=f[b].getAttributeNode("name").value;c=f[b].getAttributeNode("include").value.split(" ");var e=this.flattenUnionTypes(c);var d=" "+e.join(" ")+" ";c=f[b].getAttributeNode("exclude");if(c){c=i.value.split(" ");var i=this.flattenUnionTypes(c);for(var h=0;h<i.length;h++){d=d.replace(new RegExp(" "+i[h]+" ")," ")}}d=d.substring(1,d.length-1);this.unionList[a]=d.split(" ")}this.unionList.any=this.unionList.anySimple.concat(this.unionList.anyElement,this.unionList.anyComponent)},flattenUnionTypes:function(d){var b=[];for(var e=0;e<d.length;e++){if(this.unionList[d[e]]!=null){var a=this.unionList[d[e]];for(var c=0;c<a.length;c++){b.push(a[c])}}else{b.push(d[e])}}return b},importComponentStructs:function(b){xtiger.cross.log("info","imports template component structures to target document");for(var a in this.componentLib){this.componentLib[a].importStructTo(b)}},transform:function(a,b){this.curDoc=b;this.transformer.prepareForIteration(this,b,this.headLabel);this.transformIter(a);this.transformer.finishTransformation(a)},transformIter:function(a){if(a.nodeType==xtdom.ELEMENT_NODE){var b=xtdom.getNodeTypeXT(a);if(xtiger.COMPONENT==b){this.changeComponent(a)}else{this.transformer.saveContext(a);switch(b){case xtiger.USE:this.changeUse(a);break;case xtiger.REPEAT:this.changeRepeat(a);break;case xtiger.ATTRIBUTE:this.changeAttribute(a);break;case xtiger.BAG:this.changeBag(a);break;default:this.continueWithChildOf(a)}this.transformer.restoreContext(a)}}},continueWithChildOf:function(a){var c=new Array();for(var b=0;b<a.childNodes.length;b++){if(xtdom.containsXT(a.childNodes[b])){c.push(a.childNodes[b])}}this.transformItems(c)},transformItems:function(a){if(a.length==0){return}var c;if(a[0]=="OPAQUE"){a.shift();var b=this.transformer.popContext();while(c=a.shift()){this.transformer.saveContext(c,true);this.transformIter(this.transformer.getNodeFromOpaqueContext(c));this.transformer.restoreContext(c,true)}this.transformer.pushContext(b)}else{while(c=a.shift()){this.transformIter(c)}}},changeComponent:function(b){var c=[];var a=xtdom.createElement(this.curDoc,"div");this.transformer.genComponentBody(b,a);this.transformer.genComponentContent(b,a,c);this.transformItems(c);this.transformer.finishComponentGeneration(b,a);xtdom.replaceNodeByChildOf(b,a)},changeRepeat:function(b){var c=[];var a=xtdom.createElement(this.curDoc,"div");this.transformer.genRepeatBody(b,a,c);this.transformer.genRepeatContent(b,a,c);this.transformItems(c);this.transformer.finishRepeatGeneration(b,a);xtdom.replaceNodeByChildOf(b,a)},changeUse:function(b){var e=[];var a=xtdom.createElement(this.curDoc,"div");var d="use";var c=b.getAttribute("types").split(" ");c=this.flattenUnionTypes(c);this.transformer.genIteratedTypeBody(d,b,a,c);this.transformer.genIteratedTypeContent(d,b,a,e,c);this.transformItems(e);this.transformer.finishIteratedTypeGeneration(d,b,a,c);xtdom.replaceNodeByChildOf(b,a)},changeAttribute:function(b){var e=null;var a=xtdom.createElement(this.curDoc,"div");var d="attribute";var c=[b.getAttribute("types")||b.getAttribute("type")];this.transformer.genIteratedTypeBody(d,b,a,c);this.transformer.genIteratedTypeContent(d,b,a,e,c);this.transformer.finishIteratedTypeGeneration(d,b,a,c);xtdom.replaceNodeByChildOf(b,a)},changeBag:function(c){var b=xtdom.createElement(this.curDoc,"span");xtdom.addClassName(b,"axel-generator-error");var a=xtdom.createTextNode(this.curDoc,"! unsupported Bag element !");b.appendChild(a);c.parentNode.insertBefore(b,c,true);c.parentNode.removeChild(c)}};xtiger.util.Logger=function(){this.errors=[]};xtiger.util.Logger.prototype={inError:function(){return(this.errors.length>0)},logError:function(b,a){if(b.indexOf("$$$")!=-1){this.errors.push(b.replace("$$$",'"'+a+'"'))}else{this.errors.push(b)}},logLocaleError:function(b,a){this.errors.push(xtiger.util.getLocaleString(b,a))},printErrors:function(){return this.errors.join(";")}};xtiger.util.Form=function(a){this.baseUrl=a;this.doTab=false;this.loader=this.serializer=null};xtiger.util.Form.prototype={_report:function(a,d,c,b){this.status=a;if(0===this.status){this.msg=xtiger.util.getLocaleString(d,b);if(c){c.logError(this.msg)}else{xtiger.cross.log("error",this.msg)}}else{this.msg=d}},setLoader:function(a){this.loader=a},setSerializer:function(a){this.serializer=a},enableTabGroupNavigation:function(){this.doTab=true},setTemplateSource:function(b,c){this.srcDoc=b;this.srcForm=null;if(b){var a=b.getElementsByTagName("body");if(a&&(a.length>0)){this.srcForm=a[0]}else{try{b.setProperty("SelectionNamespaces","xmlns:xhtml='http://www.w3.org/1999/xhtml'");this.srcForm=b.selectSingleNode("//xhtml:body")}catch(d){}}if(!this.srcForm){this._report(0,"errTemplateNoBody",c)}this.curDoc=b;this.targetContainerId=false}else{this._report(0,"errTemplateUndef",c)}this._report(1,"template source set",c);return(this.status===1)},setTargetDocument:function(c,b,a){this.curDoc=c;this.targetContainerId=b;this.doEmptyTarget=a},setTarget:function(b,a){this.curDoc=b.ownerDocument;this.targetContainer=b;this.doEmptyTarget=a||true},transform:function(a){var e;if(!this.srcForm){this._report(0,"errNoTemplate",a);return false}this.editor=new xtiger.editor.Generator(this.baseUrl);e=new xtiger.parser.Iterator(this.srcDoc,this.editor);if(this.targetContainer||this.targetContainerId){var d=this.targetContainer||this.curDoc.getElementById(this.targetContainerId);if(d){if(this.doEmptyTarget){xtdom.removeChildrenOf(d)}xtdom.importChildOfInto(this.curDoc,this.srcForm,d);this.root=d}else{this._report(0,"errTransformNoTarget",a,{id:this.targetContainerId});return false}e.importComponentStructs(this.curDoc)}else{this.root=this.srcForm}var c=xtiger.session(this.curDoc).load("keyboard");if(!c){c=new xtiger.editor.Keyboard();xtiger.session(this.curDoc).save("keyboard",c);if(this.doTab){var b=new xtiger.editor.TabGroupManager(this.root);c.setTabGroupManager(b);xtiger.session(this.curDoc).save("tabgroupmgr",b)}}xtiger.session(this.curDoc).save("form",this);e.transform(this.root,this.curDoc);this._report(1,"document transformed",a);return(this.status==1)},getEditor:function(){return this.editor},getRoot:function(){return this.root},injectStyleSheet:function(b,a){var c=this.curDoc?this.curDoc.getElementsByTagName("head")[0]:null;if(c){var d=this.curDoc.createElement("link");d.setAttribute("rel","stylesheet");d.setAttribute("type","text/css");d.setAttribute("href",b);c.appendChild(d);this._report(1,"stylesheet injected",a)}else{this._report(0,"errTargetNoHead",a)}return(this.status==1)},loadData:function(b,a){if(b.hasData()){this.editor.loadData(this.root,b,this.loader);this._report(1,"data loaded",a)}else{this._report(0,"errNoData",a)}return(this.status==1)},loadDataFromString:function(c,a){var b=new xtiger.util.DOMDataSource(c);this.loadData(b,a);return(this.status==1)},serializeData:function(a){this.editor.serializeData(this.root,a,this.serializer)}};(function(m){var c={};var b=10000;var d;function f(q){return q.contentDocument||(q.contentWindow?q.contentWindow.document:q)}function l(s,q,r){if("undefined"!==typeof window.jQuery){$(s).triggerHandler(q,r);$(s.ownerDocument).triggerHandler(q,r.first)}}function o(r,q){if(typeof q==="function"){q(r)}else{if((typeof q==="object")&&q.error){q.error(r)}else{if(typeof c.error==="function"){c.error(r)}else{alert(r)}}}}function e(s,r,q){if(s.xttPrimitiveEditor){r.push(s.xttPrimitiveEditor)}if(s.firstChild){n(s.firstChild,s.lastChild,r,q)}}function g(s,r,q){if(++d>b){xtiger.cross.log("error","reached iteration limit ("+b+")");return}if(s.xttHeadLabel){xtiger.cross.log("debug","wrapped set stopped on internal editor boundary of "+s.xttHeadLabel);return}if(s.xttPrimitiveEditor){r.push(s.xttPrimitiveEditor)}if(s.firstChild){n(s.firstChild,s.lastChild,r,q)}}function n(s,q,x,w,r){var v=s,u=true,y;if(d++>b){xtiger.cross.log("error","reached iteration limit ("+b+")");return}while(v&&u){if(v.startRepeatedItem&&!w){if(v.startRepeatedItem.getSize()===0){v=v.startRepeatedItem.getLastNodeForSlice(0);v=v.nextSibling;continue}}if(v.beginChoiceItem&&(v.beginChoiceItem!=r)){y=v.beginChoiceItem;if(y.items[y.curItem][0]!==y.items[y.curItem][1]){n(y.items[y.curItem][0],y.items[y.curItem][1],x,w,y)}else{g(y.items[y.curItem][0],x,w)}v=y.items[y.items.length-1][1]}else{g(v,x,w)}if(v===q){u=false}v=v.nextSibling}}function i(){this.stack=[]}i.prototype={discardNodeIfEmpty:function(){},write:function(q){this.stack.push(q)},dump:function(){return this.stack.join(" ")},openTag:function(q){},closeTag:function(q){},reset:function(){this.stack=[]}};function p(q,r){this.seethrough=r;this.targets=q;this.first=q[0]}p.prototype={_list:function(){var r,q;d=0;if(this.targets){this.list=[];if(this.first&&this.first.nodeName.toLowerCase()==="iframe"){this.targets=[f(this.first)]}for(r=0;r<this.targets.length;r++){if((r===0)&&this.first&&this.first.xttHeadLabel){e(this.targets[r],this.list,this.seethrough)}else{g(this.targets[r],this.list,this.seethrough)}}delete this.targets}return this.list},transform:function(A){var r,w,x,q,z,u=false,s={},v=false;if(typeof A==="object"){if(A.doctype){x=A}else{s=A}}if(arguments.length>1){s=arguments[1]}q=s.bundlesPath||c.bundlesPath;z=(s.enableTabGroupNavigation===true)||c.enableTabGroupNavigation;if(q){if(this.first){this.first.xttHeadLabel=undefined;w=new xtiger.util.Logger();try{if(this.first.nodeName.toLowerCase()==="iframe"){x=f(this.first);if(!x){w.logLocaleError("errTransformIframeSecurity")}u=true}else{if(x===undefined){x=typeof A==="string"?new xtiger.cross.loadDocument(A,w):this.first.ownerDocument}}if(x&&!w.inError()){r=new xtiger.util.Form(q);if(x!==this.first.ownerDocument){r.setTemplateSource(x);if(!u){r.setTarget(this.first,true)}}else{r.srcDoc=this.first.ownerDocument;r.curDoc=this.first.ownerDocument;r.srcForm=this.first}if(z){r.enableTabGroupNavigation()}r.transform(w);xtiger.session(this.first.ownerDocument).save("form",this);if(s.injectStylesheet){r.injectStyleSheet(s.injectStylesheet)}}if(w.inError()){o(w.printErrors(),s)}else{if(r){this.first.xttHeadLabel=r.getEditor().headLabel;v=true}else{o(xtiger.util.getLocaleString("errTransformUnknown"),s)}}}catch(y){o(xtiger.util.getLocaleString("errException",{e:y}),s)}}else{o(xtiger.util.getLocaleString("errEmptySet4Template"),s)}}else{o(xtiger.util.getLocaleString("errNoBundlesPath"),s)}if(v){l(this.first,"axel-editor-ready",this)}else{l(this.first,"axel-transform-error",this)}return this},xml:function(r){var v,u,s="",q=r||{};if(this.first){u=q.logger||new xtiger.util.DOMLogger();v=q.serializer||c.serializer||xtiger.editor.Generator.prototype.defaultSerializer;if(v){v.serializeData((this.first.nodeName.toLowerCase()==="iframe")?f(this.first):this.first,u,this.first.xttHeadLabel);s=u.dump()}else{o(xtiger.util.getLocaleString("errNoSerializer"),q)}}return s},load:function(v){var w,u,q,r,s={};if(arguments.length>1){s=arguments[1]}if(this.first){w=s.loader||c.loader||xtiger.editor.Generator.prototype.defaultLoader;q=new xtiger.util.Logger();if(w){if(typeof v==="string"){if(v.replace(/^\s*/,"").charAt(0)!=="<"){v=xtiger.cross.loadDocument(v,q)}}else{if(!v){q.logLocaleError("errDataSourceUndef")}}if(v&&!q.inError()){u=new xtiger.util.DOMDataSource(v);w.loadData((this.first.nodeName.toLowerCase()==="iframe")?f(this.first):this.first,u);l(this.first,"axel-content-ready",this)}else{o(q.printErrors(),s)}}else{o(xtiger.util.getLocaleString("errNoLoader"),s)}}else{o(xtiger.util.getLocaleString("errEmptySet4XML"),s)}return this},transformed:function(){return this.first&&(typeof this.first.xttHeadLabel==="string")},length:function(){return this._list().length},get:function(q){return this._list()[q]},clear:function(q){var r,s=this._list();for(r=0;r<s.length;r++){s[r].clear(q)}return this},update:function(s){var q,r=this._list();for(q=0;q<r.length;q++){r[q].update(s)}return this},text:function(){var r,s=this._list(),q=new i();for(r=0;r<s.length;r++){s[r].save(q)}return q.dump()},values:function(){var s,u=this._list(),q=new i(),r=[];for(s=0;s<u.length;s++){u[s].save(q);r.push(q.dump());q.reset()}return r},configure:function(r,u){var q,s=this._list();for(q=0;q<s.length;q++){s[q].configure(r,u)}return this},apply:function(s,q){var r,u=this._list();for(r=0;r<u.length;r++){s(q?u[r].getHandle():u[r])}return this},peek:function(s,x){var r=new i(),w=this._list(),v,u,q;for(v=0;v<w.length;v++){if(w[v].getHandle().xttOpenLabel===s){w[v].save(r);u=r.dump();if((u!="")&&!isNaN(u)){u=parseFloat(u)}else{u=x?x:0}return u}}},poke:function(q,v){var u=this._list(),r,s;for(r=0;r<u.length;r++){if(u[r].getHandle().xttOpenLabel===q){if(typeof v==="object"){for(var w in v){if(v.hasOwnProperty(w)){if("#val"===w){u[r].update(v[w]+"")}else{s=u[r].getHandle();if(s.style){s.style[w]=v[w]}}}}}else{u[r].update(v+"")}break}}return this},flush:function(){this._vector.pop();return this},vector:function(r,v){var u,s,q=new i();if(v&&$.isFunction(v)){s=v}else{u=v?v:0;s=function(w){var y=parseFloat(w);return isNaN(y)?u:y}}if(!this._vector){this._vector=new Array()}this._vector.push($.map(this._list(),function(y,x){var w;if(y.getHandle().xttOpenLabel===r){y.save(q);w=q.dump();q.reset();return s(w)}}));return this},product:function(u){var s,v,w,r,q=0;v=this._vector?this._vector.length:0;if(v>0){if(u){w=this._vector[v-1];v=w.length;for(s=0;s<v;s++){w[s]*=u}q=this}else{if(v>1){w=this._vector[v-2];r=this._vector.pop();v=w.length;for(s=0;s<v;s++){q=r[s];if(q){w[s]*=q}}q=this}else{if(this._vector[0].length>0){q=this._vector[0].reduce(function(x,y){return x*y})}}}}return q},sum:function(){var s,u,v,r,q=0;u=this._vector?this._vector.length:0;if(u>0){if(u>1){v=this._vector[u-2];r=this._vector.pop();u=v.length;for(s=0;s<u;s++){q=r[s];if(q){v[s]+=q}}q=this}else{if(this._vector[0].length>0){q=this._vector[0].reduce(function(w,x){return w+x})}}}return q},identity:function(s){var r=this._vector?this._vector.length:0,q=s||0;if(r>0){q=(q>0)?q:r-1+q;return this._vector[q]}else{return 0}}};var k=function j(q,u,s){var r;if(typeof q==="string"){if(m.jQuery){r=$(q,s||document).get()}else{xtiger.cross.log("warning",'jQuery missing to interpet wrapped set selector "'+q+'"');r=[]}}else{if(Object.prototype.toString.call(q)==="[object Array]"){r=q}else{if(m.jQuery&&(q instanceof m.jQuery)){r=q.get()}else{if(q){r=[q]}else{xtiger.cross.log("warning","empty wrapped set selector");r=[]}}}}return new p(r,u)};k.extend=function h(v,u,r,s){if(r){for(var q in u){if(u.hasOwnProperty(q)){if(s||(typeof v.prototype[q]==="undefined")){v.prototype[q]=u[q]}}}}else{for(var q in u){if(u.hasOwnProperty(q)){if(s||(typeof v[q]==="undefined")){v[q]=u[q]}}}}};k.setup=function a(q){k.extend(c,q)};k.error=o;k.defaults=c;k.setIterationLimit=function(q){b=q};m.$axel=k}(window));xtiger.editor.Plugin=function(){};xtiger.editor.Plugin.prototype={pluginEditors:{},getEditorFor:function(d,b){var a,c;if(b.length===1){c=b[0];a=this.pluginEditors[c]}return a},hasEditorFor:function(d,a){var b,c;if(this.pluginEditors[a]){b=true}else{var c=a;b=(this.pluginEditors[c]!==undefined)}return b}};(function(a){var c=0;function g(i){return i+(c++)}var f={load:function(j,i){this.onLoad(j,i)},save:function(i){this.onSave(i)},_init:function(j,i,k){this._document=i;this._key=k;this._handle=j;this._isModified=false},_parseFromTemplate:function(i){var j;this._param={};xtiger.util.decodeParameters(i.getAttribute("param"),this._param);this._content=xtdom.extractDefaultContentXT(i);j=i.getAttribute("option");this._option=j?j.toLowerCase():null},_parseFromSeed:function(i){this._param={};a.extend(this._param,i[1],false,true);this._content=i[2];this._option=i[3]},makeSeed:function(){if(!this._seed){this._seed=[this._getKFactory(),this._param,this._content,this._option]}return this._seed},getParam:function(i){return this._param[i]||this._getKParam(i)},getDefaultData:function(){return this._content},getOption:function(){return this._option},configure:function(i,j){if(j===undefined){delete this._param[i]}else{this._param[i]=j}},getUniqueKey:function(){return this._key},getDocument:function(){return this._document},getHandle:function(){return this._handle},setModified:function(i){this._isModified=i},isModified:function(){return this._isModified},isOptional:function(){return false},isFocusable:function(){return false},focus:function(){},unfocus:function(){}};var e={_onInitOption:function(){var i=this.getOption();if(i){this._isOptional=true;this._optCheckBox=this._handle.previousSibling;if(i==="unset"){this._isOptionSet=true}(i==="set")?this.set(false):this.unset(false)}else{this._isOptional=false}},_onAwakeOption:function(){var i=this;if(this.isOptional()){xtdom.addEventListener(this._optCheckBox,"click",function(j){i.onToggleOpt(j)},true)}},isOptional:function(){return this._isOptional},isSet:function(){return this._isOptional&&this._isOptionSet},set:function(i){if(i){if(!this.getParam("noedit")){xtiger.editor.Repeat.autoSelectRepeatIter(this.getHandle(true))}xtdom.removeClassName(this.getHandle(),"axel-repeat-unset")}if(!this._isOptionSet){this._isOptionSet=true;if(this._isOptional){xtdom.removeClassName(this.getHandle(),"axel-option-unset");xtdom.addClassName(this.getHandle(),"axel-option-set");this._optCheckBox.checked=true}}},unset:function(i){if(this._isOptionSet){this._isOptionSet=false;if(this._isOptional){xtdom.removeClassName(this._handle,"axel-option-set");xtdom.addClassName(this._handle,"axel-option-unset");this._optCheckBox.checked=false}}},onToggleOpt:function(i){this._isOptionSet?this.unset(true):this.set(true)}};function b(k,j,l,i){this.type=k;this.spec=j;this.defaults=l;this.klassdefs=i;this.klass=null;this.fklass={}}b.prototype={filterRe:/filter=\s*([\w\s]*);?/,createEditor:function d(i,n,o,w){var s,u,r,p,l,v,k=w.getAttribute("param");if(this.spec.filterable&&k){l=this.filterRe.exec(k);if(l){p=l[1]}}v=this.getKlass(p);r=new v();r._parseFromTemplate(w);s=r.onGenerate(i,n,o);s.xttPrimitiveEditor=r;if(this.spec.optional){var q=n.getAttribute("option");if(q){var j=xtdom.createElement(o,"input");xtdom.setAttribute(j,"type","checkbox");xtdom.addClassName(j,"axel-option-checkbox");i.insertBefore(j,s)}}r._init(s,o,g(this.type));r.onInit(r.getDefaultData(),r.getOption());r.onAwake();if(this.spec.optional){r._onInitOption();r._onAwakeOption()}},createEditorFromSeed:function h(n,o,j,k){var m,l,i;m=this.spec.filterable?n[1]["filter"]:undefined;i=this.getKlass(m);l=new i();l._parseFromSeed(n);l._init(o,j,g(this.type));l.onInit(l.getDefaultData(),l.getOption(),k);l.onAwake();if(this.spec.optional){l._onInitOption();l._onAwakeOption()}return l},getKlass:function(i){if(i){if(!this.fklass[i]){this.createPluginKlass(i)}return this.fklass[i]}else{if(!this.klass){this.createPluginKlass(i)}return this.klass}},createPluginKlass:function(k){var j,i=new Function();if(this.spec.filterable&&k){j={};a.extend(j,this.defaults);this.applyFiltersDefaults(j,k)}else{j=this.defaults}i.prototype=(function(o,l){var n=l,m=o;return{_getKFactory:function(){return n},_getKParam:function(p){return m[p]}}}(j,this));a.extend(i.prototype,f);if(this.spec.optional){a.extend(i.prototype,e,false,true)}i.prototype.onGenerate=this.klassdefs.onGenerate||function(n,m,l){alert("plugin "+m.getAttribute("types")+" missing onGenerate function !")};i.prototype.onInit=this.klassdefs.onInit;i.prototype.onAwake=this.klassdefs.onAwake;i.prototype.onLoad=this.klassdefs.onLoad;i.prototype.onSave=this.klassdefs.onSave;a.extend(i.prototype,this.klassdefs.api,false,true);a.extend(i.prototype,this.klassdefs.methods);if(this.spec.filterable&&k){this.applyFilters(i.prototype,k)}if(k){this.fklass[k]=i}else{this.klass=i}}};a.plugin=a.plugin||{};a.plugin.register=function(k,j,m,i){var l;if(xtiger.editor.Plugin.prototype.pluginEditors[k]){xtiger.cross.log("error",'plugin "'+k+'" has already been registered, registration aborted')}else{xtiger.cross.log("info",'registering plugin "'+k+'"');factoklass=new b(k,j,m,i);if(j.filterable){xtiger.editor.Plugin.prototype.pluginEditors[k]=xtiger.util.filterable(k,factoklass)}else{xtiger.editor.Plugin.prototype.pluginEditors[k]=factoklass}}};a.plugin.list=function(){var i,j=[];for(i in xtiger.editor.Plugin.prototype.pluginEditors){j.push(i)}return j}}($axel));(function(a){var b={};function f(i,k){if(!k){xtiger.cross.log("error",'filter "'+i+'" is undefined');return k}var h={},j=i;k.registerFilter=function l(n,m){if(typeof(m)==="object"){if(h[n]){xtiger.cross.log("warning",'"'+j+'" plugin: filter "'+n+'" is already registered. Overwriting it.')}h[n]=m}};k.applyFiltersDefaults=function g(o,m){var n=m.split(" ");for(_i=0;_i<n.length;_i++){var p=h[n[_i]];if(!p){xtiger.cross.log("warning",'"'+j+'" plugin: missing filter "'+n[_i]+'"');continue}a.extend(o,p.defaults,false,true)}};k.applyFilters=function g(r,o){var p=o.split(" "),n,s,m,q;for(s=0;s<p.length;s++){var u=h[p[s]];if(!u){xtiger.cross.log("warning",'"'+j+'" plugin: missing filter "'+p[s]+'"');continue}if(u){n=u.spec.chain;if(n){if(typeof n==="string"){n=[n]}for(m=0;m<n.length;m++){q="__"+p[s]+"__"+n[m];r[q]=r[n[m]]||function(){}}}if(u.mixin.onGenerate){r.onGenerate=u.mixin.onGenerate}if(u.mixin.onInit){r.onInit=u.mixin.onInit}if(u.mixin.onAwake){r.onAwake=u.mixin.onAwake}if(u.mixin.onLoad){r.onLoad=u.mixin.onLoad}if(u.mixin.onSave){r.onSave=u.mixin.onSave}a.extend(r,u.mixin.api,false,true);a.extend(r,u.mixin.methods,false,true)}}};return k}function e(i,h,j,g){if(b[i]){xtiger.cross.log("error",'attempt to register filter "'+i+'" more than once')}else{b[i]={spec:h,defaults:j,mixin:g}}}function d(){var g,h=[];for(g in b){h.push(g)}return h}function c(h){var i,j,g,k;for(i in h){j=b[i];g=h[i];g=(typeof g==="string")?[g]:g;if(j){while(g.length>0){k=g.shift();if(xtiger.editor.Plugin.prototype.pluginEditors[k]){xtiger.editor.Plugin.prototype.pluginEditors[k].registerFilter(i,j)}else{xtiger.cross.log("error",'attempt to register filter "'+i+'" on unkown plugin "'+k+'"')}}}else{xtiger.cross.log("error",'attempt to register unkown filter "'+i+'" on plugin(s) "'+g.join(",")+'"')}}}xtiger.util.filterable=f;a.filter=a.filter||{};a.filter.register=e;a.filter.applyTo=c;a.filter.list=d}($axel));(function(a){xtiger.defaults.locales={};_setLocale=function(b){xtiger.defaults.locale=b};_addLocale=function(c,b){if(typeof xtiger.defaults.locales[c]==="undefined"){xtiger.defaults.locales[c]={}}$axel.extend(xtiger.defaults.locales[c],b,false,true)};a.$axel.addLocale=_addLocale;a.$axel.setLocale=_setLocale}(window));xtiger.editor.Generator=function(a){if(a){xtiger.resources.setBase(a)}this.plugins=new xtiger.editor.Plugin()};xtiger.editor.LABEL_MARK=0;xtiger.editor.REPEAT_MARK=1;xtiger.editor.CHOICE_MARK=2;xtiger.editor.Generator.prototype={markerNames:["xttOpenLabel","xttCloseLabel","startRepeatedItem","endRepeatedItem","beginChoiceItem","endChoiceItem"],isBoundarySafe:function(b){if(!b){alert("Empty node in transformation, the template may contain XHTML errors, please correct it !");return false}if(xtiger.cross.UA.unsafeExpando&&(b.nodeType!=xtdom.ELEMENT_NODE)){return false}for(var a=0;a<this.markerNames.length;a++){if(b[this.markerNames[a]]){return false}}if((b.nodeType==xtdom.ELEMENT_NODE)&&(b.nodeName.search("menu-marker")!=-1)){return false}return true},verifyBoundaries:function(b,d){var c;if(!this.isBoundarySafe(b.firstChild)){c=xtdom.createElement(this.curDoc,"span");xtdom.addClassName(c,"axel-core-boundary")}if(!this.isBoundarySafe(b.lastChild)){var a=xtdom.createElement(this.curDoc,"span");xtdom.addClassName(a,"axel-core-boundary");b.appendChild(a)}if(c){b.insertBefore(c,b.firstChild)}},getNodeFromOpaqueContext:function(a){xtiger.cross.log("warning",'unexpected call to "getNodeFromOpaqueContext" in "generator.js"');return a},saveContext:function(a,b){if(xtdom.isUseXT(a)||xtdom.isBagXT(a)){this.context.push(a)}},restoreContext:function(a){if(xtdom.isUseXT(a)||xtdom.isBagXT(a)){this.context.pop()}},pushContext:function(a){this.context.push(a)},popContext:function(){return this.context.pop()},savePendingEditor:function(a,c){var b=this.popContext();this.pushContext([b,[a,c]])},getPendingEditor:function(){if(this.context.length>0){var a=this.context[this.context.length-1];if(a instanceof Array){return a[1]}}return false},peekTopContext:function(){var a=this.context[this.context.length-1];return(a instanceof Array?a[0]:a)},coupleWithIterator:function(b){this.iterator=b;var a=new Array("string","number","boolean");b.defineUnion("anySimple",a)},prepareForIteration:function(b,c,a){this.context=[];this.curDoc=c;this.headLabel=a;if(!c){alert("You must specify a document to prepareForIteration !")}},genComponentBody:function(b,a){},genComponentContent:function(b,a,c){xtdom.moveChildOfInto(b,a,c)},finishComponentGeneration:function(j,b){var c=this.getPendingEditor();if(c){var g=c[0];this.verifyBoundaries(b,xtiger.editor.CHOICE_MARK);var a=j.getAttribute("name");g.addChoiceItem(a,b.firstChild,b.lastChild);var l=j.getAttribute("i18n");if(l){var d=c[1];var m=d.getElementsByTagName("option");for(var e=0;e<m.length;e++){var k=m.item(e).firstChild;if(k.data==a){k.data=l;break}}}}if(b.querySelector){var h=b.querySelector("select[class]");if(h){var f=h.getAttribute("class");menuMarker=xtdom.getMenuMarkerXT(b,f);if(menuMarker){menuMarker.parentNode.replaceChild(h,menuMarker)}}}},genRepeatBody:function(b,a){},genRepeatContent:function(b,a,c){xtdom.moveChildOfInto(b,a,c)},finishRepeatGeneration:function(b,a){this.verifyBoundaries(a,xtiger.editor.REPEAT_MARK);var c=new xtiger.editor.Repeat();c.initFromTree(a,b,this.curDoc)},genIteratedTypeBody:function(e,p,a,j){var d,q,n;if(j.length>1){var v=d=xtdom.createElement(this.curDoc,"select");for(var g=0;g<j.length;g++){var b=xtdom.createElement(this.curDoc,"option");var u=xtdom.createTextNode(this.curDoc,j[g]);b.appendChild(u);v.appendChild(b)}var h=p.getAttribute("param");if(h){var g=h.indexOf("=");if(g!=-1){q=h.substr(0,g);n=h.substr(g+1)}}if((q=="name")&&n){xtdom.addClassName(d,n)}else{if((q="marker")&&n){var m=xtdom.createElement(this.curDoc,"span");xtdom.addClassName(m,n);var f=xtdom.createElementNS(this.curDoc,"menu-marker",xtiger.parser.nsXTiger);m.appendChild(f);var r=xtdom.createElement(this.curDoc,"br");m.appendChild(r);m.appendChild(d);d=m}}a.appendChild(d);var k=new xtiger.editor.Choice();var l=xtdom.getTagNameXT(p);if(l&&(l.indexOf(" ")!=-1)){k.initFromTree(v,l.split(" "),this.curDoc)}else{k.initFromTree(v,j,this.curDoc)}this.savePendingEditor(k,v);k.awake(v);xtiger.cross.log("plant","Created a Choice editor for types /"+j+"/")}},genIteratedTypeContent:function(c,m,b,j,g){var f,a;if(f=this.plugins.getEditorFor(m,g)){a=("attribute"===c)?m:this.peekTopContext();f.createEditor(b,m,this.curDoc,a)}else{for(var e=0;e<g.length;e++){var k=this.iterator.getComponentForType(g[e]);if(k){var h=k.getClone(this.curDoc);b.appendChild(h);j.push(h)}else{var l=xtdom.createElement(this.curDoc,"span");xtdom.addClassName(l,"axel-generator-error");var d=xtdom.createTextNode(this.curDoc,'ERROR: "'+g[e]+'" is undeclared or is terminal and part of a choice');l.appendChild(d);b.appendChild(l)}}}},finishIteratedTypeGeneration:function(e,d,a,c){var b=xtdom.getTagNameXT(d);if(!b){return}if(b.indexOf(" ")!=-1){return}if("attribute"===e){b="@"+b}if(!a.firstChild){xtiger.cross.log("warning",'XTiger component (label="'+b+'") definition is empty');return}this.verifyBoundaries(a,xtiger.editor.USE_MARK);xtiger.cross.log("plant","Planting use Start & End labels for "+b);if(a.firstChild.xttOpenLabel){xtiger.cross.log("warning",'use "'+b+'" and use "'+a.firstChild.xttOpenLabel+'" with same START !')}a.firstChild.xttOpenLabel=b;if(a.lastChild.xttCloseLabel){xtiger.cross.log("warning",'use "'+b+'" and use "'+a.lastChild.xttCloseLabel+'" with same END !')}a.lastChild.xttCloseLabel=b},finishTransformation:function(b){var a=xtiger.cross.makeTreeWalker(b,xtdom.NodeFilter.SHOW_ELEMENT,function(c){return(c.markChoiceEditor)?xtdom.NodeFilter.FILTER_ACCEPT:xtdom.NodeFilter.FILTER_SKIP});while(a.nextNode()){if(a.currentNode.markChoiceEditor){a.currentNode.markChoiceEditor.initializeSelectedItem(0)}}},loadData:function(c,d,a){var b=a||this.defaultLoader;if(b){b.loadData(c,d)}else{alert("Default XML loader missing !")}},serializeData:function(a,b,d){var c=d?d:this.defaultSerializer;if(c){c.serializeData(a,b,this.headLabel)}else{alert("Default XML serializer missing !")}}};xtiger.editor.Repeat=function(){this.items=[];this.curDoc=null;this.tickCount=0};xtiger.editor.Repeat.autoSelectRepeatIter=function(c){var b;var d=c;var a=0;var e=0;while(d){if(d.startRepeatedItem){a++}if((d!=c)&&d.endRepeatedItem){e++}if(a>e){b=d.startRepeatedItem;if((0==b.min)&&(0==b.total)){b.unsetOption()}d=b.getFirstNodeForSlice(0);a=e=0}d=d.previousSibling}if(c.parentNode){xtiger.editor.Repeat.autoSelectRepeatIter(c.parentNode)}};xtiger.editor.Repeat.prototype={trash:[],hasLabel:function(){return(this.label!="repeat")},getRepeatableLabel:function(){return this.pseudoLabel},dump:function(){return this.label},getSize:function(){return this.total},getClockCount:function(){return this.tickCount},getLastNodeForSlice:function(a){var b=(a<this.items.length)?a:this.items.length-1;return this.items[b][1]},getFirstNodeForSlice:function(b,a){var c;if(b<this.items.length){c=b}else{if(a&&(b==this.items.length)){this.appendSlice()}c=this.items.length-1}return this.items[c][0]},getSliceIndexForStartMarker:function(b){for(var a=0;a<this.items.length;a++){if(this.items[a][0]==b){return a}}return -1},makeSeed:function(b,d){if(this==b){xtiger.cross.log("clone-trace","*repeater* do not replicate top/master repeater",this.seed[3])}else{if(this.seed){if(this.seed[0]==-2){var a=d[this.seed[3]];if(!a){var c=xtdom.genId();xtiger.cross.log("clone-trace","*repeater* remaps a non top/master repeater",c);a=[-1,this.seed[1],this.seed[2],c,this.min,this.max,this.pseudoLabel];d[this.seed[3]]=a}return a}else{xtiger.cross.log("debug","*repeater* [should not happen] seed "+this.seed[3]+" already mapped as "+this.seed[0])}}else{var c=xtdom.genId();xtiger.cross.log("debug","*repeater*  [should not happen] making a entirely repeater seed",c);this.seed=[-1,b.label,b.model,c,this.min,this.max,this.pseudoLabel]}}return this.seed},initFromSeed:function(b,a){this.curDoc=a;this.label=b[1];this.model=b[2];this.min=b[4];this.max=b[5];this.pseudoLabel=b[6];this.total=(this.min>0)?1:0;this.items=[[null,null,null,null]]},setStartItem:function(a){this.items[0][0]=a},setEndItem:function(a){this.items[0][1]=a},setMarkItem:function(a){if(this.items[0][2]){this.items[0][3]=a}else{this.items[0][2]=a}var b=this;xtdom.addEventListener(a,"click",function(c){b.handleRepeat(c)},true);xtiger.cross.log("iter-trace","setMarkItem for repeater "+this.dump()+" on node "+a.tagName)},configureMenuForSlice:function(b){if(b>=this.items.length){xtiger.cross.log("error","Wrong menu configuration in repeater "+this.dump());return}var c=this.items[b][2];var d=this.items[b][3];var e=xtiger.bundles.repeat.checkedIconURL;if(0==this.min){if(0==this.total){e=xtiger.bundles.repeat.uncheckedIconURL}else{if(1==this.total){e=xtiger.bundles.repeat.checkedIconURL}else{e=xtiger.bundles.repeat.minusIconURL}}}else{if(this.total==this.min){e=xtiger.bundles.repeat.plusIconURL}else{e=xtiger.bundles.repeat.minusIconURL}}xtdom.setAttribute(c,"src",e);xtdom.setAttribute(d,"src",xtiger.bundles.repeat.plusIconURL);var a=false;if(0==this.min){if(((this.max>1)||(-1==this.max))&&(this.total>0)){a=true}}else{if((this.total>1)&&((this.max>1)||(-1==this.max))){a=true}}if(a){xtdom.removeClassName(d,"axel-core-off")}else{xtdom.addClassName(d,"axel-core-off")}},initFromTree:function(b,g,i){this.curDoc=i;this.label=g.getAttribute("label")||"repeat";this.pseudoLabel=g.getAttribute("pseudoLabel")||"repeat";var d=g.getAttribute("minOccurs")||0;this.min=isNaN(d)?1:parseInt(d);d=g.getAttribute("maxOccurs")||-1;this.max=isNaN(d)?-1:parseInt(d);this.total=(this.min>0)?1:0;xtiger.cross.log("plant","Create Repeat Editor "+this.min+"/"+this.max+"/"+this.label);var f=xtdom.createElement(this.curDoc,"img");var c="16";var e;if(e=xtdom.getMenuMarkerXT(b)){e.parentNode.replaceChild(f,e);c=e.getAttribute("size")||c}else{b.appendChild(f)}xtdom.setAttribute(f,"width",c);xtdom.addClassName(f,"axel-repeat-right");var a=xtdom.createElement(this.curDoc,"img");xtdom.setAttribute(a,"width",c);xtdom.addClassName(a,"axel-repeat-left");f.parentNode.insertBefore(a,f,false);start=b.firstChild;end=b.lastChild;if(start.startRepeatedItem){xtiger.cross.log("warning",'Repeat "'+this.label+'" and repeat "'+start.startRepeatedItem.label+'" with same START boundaries !')}start.startRepeatedItem=this;if(end.endRepeatedItem){xtiger.cross.log("warning",'Repeat "'+this.label+'" and repeat "'+end.endRepeatedItem.label+'" with same END boundaries !')}end.endRepeatedItem=this;a.markRepeatedEditor=this;f.markRepeatedEditor=this;if(start.xttOpenLabel){xtiger.cross.log("warning",'Repeat "'+this.label+'" and use with same START boundaries !')}if(end.xttCloseLabel){xtiger.cross.log("warning",'Repeat "'+this.label+'" and use with same END boundaries !')}var h=this;xtdom.addEventListener(a,"click",function(j){h.handleRepeat(j)},true);xtdom.addEventListener(f,"click",function(j){h.handleRepeat(j)},true);this.model=this.shallowClone(b);this.items.push([start,end,a,f]);this.configureMenuForSlice(0);if(0==this.min){this.unactivateSliceAt(0)}},shallowFinishCloning:function(c,a,b){if(a.xttOpenLabel){c.xttOpenLabel=a.xttOpenLabel}if(a.xttCloseLabel){c.xttCloseLabel=a.xttCloseLabel}if(a.markRepeatedEditor){c.markRepeatedEditor=a.markRepeatedEditor.makeSeed(this,b)}if(a.startRepeatedItem){c.startRepeatedItem=a.startRepeatedItem.makeSeed(this,b)}if(a.endRepeatedItem){c.endRepeatedItem=a.endRepeatedItem.makeSeed(this,b)}if(a.markChoiceEditor){c.markChoiceEditor=a.markChoiceEditor.makeSeed()}if(a.beginChoiceItem){c.beginChoiceItem=a.beginChoiceItem.makeSeed()}if(a.endChoiceItem){c.endChoiceItem=a.endChoiceItem.makeSeed()}if(a.xttPrimitiveEditor){c.xttPrimitiveEditor=a.xttPrimitiveEditor.makeSeed()}if(a.xttService){c.xttService=a.xttService.makeSeed()}},shallowClone:function(b){var d={};var c=xtdom.cloneNode(this.curDoc,b,false);this.seed=[-2,this.label,c,xtdom.genId(),this.min,this.max,this.pseudoLabel];this.shallowFinishCloning(c,b,d);for(var a=0;a<b.childNodes.length;a++){this.shallowCloneIter(c,b.childNodes[a],d)}return c},shallowCloneIter:function(b,c,e){var d;if(c.xttNoShallowClone){return}d=xtdom.cloneNode(this.curDoc,c,false);this.shallowFinishCloning(d,c,e);b.appendChild(d);for(var a=0;a<c.childNodes.length;a++){this.shallowCloneIter(d,c.childNodes[a],e)}},getChoiceEditorClone:function(c,b){var a=c[b];if(!a){var a=new xtiger.editor.Choice();a.initFromSeed(b,this.curDoc);c[b]=a}return a},getRepeatEditorClone:function(c,b){var a=c[b[3]];if(!a){var a=new xtiger.editor.Repeat();a.initFromSeed(b,this.curDoc);c[b[3]]=a}return a},deepFinishCloning:function(g,b,i,a,h){if(b.xttOpenLabel){g.xttOpenLabel=b.xttOpenLabel}if(b.xttCloseLabel){g.xttCloseLabel=b.xttCloseLabel}if(b.startRepeatedItem){if(b.startRepeatedItem[0]==-1){var c=this.getRepeatEditorClone(i[0],b.startRepeatedItem);c.setStartItem(g);g.startRepeatedItem=c}else{g.startRepeatedItem=this;h[0]=g}}if(b.endRepeatedItem){if(b.endRepeatedItem[0]==-1){var c=this.getRepeatEditorClone(i[0],b.endRepeatedItem);c.setEndItem(g);g.endRepeatedItem=c}else{g.endRepeatedItem=this;h[1]=g}}if(b.markRepeatedEditor){if(b.markRepeatedEditor[0]==-1){var c=this.getRepeatEditorClone(i[0],b.markRepeatedEditor);c.setMarkItem(g);g.markRepeatedEditor=c}else{g.markRepeatedEditor=this;var f=this;xtdom.addEventListener(g,"click",function(j){f.handleRepeat(j)},true);if(h[2]){h[3]=g}else{h[2]=g}}}if(b.markChoiceEditor){var c=this.getChoiceEditorClone(i[1],b.markChoiceEditor);c.setChoiceMenu(g);g.markChoiceEditor=c}if(b.beginChoiceItem){var c=this.getChoiceEditorClone(i[1],b.beginChoiceItem);c.setBeginChoiceItem(g);g.beginChoiceItem=c}if(b.endChoiceItem){var c=this.getChoiceEditorClone(i[1],b.endChoiceItem);c.setEndChoiceItem(g);g.endChoiceItem=c}if(b.xttPrimitiveEditor){var e=b.xttPrimitiveEditor;var d=e[0];g.xttPrimitiveEditor=d.createEditorFromSeed(e,g,this.curDoc,this)}},deepClone:function(b,d){var e=xtdom.cloneNode(this.curDoc,b,false);var c=[{},{}];this.deepFinishCloning(e,b,c,this,d);for(var a=0;a<b.childNodes.length;a++){this.deepCloneIter(e,b.childNodes[a],c,this,d)}return e},deepCloneIter:function(b,c,e,d,f){if(c.xttPrimitiveEditor){var g=xtdom.cloneNode(this.curDoc,c,true);b.appendChild(g);this.deepFinishCloning(g,c,e,d,f);return}var g=xtdom.cloneNode(this.curDoc,c,false);b.appendChild(g);this.deepFinishCloning(g,c,e,d,f);for(var a=0;a<c.childNodes.length;a++){this.deepCloneIter(g,c.childNodes[a],e,d,f)}},getOneCopy:function(b,a){this.tickCount++;return this.deepClone(this.model,b)},reset:function(){var a=this.total;while(a-->1){this.removeItemAtIndex(this.total-1,false)}this.total=this.min;this.configureMenuForSlice(0);if(0===this.min){this.unactivateSliceAt(0)}},plantSlice:function(b,a){if(this.items.length==1){xtdom.removeClassName(this.items[0][2],"axel-core-off")}this.items.splice(a+1,0,b)},sliceLoaded:function(){this.total++;if((0==this.min)&&(1==this.total)){this.activateSliceAt(0)}if(((0==this.min)&&(2==this.total))||((this.min>0)&&(this.total==(this.min+1)))){for(var a=0;a<=this.min;a++){this.configureMenuForSlice(a)}}this.configureMenuForSlice(this.total-1)},appendSlice:function(){var d=this.items.length-1;var b=this.getLastNodeForSlice(d);var a=[null,null,null,null];var c=this.getOneCopy(a);xtdom.moveChildrenOfAfter(c,b);this.plantSlice(a,d);if($axel.binding){$axel.binding.install(this.curDoc,a[0],a[1])}if($axel.command){$axel.command.install(this.curDoc,a[0],a[1])}return d+1},handleRepeat:function(c){var b=false;var d=xtdom.getEventTarget(c);for(var a=0;a<this.items.length;a++){if(this.items[a][2]==d){if((0==this.min)&&(0==this.total)){this.unsetOption();b=true}else{if((this.min>0)&&(1==this.total)){this.addItem(d,a,c.shiftKey);b=true}else{if((0==this.min)&&(1==this.total)){this.setOption()}else{this.deleteItem(d,a,c.shiftKey)}}}break}else{if(this.items[a][3]==d){this.addItem(d,a,c.shiftKey);b=true;break}}}if(b){xtiger.editor.Repeat.autoSelectRepeatIter(this.getFirstNodeForSlice(0))}},unsetOption:function(){this.total++;this.configureMenuForSlice(0);this.activateSliceAt(0);this.dispatchEvent(0,"axel-add")},activateNodeIter:function(a,b){if((!b)||(b.total>=1)){xtdom.removeClassName(a,"axel-repeat-unset")}},activateSliceAt:function(a){this.mapFuncToSliceAt(xtiger.editor.Repeat.prototype.activateNodeIter,a,false)},setOption:function(){this.total--;this.configureMenuForSlice(0);this.unactivateSliceAt(0);this.dispatchEvent(0,"axel-remove")},unactivateNodeIter:function(a,b){xtdom.addClassName(a,"axel-repeat-unset")},unactivateSliceAt:function(a){this.mapFuncToSliceAt(xtiger.editor.Repeat.prototype.unactivateNodeIter,a,true)},dispatchEvent:function(b,a){var c;if("undefined"!==typeof window.jQuery){c=this.items[0][0].parentNode;$(c).trigger({type:a,position:b},this)}},addItem:function(c,f,g){var j,h,d,b,k,e;var a=this.items[f];if(g){for(e=0;e<this.trash.length;e++){if(this.trash[e][0]==this){j=this.trash[e];break}}}if(j){k=j[2];h=j[1];xtdom.moveNodesAfter(h,a[1]);this.trash.splice(e,1)}else{k=[null,null,null,null];b=this.getOneCopy(k,f);xtdom.moveChildrenOfAfter(b,a[1])}this.plantSlice(k,f);this.total++;if(0==f){this.configureMenuForSlice(0)}this.configureMenuForSlice(f+1);this.configureMenuForSlice(this.total-1);if(!j&&$axel.binding){$axel.binding.install(this.curDoc,k[0],k[1])}if(!j&&$axel.command){$axel.command.install(this.curDoc,k[0],k[1])}this.dispatchEvent(f+1,"axel-add")},deleteItem:function(c,a,b){this.removeItemAtIndex(a,b);if(this.total<=1){this.configureMenuForSlice(0)}else{this.configureMenuForSlice(this.total-1)}this.dispatchEvent(a,"axel-remove")},removeLastItems:function(a){while(a-->0){this.removeItemAtIndex(this.total-1,false)}if(this.total<=1){this.configureMenuForSlice(0)}else{this.configureMenuForSlice(this.total-1)}},removeItemAtIndex:function(a,c){var f,d;var b=this.items[a];var e=c?[]:null;if(b[0]==b[1]){if(c){e.push(b[0])}b[0].parentNode.removeChild(b[0])}else{d=b[0].nextSibling;if(c){e.push(b[0])}b[0].parentNode.removeChild(b[0]);while(d&&(d!=b[1])){f=d;d=d.nextSibling;if(c){e.push(f)}b[1].parentNode.removeChild(f)}if(c){e.push(b[1])}b[1].parentNode.removeChild(b[1])}this.items.splice(a,1);if(c){this.trash.push([this,e,b])}this.total--},mapFuncToSliceAt:function(b,a){var g,f,e,d;var c=0;f=this.items[a];g=f[0];e=null;if(f[0]==f[1]){if(xtdom.ELEMENT_NODE==g.nodeType){b.call(this,g,e)}}else{while(g&&(g!=f[1])){if(g.startRepeatedItem&&(g.startRepeatedItem!=this)){if(e){if(!d){d=[e]}else{d.push(e)}}e=g.startRepeatedItem;if(g.endRepeatedItem&&(g.endRepeatedItem==g.startRepeatedItem)){if(!d){d=[e]}else{d.push(e)}}}if(g.endRepeatedItem&&(g.endRepeatedItem!=this)){if(d&&(d.length>0)){e=d.pop()}else{e=null}}if(xtdom.ELEMENT_NODE==g.nodeType){b.call(this,g,e)}g=g.nextSibling}}}};xtiger.resources.addBundle("repeat",{plusIconURL:"plus.png",minusIconURL:"minus.png",uncheckedIconURL:"unchecked.png",checkedIconURL:"checked.png"});xtiger.editor.Choice=function(){this.items=[];this.curItem=-1;this.curDoc=null;xtiger.editor.Choice.prototype.UID++};xtiger.editor.Choice.prototype={UID:0,initFromTree:function(c,a,b){this.curDoc=b;this.menu=c;c.markChoiceEditor=this;this.types=a},getTypes:function(){return this.types},getSelectedChoiceName:function(){return this.types[this.curItem]},makeSeed:function(){if(!this.seed){this.seed=[this.items.length,this.types,xtiger.editor.Choice.prototype.UID]}return this.seed},initFromSeed:function(a,b){this.curDoc=b;this.expectedLength=a[0];this.types=a[1]},setChoiceMenu:function(a){this.menu=a;this.awake(a)},setBeginChoiceItem:function(a){this.items.push([a,null])},setEndChoiceItem:function(a){this.items[this.items.length-1][1]=a;if(this.items.length==this.expectedLength){this.initializeSelectedItem(0)}},awake:function(a){var b=this;xtdom.addEventListener(a,"change",function(c){b.handleSelect(c)},false);if(xtiger.cross.UA.IE){this.handleMouseEnter=function(c){var d=xtdom.getEventTarget(c).parentNode;while(d&&((!d.className)||d.className.search("ie-select-hack")===-1)){d=d.parentNode}if(d){xtdom.addClassName(d,"hover")}else{xtdom.removeEventListener(a,"mouseenter",b.handleMouseEnter,false)}};this.handleMouseLeave=function(c){var d=xtdom.getEventTarget(c).parentNode;while(d&&((!d.className)||d.className.search("ie-select-hack")===-1)){d=d.parentNode}if(d){xtdom.removeClassName(d,"hover")}else{xtdom.removeEventListener(a,"mouseleave",b.handleMouseEnter,false)}};xtdom.addEventListener(a,"mouseenter",this.handleMouseEnter,false);xtdom.addEventListener(a,"mouseleave",this.handleMouseLeave,false)}},addChoiceItem:function(b,c,a){this.items.push([c,a]);if(c.beginChoiceItem){xtiger.cross.log("warning","Choice <",b,"> ends with an already existing choice")}if(a.endChoiceItem){xtiger.cross.log("warning","Choice <",b,"> ends with an already existing choice end")}c.beginChoiceItem=this;a.endChoiceItem=this},initializeSelectedItem:function(g){for(var c=0;c<this.items.length;c++){var b=[];var e=this.items[c];var d=e[0];var a=e[1];var f=d;b.push(xtdom.getInlineDisplay(f));if(c!=g){if(f.nodeType==xtdom.ELEMENT_NODE){f.style.display="none"}}while(f!=a){f=f.nextSibling;b.push(xtdom.getInlineDisplay(f));if(c!=g){if(f.nodeType==xtdom.ELEMENT_NODE){f.style.display="none"}}}e.push(b)}this.curItem=g},selectChoiceItem:function(g){xtiger.cross.log("plant","Choice.selectChoiceItem "+g);if(this.curItem==g){return}if(this.curItem!=-1){var e=this.items[this.curItem];var d=e[0];var a=e[1];var b=[];var f=d;b.push(xtdom.getInlineDisplay(f));if(f.nodeType==xtdom.ELEMENT_NODE){f.style.display="none"}while(f!=a){f=f.nextSibling;b.push(xtdom.getInlineDisplay(f));if(f.nodeType==xtdom.ELEMENT_NODE){f.style.display="none"}}e[2]=b}var e=this.items[g];var d=e[0];var a=e[1];var b=e[2];var c=0;var f=d;if(f.nodeType==xtdom.ELEMENT_NODE){f.style.display=b[c]}while(f!=a){c++;f=f.nextSibling;if(f.nodeType==xtdom.ELEMENT_NODE){f.style.display=b[c]}}this.curItem=g},selectChoiceForName:function(a){var b;for(b=0;b<this.types.length;b++){if(this.types[b]==a){break}}if(b!=this.types.length){this.selectChoiceItem(b);xtdom.setSelectedOpt(this.menu,b);return b}else{return this.curItem}},handleSelect:function(b){var a=xtdom.getSelectedOpt(this.menu);this.selectChoiceItem(a)}};xtiger.editor.Keyboard=function(){this.tabGroupManager=false;this.currentDevice=false;this.allowRC=false};xtiger.editor.Keyboard.prototype={setTabGroupManager:function(a){this.tabGroupManager=a},register:function(c,d){var a=d?d:c.getHandle();var f=this;var e=c;var b={keydown:function(g){f.handleKeyDown(g,e)},keyup:function(g){f.handleKeyUp(g,e)}};xtdom.addEventListener(a,"keydown",b.keydown,false);xtdom.addEventListener(a,"keyup",b.keyup,false);return b},unregister:function(c,b,d){var a=d?d:c.getHandle();xtdom.removeEventListener(a,"keydown",b.keydown,false);xtdom.removeEventListener(a,"keyup",b.keyup,false)},handleKeyDown:function(b,a){var c;if(a.isEditing()){if(this.tabGroupManager&&this.tabGroupManager.filterKeyDown(b)){return false}if(b.keyCode===13){if((!this.allowRC)||(this.allowRC&&(!this.noBlurOnRC)&&(!b.shiftKey))){c=true}}if(c){a.stopEditing(false);xtdom.preventDefault(b)}else{if(b.keyCode==27){a.cancelEditing()}}a.doKeyDown(b)}return true},handleKeyUp:function(b,a){if(a.isEditing()){if(this.tabGroupManager&&this.tabGroupManager.filterKeyPress(b)){xtdom.preventDefault(b);xtdom.stopPropagation(b);return false}else{a.doKeyUp(b)}}return true},grab:function(b,a){if(this.tabGroupManager){this.tabGroupManager.startEditingSession(a)}},release:function(b,a){if(this.tabGroupManager){this.tabGroupManager.stopEditingSession()}},enableRC:function(a){this.allowRC=true;this.noBlurOnRC=a||false},disableRC:function(){this.allowRC=false;this.noBlurOnRC=false}};xtiger.editor.TabGroupManager=function(a){this.root=a;this.direction=0};xtiger.editor.TabGroupManager.prototype={startEditingSession:function(a){this.curEditor=a;this.direction=0},stopEditingSession:function(){this.curEditor=undefined;this.direction=0},filterKeyDown:function(a){this.direction=0;if(a.keyCode==9){if(xtiger.cross.UA.gecko){this.direction=a.shiftKey?-1:1}else{if(!this._focusNextInput(a.shiftKey?-1:1)){return false}}try{xtdom.preventDefault(a);xtdom.stopPropagation(a)}catch(b){}return true}else{return false}},filterKeyPress:function(b){if(xtiger.cross.UA.gecko&&(this.direction!=0)){if(b.keyCode===9){var a=this._focusNextInput(this.direction);return a}}return false},_focusNextInput:function(a){var b=this.curEditor.getHandle(true);if(b){if(a>0){return this._focusNextInputIter(b)}else{if(a<0){return this._focusPrevInputIter(b)}}}return false},_focusNextInputIter:function(c){var d=c.parentNode,b=d.lastChild,a;if(!d||(d.tagName==="html")||d.xttHeadLabel){return false}else{if(c.nextSibling){if(c.nextSibling===b){a=this._nodeIter(b)}else{a=this._fwdSliceIter(c.nextSibling)}return a||this._focusNextInputIter(d)}else{return this._focusNextInputIter(d)}}},_focusPrevInputIter:function(b){var c=b.parentNode,d=c.firstChild,a;if(!c||(c.tagName==="html")||c.xttHeadLabel){return false}else{if(b.previousSibling){if(b.previousSibling===d){a=this._antiNodeIter(d)}else{a=this._antiSliceIter(b.previousSibling)}return a||this._focusPrevInputIter(c)}else{return this._focusPrevInputIter(c)}}},_nodeIter:function(a){if(a.xttHeadLabel){return false}if(a.xttPrimitiveEditor&&a.xttPrimitiveEditor.isFocusable()){this.curEditor.unfocus();a.xttPrimitiveEditor.focus();this.curEditor=a.xttPrimitiveEditor;return true}if(a.firstChild){return this._fwdSliceIter(a.firstChild)}return false},_fwdSliceIter:function(b,a){var e=b,d=false,f;while(e&&(!d)){if(e.startRepeatedItem){if(e.startRepeatedItem.getSize()===0){e=e.startRepeatedItem.getLastNodeForSlice(0);e=e.nextSibling;continue}}if(e.beginChoiceItem&&(e.beginChoiceItem!=a)){f=e.beginChoiceItem;if(f.items[f.curItem][0]!==f.items[f.curItem][1]){d=this._fwdSliceIter(f.items[f.curItem][0],f)}else{d=this._nodeIter(f.items[f.curItem][0])}e=f.items[f.items.length-1][1]}else{if(e.endChoiceItem&&(e.endChoiceItem!=a)){f=e.endChoiceItem;e=f.items[f.items.length-1][1]}else{d=this._nodeIter(e)}}if(!d){e=e.nextSibling}}return d},_antiNodeIter:function(a){if(a.xttHeadLabel){return false}if(a.xttPrimitiveEditor&&a.xttPrimitiveEditor.isFocusable()){this.curEditor.unfocus();a.xttPrimitiveEditor.focus();this.curEditor=a.xttPrimitiveEditor;return true}if(a.firstChild){return this._antiSliceIter(a.lastChild)}return false},_antiSliceIter:function(a,b){var e=a,d=false,f;while(e&&(!d)){if(e.endRepeatedItem){if(e.endRepeatedItem.getSize()===0){e=e.endRepeatedItem.getFirstNodeForSlice(0);e=e.previousSibling;continue}}if(e.endChoiceItem&&(e.endChoiceItem!=b)){f=e.endChoiceItem;if(f.items[f.curItem][0]!==f.items[f.curItem][1]){d=this._antiSliceIter(f.items[f.curItem][1],f)}else{d=this._antiNodeIter(f.items[f.curItem][0])}e=f.items[0][0]}else{if(e.beginChoiceItem&&(e.beginChoiceItem!=b)){f=e.beginChoiceItem;e=f.items[0][0]}else{d=this._antiNodeIter(e)}}if(!d){e=e.previousSibling}}return d}};xtiger.editor.BasicLoader=function(){};xtiger.editor.BasicLoader.prototype={loadData:function(d,b){var c=b.getRootVector();var a=[c];this.loadDataIter(d,b,a)},hasDataFor:function(c,a,b){var d=false;if(c.hasLabel()){d=(0!=b.lengthFor(a))}else{d=b.hasDataFor(c.getRepeatableLabel(),a)}return d},makeRepeatState:function(c,b,a,d){return[c,b,a,d]},loadDataSlice:function(q,d,i,f,l,s,g){var h=[],b=q,m=true,j,k;while(b&&m){if(b.startRepeatedItem&&(b.startRepeatedItem!=g)){if((h.length===0)||((h[h.length-1][0])!==b.startRepeatedItem)){if(b.startRepeatedItem.hasLabel()){var o=i.getVectorFor(b.startRepeatedItem.dump(),l);if((typeof o==="object")&&(i.lengthFor(o)>0)){f.push(o);l=o;k=this.makeRepeatState(b.startRepeatedItem,b.startRepeatedItem.getSize(),true,true)}else{j=b.startRepeatedItem.getLastNodeForSlice(b.startRepeatedItem.getSize()).nextSibling;b.startRepeatedItem.reset();b=j;continue}}else{if(this.hasDataFor(b.startRepeatedItem,l,i)){k=this.makeRepeatState(b.startRepeatedItem,b.startRepeatedItem.getSize(),false,true)}else{j=b.startRepeatedItem.getLastNodeForSlice(b.startRepeatedItem.getSize()).nextSibling;b.startRepeatedItem.reset();b=j;continue}}h.push(k)}}if(b.beginChoiceItem&&(b.beginChoiceItem!=s)){var p=b.beginChoiceItem;l=i.getVectorForAnyOf(p.getTypes(),l);if(typeof l==="object"){f.push(l);var r=p.selectChoiceForName(i.nameFor(l));if(p.items[r][0]!=p.items[r][1]){this.loadDataSlice(p.items[r][0],p.items[r][1],i,f,l,p);b=p.items[p.items.length-1][1];if((b.xttCloseLabel&&(!b.xttOpenLabel))&&(r!=(p.items.length-1))){f.pop();l=f[f.length-1]}}else{this.loadDataIter(p.items[r][0],i,f);f.pop();l=f[f.length-1];b=p.items[p.items.length-1][1]}}}else{this.loadDataIter(b,i,f);l=f[f.length-1];if(s){if(b==s.items[s.curItem][1]){f.pop();l=f[f.length-1];return}}}if(b==d){m=false}j=b.nextSibling;if(b.endRepeatedItem&&(b.endRepeatedItem!=g)){k=h[h.length-1];k[1]=k[1]-1;if(k[1]<0){if(b.endRepeatedItem.getSize()==0){b.endRepeatedItem.sliceLoaded()}}if(k[1]<=0){if(k[3]&&this.hasDataFor(b.endRepeatedItem,l,i)){var a=b.endRepeatedItem;while(this.hasDataFor(a,l,i)){var n=[l];var e=a.appendSlice();var q=a.getFirstNodeForSlice(e);var d=a.getLastNodeForSlice(e);this.loadDataSlice(q,d,i,n,l,undefined,a);a.sliceLoaded()}}if(k[2]){f.pop();l=f[f.length-1]}h.pop()}else{if(!this.hasDataFor(b.endRepeatedItem,l,i)){j=b.endRepeatedItem.getLastNodeForSlice(b.endRepeatedItem.getSize()).nextSibling;b.endRepeatedItem.removeLastItems(k[1]);h.pop();if(k[2]){f.pop();l=f[f.length-1]}}}}b=j}},loadDataIter:function(f,d,c){var e;var b=c[c.length-1];if(f.xttOpenLabel){e=f.xttOpenLabel;var a=false;if(e.charAt(0)=="@"){b=d.getAttributeFor(e.substr(1,e.length-1),b);a=true}else{b=d.getVectorFor(e,b)}if(a||((typeof b==="object")&&(d.lengthFor(b)>0))){c.push(b)}else{b=-1;c.push(b)}}if(f.xttPrimitiveEditor){f.xttPrimitiveEditor.load(b,d);b=-1}if(f.firstChild){this.loadDataSlice(f.firstChild,f.lastChild,d,c,b)}if(f.xttCloseLabel){e=f.xttCloseLabel;c.pop()}}};xtiger.editor.Generator.prototype.defaultLoader=new xtiger.editor.BasicLoader();xtiger.editor.BasicSerializer=function(a){};xtiger.editor.BasicSerializer.prototype={serializeData:function(c,b,a){b.openTag(a||"data");this.serializeDataIter(c,b,true);b.closeTag(a||"data")},serializeDataSlice:function(f,b,e,d){var a=[];var h=f;var g=true;while(h&&g){if(h.startRepeatedItem){if((a.length==0)||((a[a.length-1][0])!=h.startRepeatedItem)){if(h.startRepeatedItem.getSize()==0){h=h.startRepeatedItem.getLastNodeForSlice(0);h=h.nextSibling;continue}else{if(h.startRepeatedItem.hasLabel()){e.openTag(h.startRepeatedItem.dump())}}a.push([h.startRepeatedItem,h.startRepeatedItem.getSize()])}}if(h.beginChoiceItem&&(h.beginChoiceItem!=d)){var i=h.beginChoiceItem;e.openTag(i.getSelectedChoiceName());if(i.items[i.curItem][0]!=i.items[i.curItem][1]){this.serializeDataSlice(i.items[i.curItem][0],i.items[i.curItem][1],e,i)}else{this.serializeDataIter(i.items[i.curItem][0],e);e.closeTag(i.getSelectedChoiceName())}h=i.items[i.items.length-1][1];if(h.xttCloseLabel&&(i.curItem!=(i.items.length-1))){e.closeTag(h.xttCloseLabel)}}else{this.serializeDataIter(h,e);if(d){if(h==d.items[d.curItem][1]){e.closeTag(d.getSelectedChoiceName())}}}if(h.endRepeatedItem){if(true||(h.endRepeatedItem==a[a.length-1][0])){--(a[a.length-1][1]);if(a[a.length-1][1]<=0){if((h.endRepeatedItem.getSize()!=0)&&(h.endRepeatedItem.hasLabel())){e.closeTag(h.endRepeatedItem.dump())}a.pop()}}}if(h==b){g=false}h=h.nextSibling}},serializeDataIter:function(d,a,c){var b;if(d.xttHeadLabel&&!c){xtiger.cross.log("debug","avoid reentrant serialization of "+d.xttHeadLabel);return}if(d.xttOpenLabel){b=d.xttOpenLabel;if(b.charAt(0)=="@"){a.openAttribute(b.substr(1,b.length-1))}else{a.openTag(b)}}if(d.xttPrimitiveEditor){d.xttPrimitiveEditor.save(a)}if(d.firstChild){this.serializeDataSlice(d.firstChild,d.lastChild,a)}if(d.xttCloseLabel){b=d.xttCloseLabel;if(b.charAt(0)=="@"){a.closeAttribute(b.substr(1,b.length-1))}else{a.closeTag(b)}}}};xtiger.editor.Generator.prototype.defaultSerializer=new xtiger.editor.BasicSerializer();(function(){var _TextMetrics=function _TextMetrics(doc){this.div=xtdom.createElement(doc,"div");xtdom.addClassName(this.div,"axel-text-shadowbuffer");this.divText=xtdom.createTextNode(doc,"");this.div.appendChild(this.divText)};_TextMetrics.prototype={setBBox:function setBBox(w,h,handle,shape,type){var wpx=(w>0)?w+"px":"0px";var hpx=(h>0)?h+"px":"0px";this.lastWidth=w;this.lastHeight=h;if((type=="input")||(shape=="self")){this.div.style.width="";this.div.style.height=""}else{this.div.style.width=wpx;this.div.style.height="auto"}handle.style.width=wpx;handle.style.height=hpx},setText:function setText(text){this.divText.data=text+"m"},adjustWidth:function adjustWidth(handle,exactMath){var w=wimp=Math.max(this.div.offsetWidth,this.div.clientWidth,this.div.scrollWidth);if(w>this.lastWidth){if(!exactMath){wimp=w-(w%20)+20}else{if(!xtiger.cross.UA.webKit){wimp+=4}}handle.style.width=wimp+"px";this.lastWidth=w}},adjustHeight:function adjustHeight(handle,init){var h=Math.max(this.div.offsetHeight,this.div.clientHeight,this.div.scrollHeight);if(h>this.lastHeight){handle.style.height=h+"px";this.lastHeight=h}},grab:function grab(field){field.hook.appendChild(this.div)},release:function(field,willEditAgain){if(this.div.parentNode===field.hook){field.hook.removeChild(this.div)}}};xtiger.editor.TextDevice=function(input,kbd,doc){this.keyboard=kbd;this.field=input;this.metrics=xtiger.session(doc).load("metrics");if(!this.metrics){this.metrics=new _TextMetrics(doc);xtiger.session(doc).save("metrics",this.metrics)}this.currentEditor=null;var _this=this;this.blurHandler=function(ev){_this.handleBlur(ev)}};xtiger.editor.TextDevice.prototype={getHandle:function(){return this.field.getHandle()},isEditing:function(){return(null!=this.currentEditor)},_computeOffset:function(mouseEvent,editor){var offset=-1;var selObj,selRange;if(window.getSelection&&(editor.getParam("clickthrough")==="true")){selObj=window.getSelection();if(selObj&&(selObj.rangeCount>0)){selRange=selObj.getRangeAt(0);if(selRange){offset=selRange.startOffset}}}return offset},startEditing:function(editor,mouseEvent,doSelectAll){var ghost,offset;var constw,consth;var shape;var redux=false;var handle=this.field.getHandle();var coldStart=false;if(this.currentEditor){this.stopEditing(true)}else{this._kbdHandlers=this.keyboard.register(this);this.keyboard.grab(this,editor);if(editor.getParam("hasClass")){xtdom.addClassName(handle,editor.getParam("hasClass"))}if((!doSelectAll)&&mouseEvent){offset=this._computeOffset(mouseEvent,editor)}coldStart=true;this.field.show(editor)}this.currentEditor=editor;ghost=editor.getGhost();constw=Math.max(ghost.offsetWidth,ghost.clientWidth,ghost.scrollWidth);consth=Math.max(ghost.offsetHeight,ghost.clientHeight,ghost.scrollHeight);this.field.grab(editor);this.metrics.grab(this.field);if(editor.getParam("enablelinebreak")=="true"){this.keyboard.enableRC()}if(doSelectAll){if((editor.getParam("placeholder")!=="clear")||(mouseEvent&&mouseEvent.shiftKey)){xtdom.focusAndSelect(handle)}else{handle.value="";try{handle.focus()}catch(e){}}}else{if(offset&&(offset!==-1)){xtdom.focusAndMoveCaretTo(handle,offset)}else{xtdom.focusAndMoveCaretTo(handle,handle.value.length)}}shape=this.currentEditor.getParam("shape");if(shape.charAt(shape.length-1)=="x"){var m=shape.match(/\d+/);if(m){constw=constw-parseInt(m[0]);redux=true}}this.metrics.setBBox(constw,consth,handle,shape,this.field.deviceType);this.metrics.setText(this.field.getValue());this.metrics.adjustWidth(handle,((this.field.deviceType==="textarea")&&(shape==="parent")));this.metrics.adjustHeight(handle);if(coldStart){xtdom.addEventListener(handle,"blur",this.blurHandler,false)}},stopEditing:function(willEditAgain,isCancel){if(!this.currentEditor){return}if(!this.stopInProgress){this.stopInProgress=true;var model=this.currentEditor;this.currentEditor=null;this.field.release(model,willEditAgain);this.metrics.release(this.field);if(!isCancel){model.update(this.field.getValue())}if(!willEditAgain){if(model.getParam("enablelinebreak")=="true"){this.keyboard.disableRC()}this.keyboard.unregister(this,this._kbdHandlers);this.keyboard.release(this,model);xtdom.removeEventListener(this.getHandle(),"blur",this.blurHandler,false);if(model.getParam("hasClass")){xtdom.removeClassName(this.getHandle(),model.getParam("hasClass"))}}this.stopInProgress=false}},getCurrentModel:function(){return this.currentEditor},cancelEditing:function(){this.stopEditing(false,true)},handleBlur:function(ev){this.stopEditing(false)},doKeyDown:function(ev){if(this.currentEditor&&(this.currentEditor.getParam("expansion")=="grow")){this.curLength=this.field.getValue().length;this.adjustShape()}},doKeyUp:function(ev){if(this.currentEditor&&this.currentEditor.onkeyup){this.currentEditor.onkeyup(this.field.getHandle())}if(this.currentEditor&&(this.currentEditor.getParam("expansion")=="grow")){if(this.field.getValue().length>(this.curLength+1)){this.adjustShape()}}},adjustShape:function(){this.metrics.setText(this.field.getValue());var h=this.field.getHandle();this.metrics.adjustWidth(h);if(this.field.deviceType=="textarea"){this.metrics.adjustHeight(h)}}};xtiger.editor.FloatingField=function(kind,doc){this.deviceType=kind;this.handle=this.createHandleForDoc(kind,doc);this.hook=xtdom.createElement(doc,"div");xtdom.addClassName(this.hook,"axel-text-container");this.hook.appendChild(this.handle);this.hook.style.display="none"};xtiger.editor.FloatingField.prototype={createHandleForDoc:function(kind,doc){var device=xtiger.session(doc).load("ff_"+kind);if(!device){device=xtdom.createElement(doc,kind);xtdom.addClassName(device,"axel-text-float");xtiger.session(doc).save("ff_"+kind,device)}return device},getHandle:function(){return this.handle},getValue:function(){return this.handle.value},show:function(){this.hook.style.display="inline"},grab:function(editor){var delta;this.handle.value=editor.getData();this.editorHandle=editor.getHandle();if(this.editorHandle.getClientRects){delta=this.editorHandle.getClientRects()["0"].left-this.editorHandle.parentNode.getBoundingClientRect().left;this.handle.style.left=(0-delta)+"px"}this.editorHandle.parentNode.insertBefore(this.hook,this.editorHandle);this.editorHandle.style.visibility="hidden"},release:function(editor,willEditAgain){if(this.hook.parentNode===this.editorHandle.parentNode){this.editorHandle.parentNode.removeChild(this.hook)}editor.getHandle().style.visibility="visible";if(!willEditAgain){this.hook.style.display="none"}},setPosition:function(ghost){var pos=xtdom.findPos(ghost);with(this.handle.style){left=pos[0]+"px";top=pos[1]+"px"}}};xtiger.editor.PlacedField=function(kind,doc){this.myDoc=doc;this.deviceType=kind;this.handle=this.createHandleForDoc(kind,doc);this.handle.style.display="none";this.cache={};this.hook};xtiger.editor.PlacedField.prototype={createHandleForDoc:function(kind,doc){var device=xtiger.session(doc).load("pf_"+kind);if(!device){device=xtdom.createElement(doc,kind);xtdom.addClassName(device,"axel-text-placed");xtiger.session(doc).save("pf_"+kind,device)}return device},getHandle:function(){return this.handle},getValue:function(){return this.handle.value},show:function(editor){this.handle.style.display="inline"},grab:function(editor){var _htag;this.handle.value=editor.getData();this.editorHandle=editor.getHandle();_htag=xtdom.getLocalName(this.editorHandle);if(!this.cache[_htag]){this.hook=xtdom.createElement(this.myDoc,_htag);this.cache[_htag]=this.hook}else{this.hook=this.cache[_htag]}var parent=this.editorHandle.parentNode;if(this.hook.firstChild!=this.handle){this.hook.appendChild(this.handle)}parent.insertBefore(this.hook,this.editorHandle,true);parent.removeChild(this.editorHandle)},release:function(editor,willEditAgain){var parent=this.hook.parentNode;parent.insertBefore(this.editorHandle,this.hook,true);parent.removeChild(this.hook);if(!willEditAgain){this.handle.style.display="none"}}};xtiger.editor.TextDeviceFactory=function(){this.devKey="TextDeviceCache"};xtiger.editor.TextDeviceFactory.prototype={_getCache:function(doc){var cache=xtiger.session(doc).load(this.devKey);if(!cache){cache={input:{"float":null,placed:null},textarea:{"float":null,placed:null},filtered:{}};xtiger.session(doc).save(this.devKey,cache)}return cache},getInstance:function(doc,type,layout){var t=type||"input";if((t!="input")&&(t!="textarea")){xtiger.cross.log("error","AXEL error : unkown text device type '"+t+"' requested !");t="input"}var l=layout||"placed";if((l!="float")&&(l!="placed")){xtiger.cross.log("error","AXEL error : unkown text device layout '"+l+"' requested !");l="float"}var cache=this._getCache(doc);var fConstructor;var device=cache[t][l];if(!device){var wrapper=(l=="float")?new xtiger.editor.FloatingField(t,doc):new xtiger.editor.PlacedField(t,doc);device=new xtiger.editor.TextDevice(wrapper,xtiger.session(doc).load("keyboard"),doc);if(fConstructor){device.addFilter(fConstructor(doc))}cache[t][l]=device}return device}};xtiger.registry.registerFactory("text-device",new xtiger.editor.TextDeviceFactory())})();xtiger.editor.PopupDevice=function(a){this._document=a;this._menu=xtiger.session(a).load("popupmenu");if(!this._menu){this._menu=new xtiger.editor.PopupMenu(a);xtiger.session(a).save("popupmenu",this._menu)}this._keyboard=xtiger.session(a).load("keyboard");this._currentModel=null;this._keyboardHandlers=null;this._currentSelection=null;var b=this;this.clickHandler=function(c){b.handleClick(c)}};xtiger.editor.PopupDevice.prototype={MAX_HEIGHT:150,startEditing:function(a,c,g,d){var b=true;var f=this._menu.getHandle();if(this._currentModel!=null){this.stopEditing(true);b=false}f.style.width="";f.style.maxHeight=this.MAX_HEIGHT+"px";this._menu.setOptions(c,g);this._menu.setPosition(d);if(b){this._menu.show();xtdom.addEventListener(this._document,xtiger.cross.events.DOWN,this.clickHandler,true);this._keyboardHandlers=this._keyboard.register(this,this._document)}this._currentModel=a;this._currentSelection=null;try{this._menu.adjustHeight(f,this.MAX_HEIGHT);if(this._menu.isScrollbarInside()){this._menu.adjustWidthToScrollbar(f)}}catch(h){}},stopEditing:function(b,a){if(!this._currentModel){return}if(!a){if(this.getSelection()){if(this._currentModel.onMenuSelection){this._currentModel.onMenuSelection(this.getSelection())}else{this._currentModel.update(this.getSelection())}}}if(!b){xtdom.removeEventListener(this._document,xtiger.cross.events.DOWN,this.clickHandler,true);this._menu.hide();this._keyboard.unregister(this,this._keyboardHandlers,this._document)}if((!a)&&(this._currentModel.isOptional)&&(!this._currentModel.isSelected)){if(this._currentModel.setSelectionState){this._currentModel.setSelectionState(true)}else{this._currentModel.set()}}this._currentModel=null},cancelEditing:function(){this.stopEditing(false,true)},isEditing:function(){return this._currentModel?true:false},getSelection:function(){return this._currentSelection},setSelection:function(a){this._currentSelection=a},getHandle:function(){return this._menu.getHandle()},handleClick:function(a){this._menu.handleClick(a,this)},doKeyDown:function(a){switch(a.keyCode){case 38:this._menu.selectPrev();xtdom.preventDefault(a);xtdom.stopPropagation(a);break;case 40:this._menu.selectNext();xtdom.preventDefault(a);xtdom.stopPropagation(a);break;default:}this._currentSelection=this._menu.getSelected()},doKeyUp:function(a){}};xtiger.editor.PopupMenu=function(a){this._document=a;this._handle=this._createMenuForDoc(a);this._handle.style.visibility="hidden";this._currentSelection=-1;this._options=null};xtiger.editor.PopupMenu.prototype={_createMenuForDoc:function(b){var a=b.getElementsByTagName("body")[0];var c=xtdom.createElement(b,"div");xtdom.addClassName(c,"axel-popup-container");a.appendChild(c);return c},_createMenuElement:function(b,d){var c=xtdom.createElement(this._document,"li");c.isNestedList=false;switch(typeof b){case"object":if(b.value&&b.display){c.selectionvalue=b.value;xtdom.addClassName(c,"axel-popup-selectable");d.push(c);try{c.innerHTML=b.display}catch(g){xtiger.cross.log("warning",'The following text is not proper HTML code \n\t"'+b.display+'"\n\tCause : '+g.message);var f=xtdom.createTextNode(this._document,b.display);c.appendChild(f)}break}else{if(b.section){c.selectionvalue=null;c.isNestedList=true;try{c.innerHTML='<table class="axel-popup-sublist"><tbody><tr><td class="axel-popup-sublistheader"></td><td class="axel-popup-sublistbody"><ul style="margin-left:0"></ul></td></tr></tbody></table>';_header=c.firstChild.firstChild.firstChild.firstChild;_body=_header.nextSibling.firstChild;if(b.header){_header.innerHTML=b.header}for(var e=0;e<b.section.length;e++){var a=this._createMenuElement(b.section[e],d);_body.appendChild(a)}}catch(g){xtiger.cross.log("warning",'The following text is not proper HTML code \n\t"'+b.header+'"\n\tCause : '+g.message);var f=xtdom.createTextNode(this._document,b.display);c.appendChild(f)}break}}case"string":default:f=xtdom.createTextNode(this._document,b);c.selectionvalue=b;c.appendChild(f);xtdom.addClassName(c,"axel-popup-selectable");d.push(c)}return c},_setPositionXY:function(x,y){with(this._handle.style){left=x+"px";top=y+"px"}},getHandle:function(){return this._handle},isScrollbarInside:function(){return xtiger.cross.UA.gecko||xtiger.cross.UA.webKit||xtiger.cross.UA.IE},adjustWidthToScrollbar:function(g){var c,e=20,d=10+e;if(g.scrollHeight>g.clientHeight){var f=xtdom.findPos(g);var b=xtdom.getWindowLimitFrom(g);var a=b[0]-f[0]-d;c=((g.scrollWidth+e)<a)?g.scrollWidth+e:a;g.style.width=c+"px"}},adjustHeight:function(h,b){var c,d=20,a=b;var g=xtdom.findPos(h);var e=xtdom.getWindowLimitFrom(h);var f=e[1]-g[1]-d;if((f<h.clientHeight)||(h.scrollHeight>h.clientHeight)){a=(f>b)?f:b;a=a+"px";c=h.style.maxHeight||"";if(c!=a){h.style.maxHeight=a}}},setOptions:function(d,c){this._currentSelection=-1;this._options=[];this._handle.innerHTML='<ul style="margin-left:0"></ul>';for(var b=0;b<d.length;b++){var a=this._createMenuElement(d[b],this._options);if(c&&a.selectionvalue==c){xtdom.addClassName(a,"selected")}else{xtdom.removeClassName(a,"selected")}this._handle.firstChild.appendChild(a)}},setPosition:function(a){var b=xtdom.findPos(a);this._setPositionXY(b[0],a.offsetHeight+b[1])},selectNext:function(){if(this._currentSelection!=-1){xtdom.removeClassName(this._options[this._currentSelection],"selected")}this._currentSelection++;this._currentSelection%=(this._options.length);xtdom.addClassName(this._options[this._currentSelection],"selected")},selectPrev:function(){if(this._currentSelection!=-1){xtdom.removeClassName(this._options[this._currentSelection],"selected")}else{this._currentSelection=1}this._currentSelection--;if(this._currentSelection<0){this._currentSelection=this._options.length-1}xtdom.addClassName(this._options[this._currentSelection],"selected")},getSelected:function(){if(this._currentSelection==-1){return false}var a=this._options[this._currentSelection];if(a.value){return a.selectionvalue}return a.firstChild.data},show:function(){this._handle.style.visibility="visible"},hide:function(){this._handle.style.visibility="hidden"},handleClick:function(b,a){var c=xtdom.getEventTarget(b);while(c.parentNode){if(xtdom.getLocalName(c).toLowerCase()==="li"&&c.selectionvalue){a.setSelection(c.selectionvalue);xtdom.preventDefault(b);xtdom.stopPropagation(b);a.stopEditing(false,false);return}if(c==this._handle){return}c=c.parentNode}xtdom.preventDefault(b);xtdom.stopPropagation(b);a.stopEditing(false,true)}};xtiger.editor.LayoutManager=(function LayoutManager(){var d;var b;var a;var c=function c(){d=xtdom.createElement(a,"img");d.setAttribute("src",xtiger.bundles.lens.whiteIconURL)};return function(e){a=e;b=xtdom.createElement(e,"div");xtdom.addClassName(b,"axel-layout-container");this.getFakeDiv=function(){if(!d){c()}return d};this.getLayoutHandle=function(){return b}}})();xtiger.editor.LayoutManager.prototype={_getDistanceFor:function(a,e){var c=xtdom.getComputedStyle(a,e),b=c.match(/\d*/),d=(b&&b[0]&&(b[0]!=""))?parseInt(b):0;return(!isNaN(d))?d:0},_getOffset:function(e){var d=0,c=0,b,a;switch(xtdom.getComputedStyle(e,"position")){case"absolute":case"fixed":break;case"relative":d=this._getDistanceFor(e,"top");c=this._getDistanceFor(e,"left");case"static":default:b=this._getDistanceFor(e,"margin-top");a=this._getDistanceFor(e,"margin-left");d+=(b>0)?b:0;c+=(a>0)?a:0}return[c,d]},_confirmInsertion:function(b){var a=(!this.curHandle)||(this.curHandle!=b);if(this.curHandle&&(this.curHandle!=b)){this.restoreHandle()}return a},_setDisplay:function(c,b){var a=xtdom.getComputedStyle(b,"display");a=(/^block$|^inline$/.test(a))?a:"block";c.style.display=a},_setOrigin:function(b,c,a){b.style.left=""+(c[0]-a[0])+"px";b.style.top=""+(c[1]-a[1])+"px"},_insert:function(g,h,f,b,a){var i,c,d,j=b,e=this._confirmInsertion(h);if(e){i=this.getLayoutHandle();c=this._getOffset(h);this._setDisplay(i,h);i.style.visibility="hidden";if(g=="above"){h.parentNode.insertBefore(i,h)}else{d=this.getFakeDiv();h.parentNode.replaceChild(d,h);d.parentNode.insertBefore(i,d)}i.appendChild(f);if(a){j=a()}this._setOrigin(i,c,j);i.style.visibility="visible";this.curDisplay=g;this.curHandle=h;this.curLensContent=f}return e},insertAbove:function(c,b,a,d){this._insert("above",c,b,a,d)},insertInline:function(e,d,c,g){var i,a,f,b;if(this._insert("inline",e,d,c,g)){i=d.getBoundingClientRect();a=i?(i.right-i.left):1;f=i?(i.bottom-i.top):1;b=this.getFakeDiv();b.style.width=a+"px";b.style.height=f+"px"}},restoreHandle:function(){var a;if(this.curHandle){if(this.curDisplay=="inline"){a=this.getFakeDiv();a.parentNode.replaceChild(this.curHandle,a)}else{this.curHandle.style.visibility="visible"}xtdom.removeElement(this.curLensContent);xtdom.removeElement(this.getLayoutHandle());this.curHandle=this.curDisplay=this.curLensContent=undefined}}};xtiger.editor.LensDevice=function(x){var w=x;var g=xtiger.session(x).load("keyboard");var f;var b;var h;var k;var a={trigger:"click",display:"above",padding:"10px"};var i=false;var u=false;var s=this;var z={click:["click",function(C){s._onClick(C)}],mouseover:["mousemove",function(C){s._onMouseMove(C)}]};var A=function(D,C){return(C.getParam&&C.getParam(D))||a[D]};var r=function(){if(!k){k=new xtiger.editor.LayoutManager(w)}return k};var e=function(D){var C=xtiger.factory("lens").getWrapper(w,D);if(!C){xtiger.cross.log("warning",'Missing wrapper "'+aWrapperName+'" in lens device, startEditing aborted')}return C};var d=function(G,D,C,E){var F;try{F=b.grab(G,C,E)}catch(H){xtiger.cross.log("error ( "+H.message+' ) "',D+'" failed to grab the lens device, startEditing compromised')}return F||E};var c=function(C,E){if(!C.isEditing()){return}if(b.isFocusable()){g.unregister(C,C._handlers)}r().restoreHandle();var D=A("trigger",f);if(z[D]){xtdom.removeEventListener(w,z[D][0],z[D][1],true);i=false}if(E){f.update(b.getData())}b.release();f=null;b=null;h=null};this.startEditing=function B(F,E,D){var I,G,H,J;var C=D?true:false;if(this.isEditing()){this.stopEditing()}b=e(E);if(b){f=F;if(b.isFocusable()){this._handlers=g.register(this);g.grab(this,F)}G=A("padding",F).match(/\d*/)[0];G=(H&&H!="")?parseInt(H):10;H=[G,G];h=b.getHandle();I=A("display",f);if(I=="above"){r().insertAbove(f.getHandle(),h,H,function(){return d(s,E,C,H)})}else{if(I=="inline"){r().insertInline(f.getHandle(),h,H,function(){return d(s,E,C,H)})}else{xtiger.cross.log("error",'unkown display "'+I+'" in lens device, startEditing compromised')}}b.activate(this,D);J=A("trigger",F);if(z[J]){xtdom.addEventListener(w,z[J][0],z[J][1],true);i=false}else{xtiger.cross.log("error",'unkown trigger mode "'+J+'" in lens device, startEditing compromised')}}};this.stopEditing=function m(){c(this,true)};this.cancelEditing=function o(){c(this,false)};this.isEditing=function q(){return f?true:false};this.getHandle=function v(){if(b){return b.getHandle()}return null};this.getCurrentModel=function y(){if(f){return f}return null};this.keepAlive=function l(C){u=C};this._onClick=function(C){if(u){return}var E=true;var D=xtdom.getEventTarget(C);while(D.parentNode){if(D==h){E=false;break}D=D.parentNode}if(E){this.stopEditing()}};this._onMouseMove=function(D){if(u||(!h)){return}var F=D.clientX;var E=D.clientY;var C=h.getBoundingClientRect();if(i){if(!(C.left>F||C.top>E||C.right<=F||C.bottom<=E)){i=false}}else{if(C.left>F||C.top>E||C.right<=F||C.bottom<=E){this.stopEditing();xtdom.stopPropagation(D)}}};this.doKeyUp=function n(C){};this.doKeyDown=function j(C){if(!this.isEditing()){return}if(C.keyCode=="38"||C.keyCode=="40"){b.toggleField()}if(C.keyCode=="27"){this.cancelEditing()}xtdom.stopPropagation(C)};this.mouseMayLeave=function p(){i=true}};xtiger.editor.LensDeviceFactory=function(){this.devKey="LensDeviceCache";this.wrappers={}};xtiger.editor.LensDeviceFactory.prototype={_getCache:function(b){var a=xtiger.session(b).load(this.devKey);if(!a){a={device:null,wrappers:{}};xtiger.session(b).save(this.devKey,a)}return a},registerWrapper:function(b,a){if(this.wrappers[b]){xtiger.cross.log("error","Error (AXEL) attempt to register an already registered wrapper : '"+b+"' with 'lens' device !")}else{this.wrappers[b]=a}},getWrapper:function(a,d){var b=this._getCache(a);var e=b.wrappers[d];if(!e){var c=this.wrappers[d];if(c){e=b.wrappers[d]=c(a)}}if(!e){xtiger.cross.log("error","Error (AXEL) : unkown wrapper '"+d+"' requested in 'lens' device !")}return e},getInstance:function(a){var b=this._getCache(a);var c=b.device;if(!c){c=b.device=new xtiger.editor.LensDevice(a)}return c}};xtiger.resources.addBundle("lens",{whiteIconURL:"white.png"});xtiger.registry.registerFactory("lens",new xtiger.editor.LensDeviceFactory());(function(){var b={decode_success:function(d){return d.responseText},decode_error:function(d){return d.responseText}};function c(d){var e=this;this.inProgress=null;this.available=[];this.curDoc=d;this.polllCounter=-1;this.onPoll=function(){e.poll()}}c.prototype={_reset:function(d){if(this.inProgress!==d){alert("Warning: attempt to close an unkown transmission !")}d.reset();this.available.push(d);this.inProgress=null},getUploader:function(){return(this.available.length>0)?this.available.pop():new a(this)},isReady:function(){return(null===this.inProgress)},isTransmitting:function(d){return(d&&(d===this.inProgress))},startPolling:function(){var d=frames["xt-photo-target"];if(d&&d.document&&d.document.body){d.document.body.innerHTML="WAITING";setTimeout(this.onPoll,500);this.polllCounter=0}},poll:function(){var d,e=frames["xt-photo-target"];if(this.pollCounter!==-1){if(e&&e.document&&e.document.body){d=e.document.body.textContent||e.document.body.innerText}if("WAITING"!==d){this.reportEoT(0,d)}else{setTimeout(this.onPoll,500)}}},stopPolling:function(){this.pollCounter=-1},startTransmission:function(e,d){this.inProgress=e;if(e.dataType==="form"){this.startPolling()}e.start(d)},startPreflight:function(e,d){this.inProgress=e;e.preflight(d)},reportEoT:function(e,d){this.stopPolling();if(this.inProgress!==null){if(1===e){this.notifyComplete(this.inProgress,d)}else{this.notifyError(this.inProgress,0,d)}}},notifyComplete:function(f,d){var e=f.client;this._reset(f);e.onComplete(d)},notifyError:function(g,f,e){var d=g.client;this._reset(g);d.onError(e,f)},cancelTransmission:function(e){var d=e.client;e.cancel();this._reset(e);d.onCancel()}};function a(d){this.manager=d;this.xhr=null;this.defaultUrl="/upload"}a.prototype={reset:function(){delete this.url},setDataType:function(d){this.dataType=d},setAction:function(d){this.url=d},getClient:function(){return this.client},setClient:function(d){this.client=d},start:function(d){this.client=d;try{if(this.dataType==="formdata"){this.startXHRForm()}else{var f=this.client.getPayload();if(this.url){xtdom.setAttribute(f,"action",this.url)}else{if(!f.getAttribute("action")){xtdom.setAttribute(f,"action",this.defaultUrl)}}f.documentId.value=this.client.getDocumentId()||"noid";f.submit()}}catch(g){this.manager.notifyError(this,g.name,g.message)}},preflight:function(d){var i,g,f,j=this;this.client=d;this.xhr=new XMLHttpRequest();this.isCancelled=false;this.xhr.onreadystatechange=function(){var e;if(!j.isCancelled){e=xtiger.registry.hasFactoryFor("protocol.upload")?xtiger.factory("protocol.upload").getInstance():b;if(4===j.xhr.readyState){if(200===j.xhr.status){j.manager.notifyComplete(j,e.decode_success(j.xhr))}else{j.manager.notifyError(j,j.xhr.status,e.decode_error(j.xhr))}}}};try{this.xhr.open("POST",this.url||this.defaultUrl,true);i=new FormData();g=d.getPreflightOptions();for(f in g){i.append(f,g[f])}this.xhr.send(i)}catch(h){this.manager.notifyError(this,h.name,h.message)}},startXHRForm:function(){var h,f,d,i=this;this.xhr=new XMLHttpRequest();this.isCancelled=false;this.xhr.onreadystatechange=function(){var e;if(!i.isCancelled){e=xtiger.registry.hasFactoryFor("protocol.upload")?xtiger.factory("protocol.upload").getInstance():b;if(4===i.xhr.readyState){if(201===i.xhr.status){i.manager.notifyComplete(i,e.decode_success(i.xhr))}else{i.manager.notifyError(i,i.xhr.status,e.decode_error(i.xhr))}}}};try{this.xhr.open("POST",this.url||this.defaultUrl,true);h=new FormData();f=this.client.getPayload();for(d in f){h.append(d,f[d])}this.xhr.send(h)}catch(g){this.manager.notifyError(this,g.name,g.message)}},cancel:function(){if(this.xhr){this.isCancelled=true;this.xhr.abort()}else{var d=this.client.getPayload();d.reset()}}};xtiger.registry.registerFactory("upload",{getInstance:function(e){var d=xtiger.session(e).load("upload");if(!d){d=new c(e);xtiger.session(e).save("upload",d)}return d}})}());(function(){function a(c,g){var l=this,e,j,f,h,b;function k(i){if(l.targetModel!==undefined){l.commands[i.data][0].call(l.targetModel)}}function d(o){var m,p,n,i;if(l.targetNode){m=$(l.targetNode);p=m.offset();if(p){n=p.left+m.width();i=p.top+m.height();if((o.pageX>n)||(o.pageX<p.left)||(o.pageY<p.top)||(o.pageY>i)){l.stopEditing()}}else{xtiger.cross.log("debug","[Tracker menu] moveCb cannot find position for element")}}else{xtiger.cross.log("debug","[Tracker menu] calling move with no target")}}this.targetModel=undefined;this.targetNode=undefined;this.commands={};this.menuDiv=xtdom.createElement(c,"div");xtdom.addClassName(this.menuDiv,"axel-tracker-menu");b=$(this.menuDiv);for(e=0;e<g.length;e++){for(j in g[e]){f=g[e][j][0];h=xtdom.createElement(c,"button");this.menuDiv.appendChild(h);$(h).text(f).bind("click",j,k);this.commands[j]=[g[e][j][1],h,true]}}b.appendTo($("body",c));this.menuWidth=b.width();this.menuHeight=b.height();b.hide();this.startEditing=function(n,i,p){var o;var m=$(i);var q=m.offset();this.targetModel=n;this.targetNode=i;$("body",n.getDocument()).bind("mousemove",d);$(this.menuDiv).css({top:q.top+(m.height()/2)-(this.menuHeight/2),left:q.left+(m.width()/2)-(this.menuWidth/2)}).show();for(o in p){p[o]?this.enable(o):this.disable(o)}};this.stopEditing=function(){if(this.targetModel){$("body",this.targetModel.getDocument()).unbind("mousemove",d);this.targetModel=undefined;this.targetNode=undefined;$(this.menuDiv).hide()}}}a.prototype={isTracking:function(){return(this.targetModel!==undefined)},disable:function(b){if(this.commands[b][2]){this.commands[b][1].disabled=true;$(this.commands[b][1]).addClass("off");this.commands[b][2]=false}},enable:function(b){if(this.commands[b][2]===false){this.commands[b][1].disabled=false;$(this.commands[b][1]).removeClass("off");this.commands[b][2]=true}}};xtiger.editor.TrackerMenu=a})();(function(a){var b=(function(){function c(g){var e="popupdevice";var f=xtiger.session(g).load(e);if(!f){f=new xtiger.editor.PopupDevice(g);xtiger.session(g).save(e,f)}return f}function d(f){var e;if(f.indexOf("\\ ")===-1){return f.split(" ")}else{e=f.replace(/\\ /g,"&nbsp;");return xtiger.util.array_map(e.split(" "),function(g){return g.replace(/&nbsp;/g," ")})}}return{onGenerate:function(h,g,e){var f=xtdom.createElement(e,"span");var i=xtdom.createTextNode(e,"");f.appendChild(i);xtdom.addClassName(f,"axel-core-editable");h.appendChild(f);return f},onInit:function(g,e,f){this.defaultScreenData=g;this.device=c(this.getDocument());if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}this._setData(this.i18nFilter(this.defaultScreenData,false),this.defaultScreenData)},onAwake:function(){var e=this;xtdom.addEventListener(this._handle,"click",function(f){e.startEditing(f)},true)},onLoad:function(g,f){var e;if(g!==-1){e=f.getDataFor(g);if(e){this._setData(e)}this.set(false)}else{this.clear(false)}},onSave:function(e){if((!this.isOptional())||this.isSet()){e.write(this._data)}else{e.discardNodeIfEmpty()}},api:{_parseFromTemplate:function(f){var g;this._param={};xtiger.util.decodeParameters(f.getAttribute("param"),this._param);this._content=xtdom.extractDefaultContentXT(f);g=f.getAttribute("option");this._option=g?g.toLowerCase():null;var e=f.getAttribute("values");var j=f.getAttribute("i18n");var i=e?d(e):"null";var h=j?d(j):false;this._param.values=h?[h,i]:i}},methods:{_setData:function(e,f){var g=f||this.i18nFilter(e,true);if(this._handle.firstChild){this._handle.firstChild.data=g}this._data=e},getData:function(){var e=(this.getParam("select_dispatch")==="value")?this._data:this.i18nFilter(this._data,true);return e},startEditing:function(g){var e,f=this.getParam("values");if(f){e=("string"!==typeof(f[0]))?f[0]:f;this.device.startEditing(this,e,this.i18nFilter(this._data,true),this.getHandle())}},stopEditing:function(){},update:function(e){var f=(this.getParam("select_dispatch")==="value")?e:this.i18nFilter(e,false);if(f===this._data){return}this._setData(f);this.setModified(e!==this.i18nFilter(this.defaultScreenData,false));this.set(true)},clear:function(e){this._setData(this.i18nFilter(this.defaultScreenData,false),this.defaultScreenData);if(this.isOptional()){this.unset(e)}},onMenuSelection:function(e){if(this.getParam("select_dispatch")==="value"){this.update(this.i18nFilter(e,false))}else{this.update(e)}},i18nFilter:function(j,e){var g,h=j,f=this.getParam("values");if(!f){xtiger.cross.log("error",'missing "values" attribute in "select" plugin declaration')}else{if("string"!==typeof(f[0])){var l=f[e?1:0];var k=f[e?0:1];for(g=0;g<l.length;g++){if(j===l[g]){if(g<k.length){h=k[g]}else{h="**Error**"}break}}}}return h}}}}());a.plugin.register("select",{filterable:true,optional:true},{select_dispatch:"value"},b)}($axel));(function(a){var b={onGenerate:function(e,d,c){var i=d.getAttribute("handle")||"span",g=xtdom.createElement(c,i),f=xtdom.createTextNode(c,"");g.appendChild(f);xtdom.addClassName(g,"axel-core-on");e.appendChild(g);return g},onInit:function(h,f,g){var e,d=this.getParam("device"),c=this.getParam("placeholder")==="empty";if((!h)||(typeof h!=="string")){this._content=c?"":"click to edit"}this._data=this.getDefaultData();this._setData(c?"":this._data);if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}e=d?xtiger.factory(d):xtiger.factory(this.getParam("defaultDevice"));this._device=e.getInstance(this.getDocument(),this.getParam("type"),this.getParam("layout"));this._noData=this._handle.firstChild},onAwake:function(){var c=this;if(!this.getParam("noedit")){xtdom.addClassName(this._handle,"axel-core-editable");xtdom.addEventListener(this._handle,"click",function(d){c.startEditing(d)},true)}},onLoad:function(f,e){var d,c;if(f!==-1){d=e.getDataFor(f);c=this.getDefaultData();this._setData(d||(this.getParam("placeholder")==="empty"?"":c));this.setModified(d&&(d!==c));this.set(false)}else{this.clear(false)}},onSave:function(c){if(this.isOptional()&&(!this.isSet())){c.discardNodeIfEmpty();return}if(this._data){if(this.isModified()||(this.getParam("placeholder")!=="clear")){c.write(this._data)}}else{if(this.getParam("placeholder")==="empty"){c.write(this.getDefaultData())}}},api:{isFocusable:function(){return !this.getParam("noedit")},focus:function(){this.startEditing()},unfocus:function(){this.stopEditing()},getHandle:function(c){if(c){if(this.getParam("layout")==="placed"&&this._device&&this._device.getCurrentModel()===this){return this._device.getHandle()}}return this._handle}},methods:{_setData:function(c){if(this._handle.firstChild){this._handle.firstChild.data=c}this._data=c},getData:function(){return this._data},getGhost:function(){var c=this.getParam("shape");return(c&&c.charAt(0)==="p")?this._handle.parentNode:this._handle},startEditing:function(d){var c=!this.isModified()||(d&&d.shiftKey);this._device.startEditing(this,d,c)},stopEditing:function(){this._device.stopEditing(false,false)},update:function(c){var d,e;if(c===this._data){return}d=c.replace(/^\s\s*/,"").replace(/\s\s*$/,"");e=d===this.getDefaultData();if((d.length===0)||(e&&(this.getParam("placeholder")!=="preserve"))){this.clear(true);return}this._setData(d);this.setModified(!e);this.set(true)},clear:function(c){this._setData(this.getParam("placeholder")==="empty"?"":this.getDefaultData());this.setModified(false);if(this.isOptional()&&this.isSet()){this.unset(c)}}}};a.plugin.register("text",{filterable:true,optional:true},{placeholder:"preserve",device:"text-device",type:"input",layout:"placed",shape:"self",expansion:"grow",clickthrough:"true",enablelinebreak:"false"},b)}($axel));(function(a){var b=(function(){var e=-1;function c(g){try{g.getDocument().execCommand("selectAll",false,"")}catch(h){}}function f(h){var g=h.replace(/\s+/gi," ");if(/\s/.test(g.charAt(0))){g=g.substr(1)}if(/\s$/.test(g)){g=g.substr(0,g.length-1)}return g}function d(h,i){var g="";if((h.children.length>1)||(h.firstChild&&(h.firstChild.nodeType!==xtdom.TEXT_NODE))){if(typeof h.textContent==="string"){g=h.textContent}else{if(typeof h.innerText==="string"){g=h.innerText}}h.innerHTML="";t=xtdom.createTextNode(i,g?f(g):g);h.appendChild(t)}}return{onGenerate:function(j,i,g){var m=i.getAttribute("handle")||"span",l=xtdom.createElement(g,m),k=xtdom.createTextNode(g,"");l.appendChild(k);xtdom.addClassName(l,"axel-core-on");j.appendChild(l);return l},onInit:function(i,g,h){if((!i)||(typeof i!=="string")){this._content="click to edit"}this.model=i;this._setData(this.model);if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}this.keyboard=xtiger.session(this.getDocument()).load("keyboard");this.editInProgress=false},onAwake:function(){var g=this;if(this.getParam("noedit")!=="true"){xtdom.setAttribute(this._handle,"contenteditable","true");xtdom.addClassName(this._handle,"axel-core-editable");xtdom.addEventListener(this._handle,"mousedown",function(h){if(h.shiftKey){e=new Date().getTime()}},true);xtdom.addEventListener(this._handle,"focus",function(h){g.startEditing()},true);if(xtiger.cross.UA.gecko){xtdom.addEventListener(this._handle,"mousedown",function(h){if(h.detail>=3){xtdom.preventDefault(h);xtdom.stopPropagation(h);g._handle.focus();c(g)}},true)}if(xtiger.cross.UA.webKit){this.doSelectAllCb=function(){c(g)}}}this.blurHandler=function(h){g.handleBlur(h)}},onLoad:function(j,i){var h,g;if(j!==-1){h=i.getDataFor(j);g=this.getDefaultData();this._setData(h||g);this.setModified(h!==g);this.set(false)}else{this.clear(false)}},onSave:function(g){if(this.isOptional()&&(!this.isSet())){g.discardNodeIfEmpty();return}if(this.model){g.write(this.model)}},api:{isFocusable:function(){return this.getParam("noedit")!=="true"},focus:function(){this._handle.focus()},unfocus:function(){this.stopEditing(false)}},methods:{_setData:function(g){var h;if(this._handle.firstChild){this._handle.firstChild.data=g}else{h=xtdom.createTextNode(this.getDocument(),g);this._handle.appendChild(h)}this.model=g},isEditing:function(){return this.editInProgress!==false},cancelEditing:function(){this.stopEditing(true)},doKeyDown:function(g){},doKeyUp:function(g){},startEditing:function(){if(this.editInProgress===false){this.editInProgress=true;this.kbdHandlers=this.keyboard.register(this);this.keyboard.grab(this,this);if((!this.isModified())||((e!==-1)&&((e-new Date().getTime())<100))){if(xtiger.cross.UA.webKit){setTimeout(this.doSelectAllCb,100)}else{c(this)}}xtdom.addEventListener(this._handle,"blur",this.blurHandler,false)}},stopEditing:function(g){if((!this.stopInProgress)&&(this.editInProgress!==false)){this.stopInProgress=true;e=-1;this.keyboard.unregister(this,this.kbdHandlers);this.keyboard.release(this,this);xtdom.removeEventListener(this._handle,"blur",this.blurHandler,false);d(this._handle,this.doc);if(!g){this.update(this._handle.firstChild?this._handle.firstChild.data:null)}else{if(this._handle.firstChild){this._handle.firstChild.data=this.model}}this._handle.blur();this.stopInProgress=false;this.editInProgress=false}},update:function(g){if(g===this.model){return}if((!g)||(g.search(/\S/)===-1)||(g===this.getDefaultData())){this.clear(true);return}this._setData(g);this.setModified(true);this.set(true)},clear:function(g){this._setData(this.getDefaultData());this.setModified(false);if(this.isOptional()&&this.isSet()){this.unset(g)}},handleBlur:function(g){this.stopEditing(false)}}}}());a.plugin.register("content",{filterable:false,optional:true},{noedit:"false"},b)}($axel));(function(a){var b={onGenerate:function(f,e,c){var d=xtdom.createElement(c,"img");xtdom.setAttribute(d,"src",xtiger.bundles.photo.photoIconURL);xtdom.addClassName(d,"axel-drop-target");xtdom.addClassName(d,"axel-photo-model");f.appendChild(d);return d},onInit:function(f,c,d){var e=this.getParam("photo_base");if(e&&(e.charAt(e.length-1)!=="/")){e=e+"/";this._param.photo_base=e}this.state=new xtiger.editor.PhotoState(this);if(e){this.state.base=e}},onAwake:function(){this.device=xtiger.factory("lens").getInstance(this.getDocument());var c=this;xtdom.addEventListener(this._handle,"error",function(d){c.state.onError("Broken Image",true)},false);xtdom.addEventListener(this._handle,this.getParam("trigger"),function(d){c.device.startEditing(c,"photo");xtdom.preventDefault(d);xtdom.stopPropagation(d)},false);this._constructStateFromUrl(this.getDefaultData());this.redraw(false)},onLoad:function(f,e){var d,c=(f!==-1)?e.getDataFor(f):this.getDefaultData();this._constructStateFromUrl(c);if(e.hasAttributeFor("resource_id",f)){d=e.getAttributeFor("resource_id",f);this.state.resourceId=e.getDataFor(d)}this.redraw(false)},onSave:function(c){c.write(this._dump());if(this.state.resourceId){c.writeAttribute("resource_id",this.state.resourceId)}},api:{},methods:{getData:function(){return this.state},getFile:function(){return this.file},_constructStateFromUrl:function(c){this.state.resourceId=null;if(c&&(c.search(/\S/)!==-1)){this.state.status=xtiger.editor.PhotoState.prototype.COMPLETE;this.state.photoUrl=c}else{this.state.status=xtiger.editor.PhotoState.prototype.READY;this.state.photoUrl=null}},_dump:function(){return(this.state.photoUrl)?this.state.photoUrl:""},redraw:function(d){var c,h,f,e=false;switch(this.state.status){case xtiger.editor.PhotoState.prototype.READY:h=xtiger.bundles.photo.photoIconURL;break;case xtiger.editor.PhotoState.prototype.ERROR:h=xtiger.bundles.photo.photoBrokenIconURL;break;case xtiger.editor.PhotoState.prototype.UPLOADING:h=xtiger.bundles.photo.spiningWheelIconURL;break;case xtiger.editor.PhotoState.prototype.COMPLETE:if(d){var g=this._handle.getAttribute("src");if(g!==this.state.photoUrl){xtiger.editor.Repeat.autoSelectRepeatIter(this._handle)}}e=true;h=this.state.genPhotoUrl();break;default:h=xtiger.bundles.photo.photoBrokenIconURL}if((this._handle.getAttribute("src")!==h)||e){xtdom.setAttribute(this._handle,"src",f?f+h:h);if(xtiger.cross.UA.IE){this._handle.removeAttribute("width");this._handle.removeAttribute("height")}c=this.getParam("photo_class");if(c){if(xtiger.editor.PhotoState.prototype.COMPLETE===this.state.status){xtdom.addClassName(this._handle,c)}else{xtdom.removeClassName(this._handle,c)}}}},update:function(c){if(c.isPhotoStateObject===undefined){if(c.photoUrl){this._constructStateFromUrl(c.photoUrl);if(c.resource_id){this.state.resourceId=c.resource_id}}else{this._constructStateFromUrl(c)}this.redraw(true)}},stopEditing:function(){}}};a.plugin.register("photo",{filterable:true,optional:true},{trigger:"click"},b);xtiger.resources.addBundle("photo",{photoIconURL:"icons/photo.png",photoBrokenIconURL:"icons/photobroken.png",spiningWheelIconURL:"icons/spiningwheel.gif",lensBoxURL:"photo.xhtml"});xtiger.editor.PhotoState=function(c){this.status=this.READY;this.photoUrl=null;this.resourceId=null;this.errMsg=null;this.transmission=null;this.delegate=c};xtiger.editor.PhotoState.prototype={READY:0,ERROR:1,UPLOADING:2,COMPLETE:3,isPhotoStateObject:true,genPhotoUrl:function(){return(this.base?this.base+this.photoUrl:this.photoUrl)},setDelegate:function(c){this.delegate=c},getPayload:function(){return this.payload},getDocumentId:function(){return xtiger.session(this.myDoc).load("documentId")},startTransmission:function(g,e,f,c){this.cached=[this.status,this.photoUrl,this.resourceId,this.errMsg];var d=xtiger.factory("upload").getInstance(g);this.myDoc=g;this.transmission=d.getUploader();this.transmission.setDataType(e);if(c){this.transmission.setAction(c)}this.payload=f;this.status=this.UPLOADING;d.startTransmission(this.transmission,this);this.delegate.redraw()},cancelTransmission:function(){if(this.transmission){var c=xtiger.factory("upload").getInstance(this.myDoc);c.cancelTransmission(this.transmission)}},onComplete:function(c){this.status=this.COMPLETE;if(typeof(c)==="string"){this.photoUrl=c;this.resourceId=null}else{this.photoUrl=c.url;this.resourceId=c.resource_id}this.errMsg=null;this.transmission=null;this.delegate.stopEditing()},onError:function(c,d){this.status=this.ERROR;if(!d){this.photoUrl=null}this.errMsg=c;this.transmission=null;this.delegate.redraw()},onCancel:function(){this.status=this.cached[0];this.photoUrl=this.cached[1];this.resourceId=this.cached[2];this.errMsg=this.cached[3];this.transmission=null;this.delegate.redraw()}};xtiger.editor.PhotoViewer=function(d,k,j,c){var m,g,h=this;var f=this.view=xtdom.createElement(k,"div");xtdom.setAttribute(f,"id","xt-photo");xtdom.addClassName(f,"axel-lens-container");xtdom.addClassName(f,"axel-lens-containerstyle");j.appendChild(this.view);try{var l=xtiger.cross.getXHRObject();l.open("GET",d,false);l.send(null);if((l.status===200)||(l.status===0)){if(l.responseText){f.innerHTML=l.responseText}else{throw {name:"Error",message:"Photo plugin initialization failed : empty lens bundle content"}}}else{throw {name:"Error",message:"Photo plugin initialization failed : HTTP error ("+l.status+")"}}this.formular=k.getElementById("xt-photo-form");this.icon=k.getElementById("xt-photo-icon");this.infobox=k.getElementById("xt-photo-info");this.errorbox=k.getElementById("xt-photo-error");this.filemenu=k.getElementById("xt-photo-form-body");this.btnselfile=k.getElementById("xt-photo-file");this.btnupload=k.getElementById("xt-photo-save");this.btncancel=k.getElementById("xt-photo-cancel");this.dismiss=k.getElementById("xt-photo-close");m=this.formular.getAttribute("target")||"xt-photo-target";g=xtdom.createElement(k,"iframe");xtdom.setAttribute(g,"id",m);xtdom.setAttribute(g,"name",m);xtdom.setAttribute(g,"src","javascript:false;");g.style.display="none";j.appendChild(g);xtdom.addEventListener(this.btnselfile,"change",function(){h.startSelectCb()},false);xtdom.addEventListener(this.btnupload,"click",function(){h.saveCb()},false);xtdom.addEventListener(this.btncancel,"click",function(){h.cancelCb()},false);if(this.dismiss){xtdom.addEventListener(this.dismiss,"click",function(){h.wrapper.stopEditing()},false)}this.btncancel.style.display="none";this.failed=false;this.hide()}catch(i){this.view.innerHTML="<p>File Upload is not available...<br/><br/>Failed to make lens with '"+d+"'.<br/><br/>"+i.name+" : "+i.message+"</p>";this.failed=true}this.ready();this.wrapper=c};xtiger.editor.PhotoViewer.prototype={showPhoto:function(c){if(!this.failed){if(this.btnselfile.value.length>0){this.formular.reset()}this.icon.setAttribute("src",c);this.icon.style.visibility="visible";if(c===xtiger.bundles.photo.spiningWheelIconURL){this.btncancel.style.display="block"}else{this.btncancel.style.display="none"}}},hideError:function(){if(!this.failed){this.errorbox.style.display="none"}},hideMessage:function(){if(!this.failed){this.infobox.style.display="none"}},showError:function(c){if(!this.failed){this.errorbox.style.display="block";this.errorbox.firstChild.data=c}},showUplButtons:function(){if(!this.failed){this.filemenu.style.display=""}},hideUplButtons:function(){if(!this.failed){this.filemenu.style.display="none"}},hide:function(){this.view.style.display="none"},show:function(){this.view.style.display=""},showMessage:function(c){if(!this.failed){this.infobox.style.display="block";this.infobox.firstChild.data=c}},getTopDiv:function(){return this.view},ready:function(){this.showPhoto(xtiger.bundles.photo.photoIconURL);this.showMessage("You can select a file and upload it");this.hideError();this.showUplButtons();this.deactivateUpload()},complete:function(c){this.showPhoto(c);this.hideMessage();this.hideError();this.showUplButtons();this.deactivateUpload()},loading:function(){this.showPhoto(xtiger.bundles.photo.spiningWheelIconURL);this.showMessage("Wait while loading");this.hideError();this.hideUplButtons();this.deactivateUpload()},error:function(c){this.showPhoto(xtiger.bundles.photo.photoBrokenIconURL);this.showError(c);this.hideMessage();this.showUplButtons();this.activateUpload()},busy:function(){this.btncancel.style.display="none";this.icon.style.visibility="hidden";this.hideError();this.showMessage("Another upload is in progress, please wait until it finishes.");this.hideUplButtons();this.deactivateUpload()},activateUpload:function(){this.btnupload.removeAttribute("disabled")},deactivateUpload:function(){xtdom.setAttribute(this.btnupload,"disabled","true")},startSelectCb:function(){this.activateUpload();this.wrapper.onStartSelect()},saveCb:function(){if(this.btnselfile.value.length>0){this.wrapper.onStartUpload(this.formular)}},cancelCb:function(){this.wrapper.onCancelUpload()}};xtiger.editor.PhotoWrapper=function(e){this.myDoc=e;var d=xtiger.session(e).load("form");var c=(d&&d.getRoot&&d.getRoot())||e.getElementsByTagName("body")[0];this.view=new xtiger.editor.PhotoViewer(xtiger.bundles.photo.lensBoxURL,e,c,this);this.state=null};xtiger.editor.PhotoWrapper.prototype={isFocusable:function(){return false},getHandle:function(){return this.view.getTopDiv()},getData:function(){return this.state},grab:function(e,c,d){this.device=e;this.editor=e.getCurrentModel();this.state=this.editor.getData();this.state.setDelegate(this);this.redraw();this.view.show();if(d[0]>0){this.view.getTopDiv().style.padding=d[0]+"px"}},activate:function(d,c){this.device=d},stopEditing:function(){this.device.stopEditing()},release:function(){this.view.hide();this.device=null;this.state.setDelegate(this.editor);this.editor.redraw(true)},onStartSelect:function(){this.device.mouseMayLeave()},onStartUpload:function(c){this.state.startTransmission(this.myDoc,"form",c,this.editor.getParam("photo_URL"))},onCancelUpload:function(c){this.state.cancelTransmission()},redraw:function(){var c=xtiger.factory("upload").getInstance(this.myDoc);if(c.isReady()||c.isTransmitting(this.state.transmission)){switch(this.state.status){case xtiger.editor.PhotoState.prototype.READY:this.view.ready();break;case xtiger.editor.PhotoState.prototype.ERROR:this.view.error(this.state.errMsg);break;case xtiger.editor.PhotoState.prototype.UPLOADING:this.view.loading();break;case xtiger.editor.PhotoState.prototype.COMPLETE:this.view.complete(this.state.genPhotoUrl());break;default:this.view.error("Unkown Photo status "+this.state.status);break}}else{this.view.busy()}}};xtiger.factory("lens").registerWrapper("photo",function(c){return new xtiger.editor.PhotoWrapper(c)})}($axel));(function(n){var c=0;var j=1;var l=2;var f=3;var i=4;var h=5;var g={fr:[null,null,"enregistrement en cours","échec de l'enregistrement","enregistrement réussi",null]};var m={fr:["cliquez pour choisir un fichier",["cliquez sur “Enregistrer” pour sauvegarder “%” (%)","cliquez sur “Enregistrer” pour sauvegarder “%” (%)<br/>sous “%” (vous pouvez éditer le nom avant)"],"enregistrement de “%” (%) en cours","échec de l'enregistrement de “%”<br/>%",'“%” a été enregistré en tant que <a target="_blank" href="%">%</a>','cliquez pour remplacer <a target="_blank" href="%">%</a>']};function e(o){var q=$.trim(o).toLowerCase(),p=(q.lastIndexOf(".")!==-1)?q.substring(0,q.lastIndexOf(".")):q;p=p.replace(/(\s{2,}|_)/g," ");p=p.replace(/\s/g,"-");p=p.replace(/[éè]/g,"e");p=p.replace(/[^a-z0-9-_]/g,"");return p}var d={onGenerate:function(r,q,o){var p;p=xtdom.createElement(o,"span");xtdom.addClassName(p,"xt-file");$(p).html('<img class="xt-file-icon1"/><span class="xt-file-trans"/><input class="xt-file-id" type="text" value="nom"/><input class="xt-file-save" type="button" value="Enregistrer"/><span class="xt-file-perm"/><img class="xt-file-icon2"/>');r.appendChild(p);return p},onInit:function(r,o,p){var q=this.getParam("file_base");if(q&&(q.charAt(q.length-1)!=="/")){this._param.file_base=q+"/"}this.model=new a(this)},onAwake:function(){this.vIcon1=$(".xt-file-icon1",this._handle);this.vTrans=$(".xt-file-trans",this._handle);this.vPerm=$(".xt-file-perm",this._handle);this.vIcon2=$(".xt-file-icon2",this._handle);this.vSave=$(".xt-file-save",this._handle).hide();this.vId=$(".xt-file-id",this._handle).hide();this.vIcon1.bind({click:$.proxy(d.methods.onActivate,this),mouseenter:$.proxy(d.methods.onEnterIcon,this),mouseleave:$.proxy(d.methods.onLeaveIcon,this)});this.vIcon2.click($.proxy(d.methods.onDismiss,this));this.vSave.click($.proxy(d.methods.onSave,this));this.vId.change($.proxy(d.methods.onChangeId,this));$(this._handle).bind({mouseleave:function(o){$(o.currentTarget).removeClass("over")}});this.model.reset(this.getDefaultData());this.redraw(false)},onLoad:function(u,s){var r,q,o=(u!==-1)?s.getDataFor(u):this.getDefaultData();if(s.hasAttributeFor("data-input",u)){r=s.getAttributeFor("data-input",u);q=s.getDataFor(r)}this.model.reset(o,q);this.redraw(false)},onSave:function(o){var p;o.write(this._dump());if((this.model.legacy&&this.model.legacy[2])||(!this.model.legacy&&this.model.name)){p=this.model.legacy?this.model.legacy[2]:this.model.name;o.writeAttribute("data-input",p)}},api:{},methods:{getData:function(){return this.model},_dump:function(){if(this.model.legacy){return(this.model.legacy[1])?this.model.legacy[1]:""}else{return(this.model.url)?this.model.url:""}},redraw:function(q){var r=[[xtiger.bundles.file.noFileIconURL,true,null],[xtiger.bundles.file.saveIconURL,false,xtiger.bundles.file.cancelIconURL],[xtiger.bundles.file.spiningWheelIconURL,false,xtiger.bundles.file.cancelIconURL],[xtiger.bundles.file.errorIconURL,false,xtiger.bundles.file.cancelIconURL],[xtiger.bundles.file.fileIconURL,false,xtiger.bundles.file.dismissIconURL],[xtiger.bundles.file.fileIconURL,true,null]];var p;var o=r[this.model.state];var s=g.fr[this.model.state];if(j===this.model.state){if("application/pdf"===this.model.file.type){o[0]=xtiger.bundles.file.saveIconURLpdf}}else{if(this.model.state>=i){if(/\.pdf$/i.test(this.model.url)||(this.model.name&&/\.pdf$/i.test(this.model.name))){o[0]=xtiger.bundles.file.fileIconURLpdf}}}this.vIcon1.attr("src",o[0]);if((this.model.state===c)||(this.model.state===h)){this.vIcon1.addClass("xt-file-editable")}else{this.vIcon1.removeClass("xt-file-editable")}if(o[1]){p="“"+(this.model.name||"pas de fichier")+"”";this.vTrans.text(p)}else{this.vTrans.text("")}if(this.model.state===j){if(this.getParam("file_gen_name")!=="auto"){this.vId.val(this.model.name);this.onChangeId();this.vId.show()}this.vSave.show()}else{this.vSave.hide();this.vId.hide()}this.vPerm.text(s||"");this.configureHints();if(o[2]){this.vIcon2.attr("src",o[2]);this.vIcon2.removeClass("axel-core-off")}else{this.vIcon2.addClass("axel-core-off")}if((this.model.state===i)&&(q)){xtiger.editor.Repeat.autoSelectRepeatIter(this._handle)}},configureHints:function(){var o,r,q,v,u,w,s,p=m.fr[this.model.state];if(this.model.state===j){p=p[(this.getParam("file_gen_name")==="auto")?0:1]}if(p.indexOf("%")!==-1){o=[];if((this.model.state===j)||(this.model.state===l)){if(this.model.size>1024){s=this.model.size>>10;if(s>1024){w=this.model.size>>20;s=(this.model.size-(w<<20))>>10}else{w=0}q=w>=1?w+"."+s+" MB":s+" KB"}else{q=this.model.size}u=[this.model.name,q,this.vId.val()]}else{if(this.model.state===f){u=[this.model.name,this.model.err]}else{if(this.model.state===i){u=[this.model.name,this.model.genFileURL(),this.model.url]}else{u=[this.model.genFileURL(),this.model.url]}}}v=p.split("%");for(r=0;r<v.length;r++){o.push(v[r]);if(r<u.length){o.push(u[r])}}this.model.hints=o.join("")}else{this.model.hints=p}},update:function(o){},onEnterIcon:function(o){$(o.target.parentNode).addClass("over");if(this.model.hints){tooltip=xtiger.factory("tooltipdev").getInstance(this.getDocument());if(tooltip){tooltip.show(this.vIcon1,this.model.hints,(this.model.hints.indexOf("<a")!==-1))}}},onLeaveIcon:function(){tooltip=xtiger.factory("tooltipdev").getInstance(this.getDocument());if(tooltip){tooltip.hide()}},onActivate:function(o){var p;if((this.model.state===c)||(this.model.state===h)){p=xtiger.factory("fileinputsel").getInstance(this.getDocument());if(p){this.onLeaveIcon();p.showFileSelectionDialog(this)}}},doSelectFile:function(o){this.model.gotoSelected(o)},onDismiss:function(o){if(this.model.state===l){this.model.cancelTransmission()}else{if((this.model.state===j)||(this.model.state===f)){this.model.rollback((this.model.state===f))}else{if(this.model.state===i){if(this.getParam("file_reset")==="empty"){this.model.reset(this.getDefaultData());this.redraw(false)}else{this.model.gotoReady()}}}}},onChangeId:function(){this.vId.val(e(this.vId.val()));this.vId.attr("size",this.vId.val().length+2);this.configureHints();this.vId.blur()},onSave:function(o){this.model.gotoLoading()}}};n.plugin.register("file",{filterable:true,optional:true},{file_URL:"/fileUpload",file_type:"application/pdf",file_type_message:"Vous devez sélectionner un fichier PDF",file_gen_name:"auto"},d);xtiger.resources.addBundle("file",{noFileIconURL:"nofile32.png",saveIconURL:"blank32.png",saveIconURLpdf:"save32.png",spiningWheelIconURL:"spiningwheel.gif",errorIconURL:"bug48.png",dismissIconURL:"ok16.png",cancelIconURL:"cancel32.png",fileIconURL:"file32.png",fileIconURLpdf:"pdf32.png"});var k=function(o){this.selector=xtdom.createElement(o,"input");$(this.selector).attr({id:"xt-file-input",type:"file"}).change($.proxy(k.prototype.onChange,this));$("body",o).append(this.selector)};k.prototype={showFileSelectionDialog:function(o){this.delegate=o;this.selector.click()},onChange:function(p){var o=(p.target.files.length>0)?p.target.files[0]:null;var q=this.delegate.getParam("file_type");if(o){if(o.type&&q.indexOf(o.type)!==-1){if(this.delegate){this.delegate.doSelectFile(o)}}else{alert(this.delegate.getParam("file_type_message"))}}}};xtiger.registry.registerFactory("fileinputsel",{getInstance:function(p){var o=xtiger.session(p).load("fileinputsel");if(!o){o=new k(p);xtiger.session(p).save("fileinputsel",o)}return o}});var b=function(p){var o=xtdom.createElement(p,"p");$(o).attr("id","xt-tooltip");$("body",p).append(o);this.tooltip=$(o);this.tooltip.mouseleave($.proxy(b.prototype.onLeaveTooltip,this));this.tooltip.mouseenter($.proxy(b.prototype.onEnterTooltip,this));this.doHideCb=$.proxy(b.prototype.doHide,this)};b.prototype={show:function(o,q,p){var s,r;this.tooltip.html(q);s=$(o).offset();r=this.tooltip.height()+$(o).height();this.tooltip.css({left:s.left,top:(s.top-r)}).show();this.isInside=true;this.isSticky=true},hide:function(){this.isInside=false;setTimeout(this.doHideCb,500)},doHide:function(){if(!this.isInside||!this.isSticky){this.tooltip.hide();this.inhibated=true}},onLeaveTooltip:function(o){if(this.isInside&&this.isSticky){this.isInside=false;this.tooltip.hide()}},onEnterTooltip:function(o){this.isInside=true}};xtiger.registry.registerFactory("tooltipdev",{getInstance:function(p){var o=xtiger.session(p).load("tooltipdev");if(!o){o=new b(p);xtiger.session(p).save("tooltipdev",o)}return o}});function a(o){this.state=h;this.url=null;this.name=null;this.file=null;this.delegate=o;this.legacy=null;this.preflighting=false}a.prototype={reset:function(p,o){if(p&&(p.search(/\S/)!==-1)){this.state=h;this.url=p;this.name=o}else{this.state=c;this.url=this.name=null}},genFileURL:function(){var o=this.delegate.getParam("file_base");return(o?o+this.url:this.url)},getPayload:function(){var p,o={"xt-file":this.file,"xt-mime-type":this.file.type};if(this.preflighting){o["xt-file-id"]=this.delegate.vId.val();this.preflighting=false}return o},getPreflightOptions:function(){return{"xt-file-preflight":this.delegate.vId.val(),"xt-mime-type":this.file.type}},rollback:function(o){if(o&&(this.preflighting)){this.state=j}else{if(this.legacy){this.state=this.legacy[0];this.url=this.legacy[1];this.name=this.legacy[2];this.legacy=null}}this.preflighting=false;this.delegate.redraw()},gotoSelected:function(o){this.legacy=[this.state,this.url,this.name];this.state=j;this.url=null;this.name=o.name;this.size=o.size;this.file=o;this.delegate.redraw()},gotoLoading:function(){var o=xtiger.factory("upload").getInstance(this.delegate.getDocument());if(o&&o.isReady()){this.state=l;if(this.preflighting||(this.delegate.getParam("file_gen_name")==="auto")){this.startTransmission(o,o.getUploader())}else{this.preflighting=true;this.startPreflight(o,o.getUploader())}this.delegate.redraw()}else{alert("D'autre(s) téléchargement(s) sont en cours, attendez qu'ils se terminent ou bien annulez en un pour pouvoir démarrer un nouveau téléchargement")}},gotoComplete:function(o){this.legacy=null;this.url=o;this.state=i;this.delegate.redraw(true);this.delegate.update(o)},gotoError:function(){this.state=f;this.delegate.redraw()},gotoReady:function(){this.state=h;this.delegate.redraw()},getDocumentId:function(){return xtiger.session(this.delegate.getDocument()).load("documentId")},startTransmission:function(o,p){this.transmission=p;this.transmission.setDataType("formdata");this.transmission.setAction(this.delegate.getParam("file_URL"));o.startTransmission(this.transmission,this)},startPreflight:function(o,p){this.transmission=p;this.transmission.setDataType("formdata");this.transmission.setAction(this.delegate.getParam("file_URL"));o.startPreflight(this.transmission,this)},cancelTransmission:function(){if(this.transmission){var o=xtiger.factory("upload").getInstance(this.delegate.getDocument());o.cancelTransmission(this.transmission)}},onComplete:function(o){if(this.preflighting){this.gotoLoading()}else{this.gotoComplete($.trim(o));this.transmission=null}},onError:function(o,p){this.err=o;this.gotoError();this.transmission=null},onCancel:function(){this.preflighting=false;this.transmission=null;if(this.legacy){this.rollback()}else{this.reset();this.delegate.redraw()}}}}($axel));(function($axel){var _Editor={onGenerate:function(aContainer,aXTUse,aDocument){var _h=xtdom.createElement(aDocument,"span");xtdom.addClassName(_h,"axel-core-on");xtdom.addClassName(_h,"axel-core-editable");xtdom.addClassName(_h,"axel-link-handle");_h.appendChild(xtdom.createTextNode(aDocument,""));aContainer.appendChild(_h);return _h},onInit:function(aDefaultData,anOptionAttr,aRepeater){var devname=this.getParam("device")||this.getParam("defaultDevice");if(aDefaultData&&aDefaultData.text&&aDefaultData.url){this._setData(aDefaultData.text,aDefaultData.url)}else{this._setData("empty","http://")}this._device=xtiger.factory(devname).getInstance(this.getDocument())},onAwake:function(){var _this=this;xtdom.addEventListener(this._handle,this.getParam("trigger"),function(ev){_this.startEditing(ev)},true)},onLoad:function(aPoint,aDataSrc){var _default,_url=aDataSrc.getDataFor(aDataSrc.getVectorFor("linkRef",aPoint)),_text=aDataSrc.getDataFor(aDataSrc.getVectorFor("linkText",aPoint));this._setData(_text,_url);if(this.isOptional()){if(_url||_text){this.set()}else{this.unset()}}_default=this.getDefaultData();this.setModified((_text&&_text!==_default.text)||(_url&&_url!==_default.url))},onSave:function(aLogger){if(this.isOptional()&&!this.isSet()){aLogger.discardNodeIfEmpty();return}var _data=this.getData();aLogger.openTag(this.getParam("linkRefTagName"));aLogger.write(_data.url);aLogger.closeTag(this.getParam("linkRefTagName"));aLogger.openTag(this.getParam("linkTextTagName"));aLogger.write(_data.text);aLogger.closeTag(this.getParam("linkTextTagName"))},api:{_parseFromTemplate:function(aXTNode){var tmp;this._param={};xtiger.util.decodeParameters(aXTNode.getAttribute("param"),this._param);tmp=aXTNode.getAttribute("option");this._option=tmp?tmp.toLowerCase():null;var _aXTContent=aXTNode.childNodes;switch(_aXTContent.length){case 2:if(_aXTContent[0].nodeType==xtdom.ELEMENT_NODE&&_aXTContent[1].nodeType==xtdom.ELEMENT_NODE&&_aXTContent[0].nodeName=="linkText"&&_aXTContent[1].nodeName=="linkRef"){this._content={text:_aXTContent[0].nodeValue,url:_aXTContent[1].nodeValue}}break;case 1:if(_aXTContent[0].nodeType==xtdom.ELEMENT_NODE&&(/^a$/i).test(_aXTContent[0].nodeName)){this._content={text:_aXTContent[0].firstChild.nodeValue,url:_aXTContent[0].getAttribute("href")}}else{if(_aXTContent[0].nodeType==xtdom.TEXT_NODE){this._content={text:_aXTContent[0].nodeValue,url:"http://"}}}break;default:this._content={text:this.getParam("defaultText"),url:this.getParam("defaultUrl")}}},isFocusable:function(){return true},focus:function(){this.startEditing()},unfocus:function(){this.stopEditing()}},methods:{_setData:function(aText,aUrl){var _default;if(!aText||!aUrl){_default=this.getDefaultData();this._data={text:aText||_default.text,url:aUrl||_default.url}}else{this._data={text:aText,url:aUrl}}this._handle.firstChild.data=this._data.text},getData:function(){return this._data},update:function(aData){if(aData&&(aData.text!==this._data.text||aData.url!==this._data.url)){if(!(aData.text||aData.url)){this.clear(true)}else{this._setData(aData.text,aData.url);this.setModified(true);this.set(true)}}},clear:function(doPropagate){var tmp=this.getDefaultData();this._setData(tmp.text,tmp.url);this.setModified(false);if(this.isOptional()&&this.isSet()){this.unset(doPropagate)}},startEditing:function(aEvent){var _doSelect=!this.isModified()||(aEvent&&aEvent.shiftKey);this._device.startEditing(this,"linkLensWrapper",_doSelect);if(aEvent){xtdom.stopPropagation(aEvent)}},stopEditing:function(){this._device.stopEditing()}}};$axel.plugin.register("link",{filterable:true,optional:true},{defaultText:"enter link's text here",defaultUrl:"http://",defaultDevice:"lens",wrapper:"togglewrapper",linkRefTagName:"linkRef",linkTextTagName:"linkText",trigger:"click",padding:"10"},_Editor);xtiger.resources.addBundle("link",{gotoURL:"goto.png"});var _LinkLensWrapper=function(aDocument){this._handle;this._handleToRestore;this._document=aDocument;this._isFocused=false;this._build()};_LinkLensWrapper.prototype={_build:function(){this._topDiv=xtdom.createElement(this._document,"div");xtdom.addClassName(this._topDiv,"axel-lens-container");xtdom.addClassName(this._topDiv,"axel-lens-containerstyle");this._topDiv.style.display="block";this._upperP=xtdom.createElement(this._document,"p");with(this._upperP){style.margin="0 0 15px 0";style.padding="0px";style.width="100%"}this._anchorInput=xtdom.createElement(this._document,"input");with(this._anchorInput){type="text"}xtdom.addClassName(this._anchorInput,"axel-link-handle");this._upperP.appendChild(this._anchorInput);this._topDiv.appendChild(this._upperP);this._lowerP=xtdom.createElement(this._document,"p");with(this._lowerP){style.margin="0px";style.padding="0px";style.width="100%"}this._urlInput=xtdom.createElement(this._document,"input");with(this._urlInput){style.width="75%"}this._goButtonLink=xtdom.createElement(this._document,"a");with(this._goButtonLink){href="";target="_blank";style.margin="0 10px";style.width="25%"}this._goButton=xtdom.createElement(this._document,"img");with(this._goButton){src=xtiger.bundles.link.gotoURL;style.height="20px";style.width="30px";style.display="inline";style.verticalAlign="bottom"}this._goButtonLink.appendChild(this._goButton);this._lowerP.appendChild(this._urlInput);this._lowerP.appendChild(this._goButtonLink);this._topDiv.appendChild(this._lowerP)},_setData:function(aText,aUrl){if(aText&&typeof(aText)==="string"){this._anchorInput.value=aText}if(aUrl&&typeof(aUrl)==="string"){this._urlInput.value=aUrl;this._goButtonLink.href=aUrl}},getHandle:function(){return this._topDiv},grab:function(aDevice,aDoSelect,aPadding){this._currentDevice=aDevice;var _data=this._currentDevice.getCurrentModel().getData();this._setData(_data.text,_data.url);var _handle=this._currentDevice.getCurrentModel().getHandle();this._topDiv.style.padding=aPadding[0]+"px "+aPadding[1]+"px";var _this=this;xtdom.addEventListener(this._anchorInput,"focus",function(ev){_this.onFocus(ev)},false);xtdom.addEventListener(this._urlInput,"focus",function(ev){_this.onFocus(ev)},false);xtdom.addEventListener(this._anchorInput,"blur",function(ev){_this.onBlur(ev)},false);xtdom.addEventListener(this._urlInput,"blur",function(ev){_this.onBlur(ev)},false);return[aPadding[0],aPadding[1]+4]},activate:function(aDevice,doSelectAll){if(doSelectAll){xtdom.focusAndSelect(this._anchorInput)}else{this._anchorInput.focus()}},release:function(){this._isFocused=false;xtdom.removeElement(this._topDiv);this._currentDevice=null},toggleField:function(){if(this._isFocused){if(this._focusedField==this._anchorInput){this._anchorInput.blur();xtdom.focusAndMoveCaretTo(this._urlInput,this._urlInput.value.length)}else{this._urlInput.blur();xtdom.focusAndMoveCaretTo(this._anchorInput,this._anchorInput.value.length)}}},getData:function(){return{url:this._urlInput.value,text:this._anchorInput.value}},isFocusable:function(){return true},onBlur:function(ev){var _target=xtdom.getEventTarget(ev);if(_target==this._urlInput){this._goButtonLink.href=this._urlInput.value}this._isFocused=false;this._focusedField=null;this._currentDevice.keepAlive(false)},onFocus:function(ev){this._isFocused=true;this._currentDevice.keepAlive(true);this._focusedField=xtdom.getEventTarget(ev)}};xtiger.factory("lens").registerWrapper("linkLensWrapper",function(aDocument){return new _LinkLensWrapper(aDocument)})}($axel));(function($axel){var _Editor={onGenerate:function(aContainer,aXTUse,aDocument){var _width,_height,_img,_tmp,_h=xtdom.createElement(aDocument,"div");xtdom.addClassName(_h,"axel-core-on");xtdom.addClassName(_h,"axel-core-editable");_img=xtdom.createElement(aDocument,"img");_img.src=xtiger.bundles.video.tvIconURL;_h.appendChild(_img);_tmp=xtdom.createElement(aDocument,"div");_tmp.style.visibility="hidden";aDocument.getElementsByTagName("body")[0].appendChild(_tmp);_tmp.appendChild(_h);_width=_img.offsetWidth;_height=_img.offsetHeight;_h.style.width=(_width>2?_width:80)+"px";_h.style.height=(_height>2?_height:80)+"px";aContainer.appendChild(_h);xtdom.removeElement(_tmp);return _h},onInit:function(aDefaultData,anOptionAttr,aRepeater){if(aDefaultData){if(this._isValidUrl(aDefaultData)||this._isCodeSnippet(aDefaultData)){this._setData(aDefaultData)}else{this._data="";this._param.inputFieldMessage=aDefaultData}}var devname=this.getParam("device")||this.getParam("defaultDevice");this._device=xtiger.factory(devname).getInstance(this.getDocument());this._noData=this._handle.firstChild},onAwake:function(){var _this=this;xtdom.addEventListener(this._handle,"mouseover",function(ev){_this.startEditing(ev)},true)},onLoad:function(aPoint,aDataSrc){if(aPoint!==-1){var _value=aDataSrc.getDataFor(aPoint);this._setData(_value)||this.clear();this.set(false)}else{this.clear();this.unset(false)}},onSave:function(aLogger){if(this.isOptional()&&!this.isSet()){aLogger.discardNodeIfEmpty()}if(this._data){aLogger.write(this._data)}},api:{_parseFromTemplate:function(aXTNode){var tmp,_cur,_data;this._param={};xtiger.util.decodeParameters(aXTNode.getAttribute("param"),this._param);tmp=aXTNode.getAttribute("option");this._option=tmp?tmp.toLowerCase():null;_cur=aXTNode.firstChild;while(_cur&&!_data){switch(_cur.nodeType){case xtdom.TEXT_NODE:if((/\w+/).test(_cur.nodeValue)){_data=_cur.nodeValue}break;case xtdom.ELEMENT_NODE:if(_cur.localName="object"){_data=_cur}}_cur=_cur.nextSibling}this._content=_data},isFocusable:function(){return true},focus:function(){this.startEditing()},unfocus:function(){this._device.stopEditing()}},methods:{_isValidUrl:function(aInput){var _URL_R=/^(http\:\/\/|~\/|\/)?(\w+:\w+@)?(([-\w\d{1-3}]+\.)+(com|org|net|gov|mil|biz|info|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2})?)(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:[\?&](?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)?(?:&)?$/;return _URL_R.test(aInput)},_removeLTSpaces:function(aInput){if(!aInput||aInput==""){return""}return aInput.replace(/^\s+|\s+$/g,"")},_buildYoutubeSnippet:function(aVideoID,aSize,aParams){var _params=aParams?aParams:{};_params.movie=aVideoID;if(!_params.allowFullScreen){_params.allowFullScreen="true"}if(!_params.alloscriptaccess){_params.alloscriptaccess="always"}var _obj=xtdom.createElement(this._document,"object");if(aSize){_obj.height=aSize[0];_obj.width=aSize[1]}else{_obj.height=this.getParam("height");_obj.width=this.getParam("width")}_obj.style.zIndex=1000;for(var _param in _params){var _p=xtdom.createElement(this._document,"param");_p.name=_param;_p.value=_params[_param];_obj.appendChild(_p)}var _embed=xtdom.createElement(this._document,"embed");xtdom.setAttribute(_embed,"src",aVideoID);xtdom.setAttribute(_embed,"type","application/x-shockwave-flash");xtdom.setAttribute(_embed,"allowfullscreen","true");xtdom.setAttribute(_embed,"allowscriptaccess","always");xtdom.setAttribute(_embed,"width",this.getParam("width"));xtdom.setAttribute(_embed,"height",this.getParam("height"));_embed.style.zIndex=1000;if(xtiger.cross.UA.IE){_obj=_embed}else{_obj.appendChild(_embed)}return _obj},_extractVideoId:function(aValidUrl){var _tmp=aValidUrl.match(/^[^&]*/)[0];return _tmp.match(/[^\=\/]*$/)[0]},_isCodeSnippet:function(aInput){var _SNIPPET_O_R=/(<object>).*(<param[^>]*(name\="movie"))/;var _SNIPPET_E_R=/(<embed\s)([^>]+)(\ssrc\=")([^"]+)"/;return _SNIPPET_O_R.test(aInput)||_SNIPPET_E_R.test(aInput)},_setData:function(aData){var _newContent,_tmp,_type="youtube",_tdata=this._removeLTSpaces(aData);if(!this._isValidUrl(_tdata)){if(this._isCodeSnippet(_tdata)){_tdata=this._extractUrlFromSnippet(_tdata)}else{return false}}switch(_type){case"youtube":var _videoID=this._extractVideoId(_tdata);var _newdata="http://www.youtube.com/v/"+_videoID;if(this._data===_newdata){return false}this._data=_newdata;_newdata+="&hl="+this.getParam("lang")+"&fs=1&";_newContent=this._buildYoutubeSnippet(this._data,null,null);try{_tmp=xtdom.createElement(this._document,"div");_tmp.style.visibility="hidden";this._document.getElementsByTagName("body")[0].appendChild(_tmp);_tmp.appendChild(_newContent);with(this._handle.style){width=this.getParam("width")+"px";height=this.getParam("height")+"px"}this._handle.replaceChild(_newContent,this._handle.firstChild);this.setModified(true);xtdom.removeElement(_tmp)}catch(err){xtiger.cross.log("warning",err);return false}break;default:xtiger.cross.log("warning","Video type "+type+" is currently unsupported");return false}return true},update:function(aData){var _success=false;if(aData&&(typeof(aData)=="string")&&(aData.search(/\S/)!=-1)){_success=(aData===this._data)||this._setData(aData)}if(_success){this.set(true)}},clear:function(){this._data="";this.setModified(false);this._handle.replaceChild(this._noData,this._handle.firstChild);var _width=this._noData.offsetWidth;var _height=this._noData.offsetHeight;with(this._handle.style){width=(_width>2?_width:80)+"px";height=(_height>2?_height:80)+"px"}},getData:function(){if(this._data&&this._data!==""){return this._data}else{return null}},startEditing:function(aEvent){var _doSelect=!this.isModified()||(aEvent&&aEvent.shiftKey);this._device.startEditing(this,"videoLensWrapper",_doSelect)},stopEditing:function(){this._device.stopEditing()}}};$axel.plugin.register("video",{filterable:true,optional:true},{defaultDevice:"lens",trigger:"mouseover",lang:"fr_FR",inputFieldMessage:"Paste the video's link here",width:425,height:344},_Editor);xtiger.resources.addBundle("video",{tvIconURL:"tv.png"});var _VideoLensWrapper=function(aDocument){this._handle;this._handleToRestore;this._document=aDocument;this._isFocused=false;this._loaded=false;this.build()};_VideoLensWrapper.prototype={build:function(){this._topdiv=xtdom.createElement(this._document,"div");xtdom.addClassName(this._topdiv,"axel-lens-container");with(this._topdiv){style.display="none";style.minWidth="200px"}var _innerHTML="";_innerHTML+='<div style="background: none; position: relative"> </div>';_innerHTML+='<div class="axel-lens-containerstyle" style="width: 410px; padding: 5px; position: relative">';_innerHTML+='<p style="';_innerHTML+="display: none; font-size: 7pt; cursor: pointer; ";_innerHTML+="text-decoration:underline; text-align: right; margin: 0;";_innerHTML+='">delete</p>';_innerHTML+="<div>";_innerHTML+='<label for="videolensinput" style="display: block">Paste url here</label>';_innerHTML+='<input type="text" name="videolensinput" value="" style="width: 90%"></input>';_innerHTML+="</div>";_innerHTML+='<div style="text-align: center">';_innerHTML+="<button>Cancel</button>";_innerHTML+="<button>Save</button>";_innerHTML+="</div></div>";this._topdiv.innerHTML=_innerHTML;this._maskdiv=this._topdiv.firstChild;this._contentdiv=this._maskdiv.nextSibling;this._deletespan=this._contentdiv.firstChild;this._inputdiv=this._deletespan.nextSibling;this._input=this._inputdiv.firstChild.nextSibling;this._buttondiv=this._inputdiv.nextSibling;this._cancelbutton=this._buttondiv.firstChild;this._savebutton=this._buttondiv.firstChild.nextSibling;var _this=this;this._handlers={clearModel:[this._deletespan,"click",function(ev){_this.clearModel()}],onInputBlur:[this._input,"blur",function(ev){_this._onInputBlur(ev)}],onInputFocus:[this._input,"focus",function(ev){_this._onInputFocus(ev)}],onInputKeyDown:[this._input,"keydown",function(ev){_this._onInputKeyDown(ev)}],onInputKeyUp:[this._input,"keyup",function(ev){_this._onInputKeyUp(ev)}],onCancel:[this._cancelbutton,"click",function(ev){_this._onCancel(ev)}],onSave:[this._savebutton,"click",function(ev){_this._onSave(ev)}]}},grab:function(aDevice,aDoSelect,aPadding){if(this._currentDevice){this.release()}this._currentDevice=aDevice;var _handle=this._currentDevice.getCurrentModel().getHandle();_pad=(aPadding[0]>=10)?aPadding[0]:10;var _width=_handle.offsetWidth;var _height=_handle.offsetHeight;if(xtiger.cross.UA.IE){_width+=2*_pad;_height+=2*_pad}with(this._topdiv.style){display="block";width=_width+"px";padding=_pad+"px"}with(this._maskdiv.style){border=""+_pad+"px solid rgb(115, 166, 42)";width=_width+"px";height=_height+"px";if(!xtiger.cross.UA.IE){left="-"+_pad+"px";top="-"+_pad+"px"}}with(this._contentdiv.style){if(!xtiger.cross.UA.IE){left="-"+_pad+"px";top="-"+_pad+"px"}}this._cancelbutton.disabled=false;this._savebutton.disabled=true;if(this._currentDevice.getCurrentModel().isModified()){this.setData(this._currentDevice.getCurrentModel().getData());this._deletespan.style.display="block";this._loaded=true}else{var _message=this._currentDevice.getCurrentModel().getParam("inputFieldMessage");this.setData(_message);this._loaded=false}for(var k in this._handlers){xtdom.addEventListener(this._handlers[k][0],this._handlers[k][1],this._handlers[k][2],true)}},activate:function(aDevice,doSelectAll){},release:function(){if(!this._currentDevice){return}for(var k in this._handlers){xtdom.removeEventListener(this._handlers[k][0],this._handlers[k][1],this._handlers[k][2],true)}this._deletespan.style.display="none";this._currentDevice=null;xtdom.removeElement(this._topdiv)},getHandle:function(){return this._topdiv},getData:function(){return this._input.value},setData:function(aData){this._input.value=(aData&&typeof(aData)=="string")?aData:""},isFocusable:function(){return true},clearModel:function(){if(this._currentDevice){this._input.value="";this._currentDevice.getCurrentModel().clear();this._currentDevice.keepAlive(false);this._currentDevice.getCurrentModel().unfocus()}},toggleField:function(){},_onInputBlur:function(ev){this._currentDevice.keepAlive(false)},_onInputFocus:function(ev){if(this._loaded){var _aStartPos=0;var _aEndPos=this._input.value.length;if(this._input.setSelectionRange){this._input.setSelectionRange(_aStartPos,_aEndPos)}else{if(this._input.createTextRange){var oRange=this._input.createTextRange();oRange.moveStart("character",_aStartPos);oRange.moveEnd("character",_aEndPos);oRange.select()}}}else{this._input.value=""}this._currentDevice.keepAlive(true)},_onInputKeyDown:function(ev){this._savedValue=this._input.value},_onInputKeyUp:function(ev){if(this._input.value!=this._savedValue){this._cancelbutton.disabled=false;this._savebutton.disabled=false}},_onCancel:function(ev){if(!this._currentDevice){return}this._currentDevice.cancelEditing();xtdom.stopPropagation(ev)},_onSave:function(ev){if(!this._currentDevice){return}this._currentDevice.stopEditing();xtdom.stopPropagation(ev)}};xtiger.factory("lens").registerWrapper("videoLensWrapper",function(aDocument){return new _VideoLensWrapper(aDocument)})}($axel));(function(a){var b={methods:{update:function(c){this.__event__update(c);$(this.getHandle()).trigger({type:"axel-update",value:c},this)}}};a.filter.register("event",{chain:["update"]},null,b);a.filter.applyTo({event:["text","file"]})}($axel));(function(a){var b={onSave:function(c){if(this.isModified()){this.__optional__onSave(c)}else{c.discardNodeIfEmpty()}}};a.filter.register("optional",{chain:["onSave"]},null,b);a.filter.applyTo({optional:"text"})}($axel));(function(k){var h=function h(p,m,o){var l="trackerdevice";var n=xtiger.session(p).load(l);if((!n)&&(!o)){n=new xtiger.editor.TrackerMenu(p,[{zoomout:["---",m.zoomOut],zoomin:["+++",m.zoomIn]}]);xtiger.session(p).save(l,n)}return n};function g(n,r,l,m){var p=n.getHandle(),q=xtdom.createElement(n.getDocument(),"img"),o;if(n.image_resizable){$("img",p).unbind("mouseenter")}xtdom.removeChildrenOf(p);if((l!==undefined)||(m!==undefined)){$(q).one("load",[p,l,m],b)}if(r.substr(0,5)!=="http:"){o=n.getParam("base")}xtdom.setAttribute(q,"src",o?o+r:r);xtdom.setAttribute(q,"alt","image "+r);p.appendChild(q);if(n.image_maxWidth!==undefined){$(q).css("max-width",n.image_maxWidth)}if(n.image_maxHeight!==undefined){$(q).css("max-height",n.image_maxHeight)}if(n.image_resizable){$(q).bind("mouseenter",n,a)}}function b(n){var o=n.data[0],p=$("img",o),l=n.data[1],m=n.data[2];if(l&&(!isNaN(l))&&(l>0)){p.width(l)}if(m&&(!isNaN(m))&&(m>0)){p.height(m)}$(o).width(p.width())}function f(n){var l;var m=n.getHandle();var o=n.getParam("base");var p=m.firstChild;if(p.nodeType!==xtdom.TEXT_NODE){l=p.getAttribute("src")}else{l=p.data}return(o&&(l.indexOf(o)!==-1))?l.substr(o.length,l.length):l}function c(o){var l,n=undefined;if((typeof o)==="string"){l=o.match(/\d+/);if(l){n=parseInt(l[0])}}return n}function j(l){var m;if(l.dataTransfer.types.contains){m=l.dataTransfer.types.contains("text/uri-list")}else{m=($.inArray("text/uri-list",l.dataTransfer.types)!==-1)}if(m){l.dataTransfer.dropEffect=xtiger.cross.UA.webKit?"copy":"link";xtdom.preventDefault(l);xtdom.stopPropagation(l)}}function i(l){l.dataTransfer.dropEffect=xtiger.cross.UA.webKit?"copy":"link";xtdom.preventDefault(l);xtdom.stopPropagation(l)}function e(n){var o=false;var l=n.target.xttPrimitiveEditor||n.target.parentNode.xttPrimitiveEditor;if(l){var m=n.dataTransfer.getData("URL");if(!m){m=n.dataTransfer.getData("text/plain")}if(m&&(m.search(/(png|jpg|jpeg|gif)$/i)!==-1)){l.update(m)}else{xtiger.cross.log("warning","Not a supported image link (must end with png, jpg, jpeg or gif) !\n")}}xtdom.stopPropagation(n);xtdom.preventDefault(n)}function a(r){var l,p,q={},o;var m=r.data,n=h(m.getDocument(),m);if(!n.isTracking()){l=$(this).width();p=$(this).height();if(m.image_minWidth&&m.image_minHeight){q.zoomout=(l>m.image_minWidth)&&(p>m.image_minHeight)}else{if(m.image_minWidth){q.zoomout=(l>m.image_minWidth)}else{if(m.image_minHeight){q.zoomout=(p>m.image_minHeight)}else{q.zoomout=false}}}if(m.image_maxWidth&&m.image_maxHeight){q.zoomin=(l<m.image_maxWidth)&&(p<m.image_maxHeight)}else{if(m.image_maxWidth){q.zoomin=(l<m.image_maxWidth)}else{if(m.image_maxHeight){q.zoomin=(p<m.image_maxHeight)}else{q.zoomin=false}}}n.startEditing(m,this,q)}}var d={onAwake:function(){var m;this.__image__onAwake();var l=this.getHandle();xtdom.addEventListener(l,"dragenter",j,false);xtdom.addEventListener(l,"dragover",i,false);xtdom.addEventListener(l,"drop",e,true);this.image_maxWidth=c(this.getParam("image_maxwidth"));this.image_maxHeight=c(this.getParam("image_maxheight"));this.image_minWidth=c(this.getParam("image_minwidth"));this.image_minHeight=c(this.getParam("image_minheight"));this.image_resizable=this.image_maxWidth||this.image_maxHeight||this.image_minWidth||this.image_minHeight},onLoad:function(l,o){var r,q=this.getParam("image-tag")||"Source",m,p;var s=l[0];if(this.getParam("image_lang")==="html"){s=l[1];q="src"}if(s&&xtdom.hasAttribute(s,q)){r=s.getAttribute(q)}if((!r)||(r.search(/(png|jpg|jpeg|gif)$/i)===-1)){this.__image__onLoad(l,o)}else{if(this.image_resizable){m=parseInt(s.getAttribute("width"));p=parseInt(s.getAttribute("height"));g(this,r,m,p)}else{g(this,r)}this._data=r;this.setModified(true);this.set(false)}},onSave:function(m){var q=f(this),n=(this.getParam("image_lang")==="html"),p=this.getParam("image-tag")||"Source",o,l;if(n){m.openTag("img");p="src"}m.openAttribute(p);m.write(q);m.closeAttribute(p);if(this.image_resizable){o=this.getHandle();l=$("img",o);if(l){m.openAttribute("width");m.write($(l).width());m.closeAttribute("width");m.openAttribute("height");m.write($(l).height());m.closeAttribute("height")}}if(n){m.closeTag("img")}},methods:{getData:function(){return f(this)},_setData:function(l){if(l.search&&(l.search(/(png|jpg|jpeg|gif)$/i)!==-1)){g(this,l);this._data=l}else{var n=this.getHandle();if(n.firstChild.nodeType!==xtdom.TEXT_NODE){xtdom.removeChildrenOf(n);var m=xtdom.createTextNode(this.getDocument(),"");n.appendChild(m)}this.__image___setData(l)}},update:function(l){if((l.search(/\S/)!==-1)&&(l!==this.getDefaultData())&&(l.search(/(png|jpg|jpeg|gif)$/i)===-1)){this.__image__update("Not a supported image file (must end with png, jpg, jpeg or gif)")}else{this.__image__update(l)}},startEditing:function(l){var m;if(this.image_resizable){m=h(this.getDocument(),this,true);if(m){m.stopEditing()}}this.__image__startEditing(l)},zoomIn:function(){var o=this.getHandle(),r=$("img",o),l,n,q,m,p;if(r.size()>0){l=r.width();n=r.height();q=this.image_maxWidth?this.image_maxWidth/l:undefined;m=this.image_maxHeight?this.image_maxHeight/n:undefined;p=q?(m?(m>q?q:m):q):m;if(p){if(p>1){if(p>1.1){p=1.1}else{h(this.getDocument(),this,true).disable("zoomin")}r.width(l*p).height(n*p);$(o).width(l*p).height(n*p);h(this.getDocument(),this,true).enable("zoomout")}else{h(this.getDocument(),this,true).disable("zoomin")}}}},zoomOut:function(){var o=this.getHandle(),r=$("img",o),l,n,q,m,p;if(r.size()>0){l=r.width();n=r.height();q=this.image_minWidth?this.image_minWidth/l:undefined;m=this.image_minHeight?this.image_minHeight/n:undefined;p=q?(m?(m>q?m:q):q):m;if(p){if(p<1){if(p<0.9){p=0.9}else{h(this.getDocument(),this,true).disable("zoomout")}r.width(l*p).height(n*p);$(o).width(l*p).height(n*p);h(this.getDocument(),this,true).enable("zoomin")}else{h(this.getDocument(),this,true).disable("zoomout")}}}}}};k.filter.register("image",{chain:["onAwake","onLoad","update","_setData","startEditing"]},{image_tag:"Source",image_lang:"default",base:undefined,image_maxWidth:undefined,image_maxHeight:undefined,image_minWidth:undefined,image_minHeigth:undefined},d);k.filter.applyTo({image:"text"})}($axel));(function(e){var s="\\*|'|_";var w=new RegExp("(http://[\\.\\w/\\-\\?\\=_&;#]*)\\[([^\\]]*)\\]|("+s+"){2}(.*?)\\3{2}|(#[\\.\\w/\\-_]*)\\[([^\\]]*)\\]|==(.*?)==\\((.*?)\\)","g");var g=new RegExp("^(mailto|http|https):?(//)?","i");var b=new RegExp("^(\\w+\\.)+[a-z]+(.*?)$","i");var E={important:"strong",emphasize:"em",verbatim:"tt"};var u={strong:"important",em:"emphasize",tt:"verbatim",STRONG:"important",EM:"verbatim",TT:"verbatim"};var v={"*":"strong",_:"em","'":"tt"};var r={"*":"important",_:"emphasize","'":"verbatim"};var k={strong:"**",em:"__",tt:"''",STRONG:"**",EM:"__",TT:"''"};var j={important:"**",emphasize:"__",verbatim:"''"};var n=function n(F){return F};var c=function c(H,I){var G,M,J,L,K;var F=g.exec(H);if(F){if(F[0].length==H.length){if(F[1].toLowerCase()=="mailto"){G=H+((H.indexOf(":")!=-1)?"":":")+I}else{G=H+((H.indexOf(":")!=-1)?"//":"://")+I}M=F[1]}else{G=H}}else{if(H.charAt(0)=="/"){G=n(H);J=true;M=H}else{if(H.indexOf("@")!=-1){G="mailto:"+H;M=H}else{if(b.test(H)){G="http://"+H;M=H}else{G=n(H);J=true;M=H}}}}L=M?"data-input ='"+M+"' ":"";K=J?"data-rewritten ='1' ":"";return"<a href='"+G+"' "+L+K+"target='_blank'>"+I+"</a>"};var C=function C(O,G,K,L,F,P,N,M,J,I){var S,Q,H,R;if(G){return c(G,K)}else{if(P){return c(P,N)}else{if(J){return c(J,M)}else{if(L){if(I!=="span"){S=v[L];return"<"+S+">"+F+"</"+S+">"}else{Q=r[L];return'<span class="'+Q+'">'+F+"</span>"}}}}}};var x=function(F){return function(N,H,J,K,G,O,M,L,I){return C(N,H,J,K,G,O,M,L,I,F)}};var h=function h(F){var H=[];var J=F.childNodes;var G,I;for(G=0;G<J.length;G++){I=J.item(G);if(I.nodeType==xtdom.ELEMENT_NODE){H.push(I)}}return H};var y=function y(G,H,F){if(H&&(H.search(/\S/)!=-1)){if(G.lastChild&&(G.lastChild.nodeType===xtdom.TEXT_NODE)){G.lastChild.appendData(H)}else{G.appendChild(xtdom.createTextNode(F,H))}}};var o=function o(H,G,I,F){var L,M,N,J,K=H;if(F==="default"){M=G.getAttribute("FragmentKind"),N=M?E[M]:undefined}else{N=xtdom.getLocalName(G)}J=G.firstChild?G.firstChild.nodeValue:undefined;if(N){L=xtdom.createElement(I,N);K.appendChild(L);K=L;if((F==="span")&&xtdom.hasAttribute(G,"class")){xtdom.addClassName(L,G.getAttribute("class"))}}y(K,J,I)};var q=function q(J,N,K,H){var O,G,I;if(H!=="default"){O=N;G=N.getAttribute("href");I=xtdom.hasAttribute(N,"data-input")?N.getAttribute("data-input"):null}else{var P=h(N);var F=xtdom.getLocalName(P[0]);var R=0,S=0;if(F==="LinkText"){S=1}else{R=1}O=P[R];G=P[S].firstChild?P[S].firstChild.nodeValue:"...";I=xtdom.hasAttribute(P[S],"data-input")?P[S].getAttribute("data-input"):null}var Q=xtdom.createElement(K,"a");var M=O.firstChild?O.firstChild.nodeValue:"...";var L=xtdom.createTextNode(K,M);Q.appendChild(L);Q.setAttribute("href",G);if(I){Q.setAttribute("data-input",I)}J.appendChild(Q)};var f=function f(L,K,F,J){var G,H,I=K.firstChild;while(I){if(I.nodeType===xtdom.ELEMENT_NODE){G=xtdom.getLocalName(I);if((G==="Link")||(G==="a")||(G==="A")){q(L,I,F,J)}else{o(L,I,F,J)}}else{if(J==="html"){if(I===K.firstChild){H=I.nodeValue.replace(/^\s+/g,"")}else{if(I.nextSibling){H=I.nodeValue}else{H=I.nodeValue.replace(/\s+$/g,"")}}y(L,H,F)}}I=I.nextSibling}};var A=function A(G){var F="popupdevice";var H=xtiger.session(G).load(F);if(!H){H=new xtiger.editor.PopupDevice(G);xtiger.session(G).save(F,H)}return H};var m=function m(G,F){var I,H;var J=G.firstChild;while(J){H=J.nextSibling;if(J.nodeType==xtdom.TEXT_NODE){I=xtdom.createElement(F,"span");G.replaceChild(I,J);I.appendChild(J)}J=H}};var a={onLoad:function l(H,G){if(G.isEmpty(H)){this.__wiki__onLoad(H,G)}else{var F=this.getHandle();xtdom.removeChildrenOf(F);f(F,H[0],this.getDocument(),this.getParam("wiki_lang")||"default");this.setModified(true);this.set(false)}},onSave:function z(F){var G;if(this.isOptional()&&!this._isOptionSet){F.discardNodeIfEmpty();return}G=this.getParam("wiki_lang")||"default";if(G==="html"){F.allowMixedContent()}return(G==="default")?this._saveHandleAsFragment(F):this._saveHandleAsIs(F)},methods:{_setData:function d(F){var G=this.getParam("wiki_lang")||"default";try{this.getHandle().innerHTML=xtiger.util.encodeEntities(F).replace(w,x(G));if(G=="span"){m(this.getHandle(),this.getDocument())}}catch(H){xtiger.cross.log("error","Exception "+H.name+"\n"+H.message);try{this.getHandle().innerHTML=xtiger.util.encodeEntities(F)+" (Exception : "+H.name+" - "+H.message+")"}catch(H){}}},_saveHandleAsIs:function(G){var K,J,I,F,H;var L=this.getHandle().firstChild;while(L){if(L.nodeType==xtdom.ELEMENT_NODE){if(L.firstChild){K=xtdom.getLocalName(L);G.openTag(K);if((K=="a")||(K=="A")){if(L.getAttribute("data-rewritten")){I=L.getAttribute("data-input")||"..."}else{I=L.getAttribute("href")||"..."}G.openAttribute("href");G.write(I);G.closeAttribute("href")}if(xtdom.hasAttribute(L,"data-input")&&!(xtdom.hasAttribute(L,"data-rewritten"))){G.openAttribute("data-input");G.write(L.getAttribute("data-input"));G.closeAttribute("data-input")}if(xtdom.hasAttribute(L,"class")){G.openAttribute("class");G.write(L.getAttribute("class"));G.closeAttribute("class")}G.write(L.firstChild.data);G.closeTag(K)}}else{if(L.data&&(L.data.search(/\S/)!=-1)){G.write(L.data)}}L=L.nextSibling}},_saveHandleAsFragment:function(G,L){var J,I,H,F;var K=this.getHandle().firstChild;while(K){if(K.nodeType==xtdom.ELEMENT_NODE){J=xtdom.getLocalName(K);F=u[J];if(F){if(K.firstChild){G.openTag("Fragment");G.openAttribute("FragmentKind");G.write(F);G.closeAttribute("FragmentKind");G.write(K.firstChild.data);G.closeTag("Fragment")}}else{if((J=="a")||(J=="A")){I=(K.firstChild)?K.firstChild.data:"...";if(xtdom.hasAttribute(K,"data-rewritten")){H=K.getAttribute("data-input")||"..."}else{H=K.getAttribute("href")||"..."}G.openTag("Link");if(L=="html"){G.write(I);G.openAttribute("href");G.write(H);G.closeAttribute("href")}else{G.openTag("LinkText");G.write(I);G.closeTag("LinkText");G.openTag("LinkRef");if(xtdom.hasAttribute(K,"data-input")&&!(xtdom.hasAttribute(K,"data-rewritten"))){G.openAttribute("data-input");G.write(K.getAttribute("data-input"));G.closeAttribute("data-input")}G.write(H);G.closeTag("LinkRef")}G.closeTag("Link")}else{G.openTag(J);G.write(K.firstChild.data);G.closeTag(J)}}}else{if(K.data&&(K.data.search(/\S/)!=-1)){G.openTag("Fragment");G.write(K.data);G.closeTag("Fragment")}}K=K.nextSibling}},getData:function p(){var I,H,G;var F="";var J=this.getHandle().firstChild;while(J){if(J.nodeType==xtdom.ELEMENT_NODE){if(this.getParam("wiki_lang")==="span"){I=J.getAttribute("class");H=I?j[I]:undefined;I=xtdom.getLocalName(J)}else{I=xtdom.getLocalName(J);H=k[I]}if((I==="a")||(I==="A")){G=J.getAttribute("data-input")||J.getAttribute("href")||"...";F+="=="+(J.firstChild?J.firstChild.data:"...")+"==("+G+")"}else{if(J.firstChild){if(H===undefined){F+=J.firstChild.data}else{F+=H+J.firstChild.data+H}}}}else{F+=J.data}J=J.nextSibling}return F},startEditing:function D(I){var H,G;if(I){H=xtdom.getEventTarget(I);G=xtdom.getLocalName(H);if(G.toUpperCase()==="A"){xtdom.preventDefault(I);xtdom.stopPropagation(I);var F=A(this.getDocument());this._url=H.getAttribute("href");if((!this._url)||(this._url=="")){this._url=H.getAttribute("HREF")}F.startEditing(this,["edit","open"],"edit",H);return}}this.__wiki__startEditing(I)},onMenuSelection:function B(F){if(F=="edit"){this.__wiki__startEditing()}else{if(F=="open"){window.open(this._url)}}},setSelectionState:function i(F){return F?this.set():this.unset()}}};e.filter.register("wiki",{chain:["onLoad","startEditing"]},{},a);e.filter.applyTo({wiki:"text"})}($axel));(function(b){var e={fr:{closeText:"Fermer",prevText:"Précédent",nextText:"Suivant",currentText:"Aujourd'hui",monthNames:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],monthNamesShort:["Janv.","Févr.","Mars","Avril","Mai","Juin","Juil.","Août","Sept.","Oct.","Nov.","Déc."],dayNames:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],dayNamesShort:["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."],dayNamesMin:["D","L","M","M","J","V","S"],weekHeader:"Sem.",dateFormat:"dd/mm/yy",firstDay:1,isRTL:false,showMonthAfterYear:false,yearSuffix:""}};var a=function(k,g,l,h){var f=k.getParam(l);var j=k.getParam(h);if(l==="date_region"){f=e[f]?e[f].dateFormat:$.datepicker.regional[""].dateFormat;j=$.datepicker[j]||j}if(h==="date_region"){f=$.datepicker[f]||f;j=e[j]?e[j].dateFormat:$.datepicker.regional[""].dateFormat}var i=null;try{i=$.datepicker.formatDate(j,$.datepicker.parseDate(f,g))}catch(m){i=g}return i};var c=function(f){var g=this;this.handle=xtdom.createElement(f,"input");xtdom.setAttribute(this.handle,"size",10);this.jhandle=$(this.handle);this.jhandle.datepicker().datepicker("option","onClose",function(){g.onClose()});this.myDoc=f;this.cache={}};c.prototype={grab:function(j,f){var g,i,k=j.getParam("date_region");$.datepicker.setDefaults((k==="fr")?e.fr:$.datepicker.regional[""]);this.jhandle.val(j.getData());this.editorHandle=j.getHandle();this.model=j;i=xtdom.getLocalName(this.editorHandle);if(i.toLowerCase()==="input"){i="span"}if(!this.cache[i]){this.hook=xtdom.createElement(this.myDoc,i);this.cache[i]=this.hook}else{this.hook=this.cache[i]}g=j.getParam("minDate");this.jhandle.datepicker("option","minDate",g||null);g=j.getParam("maxDate");this.jhandle.datepicker("option","maxDate",g||null);g=j.getParam("beforeShow");if(g){this.jhandle.datepicker("option","beforeShow",g)}else{this.jhandle.datepicker("option","beforeShow",g)}var h=this.editorHandle.parentNode;if(this.hook.firstChild!=this.handle){this.hook.appendChild(this.handle)}h.insertBefore(this.hook,this.editorHandle,true);h.removeChild(this.editorHandle);if(f){xtdom.focusAndSelect(this.handle)}else{this.jhandle.datepicker("show")}this.closingInProgress=false},release:function(f){var g=this.hook.parentNode;g.insertBefore(this.editorHandle,this.hook,true);g.removeChild(this.hook);if(!f){this.model.update(this.jhandle.val())}if(!this.closingInProgress){this.closingInProgress=true;this.jhandle.datepicker("hide")}},onClose:function(){if(!this.closingInProgress){this.release()}}};xtiger.registry.registerFactory("datepickerdev",{getInstance:function(g){var f=xtiger.session(g).load("datepickerdev");if(!f){f=new c(g);xtiger.session(g).save("datepickerdev",f)}return f}});var d={onAwake:function(){var f;if(this.getParam("maxDate")==="today"){f=$.datepicker.formatDate("dd/mm/yy",new Date());this.configure("maxDate",f)}if(this.getParam("minDate")==="today"){f=f||$.datepicker.formatDate("dd/mm/yy",new Date());this.configure("minDate",f)}if(this.getDefaultData()==="today"){this._setData(f||$.datepicker.formatDate("dd/mm/yy",new Date()))}this.__date__onAwake()},onLoad:function(g,f){this.__date__onLoad(g,f);this._setData(a(this,this.getData(),"date_format","date_region"))},onSave:function(f){var g=this.getData();this._data=a(this,g,"date_region","date_format");this.__date__onSave(f);this._data=g},methods:{startEditing:function(h){var f=!this.isModified()||(h&&h.shiftKey);var g=xtiger.factory("datepickerdev").getInstance(this.getDocument());g.grab(this,f)},stopEditing:function(g){var f=xtiger.factory("datepickerdev").getInstance(this.getDocument());f.release(g)},configure:function(f,g){if((g===undefined)||(((f==="minDate")||(f==="maxDate"))&&isNaN(new Date(g).getDay()))){delete this._param[f]}else{this._param[f]=g}}}};b.filter.register("date",{chain:["onAwake","onLoad","onSave"]},{date_region:"fr",date_format:"ISO_8601"},d);b.filter.applyTo({date:"text"});xtiger.util.date={convertDate:a,setRegion:function(f){$.datepicker.setDefaults((f==="fr")?e.fr:$.datepicker.regional[""])}}}($axel));(function(a){function b(g){var h=g.getParam("width_root_class"),e=g.getParam("width_target_class"),d=$(g.getHandle(true)).closest("."+h),f=e?d.find("."+e).first():d;if(!f){xtiger.cross.log("warning","'width' filter could not find target node")}return f}var c={methods:{set:function(d){var f,e=b(this);if(e){f=this.getData();if(/^\d+$/.test(f)){f=f+"px"}else{f="auto"}e.css("width",f)}this.__width__set(d)},clear:function(d){var e=b(this);if(e){e.css("width","")}this.____width__clear(d)}}};a.filter.register("width",{chain:["set","clear"]},null,c);a.filter.applyTo({width:"text"})}($axel));(function(a){function b(g,j){var i=g.getParam("style_root_class"),e=g.getParam("style_target_class"),h=g.getParam("style_target_selector"),d=i?$(g.getHandle(true)).closest("."+i):null,f=d;if(d){if(e){f=d.find("."+e).first()}else{if(h){f=d.find(h).first()}}}if((!f)&&(!j)){xtiger.cross.log("warning","'style' filter could not find target node")}return f}var c={onInit:function(g,d,e){var f;this.__style__onInit(g,d,e);f=this.getParam("style_value");if(f){this._CurStyleValue=f.replace(/\$_/g,g)}else{this._CurStyleValue=g}},methods:{set:function(e){var k,d,l,f,i,j,g,h=this.getParam("style_unit");this.__style__set(e);i=this.getParam("style_rule_selector");if(i){g=i+" {"+this.getParam("style_property")+":"+this.getData()+(h?h+"}":"}")}i=this.getParam("style_rule");if(i){g=i.replace(/\$_/g,this.getData())}if(g){j=this.getDocument();if(!this._StyleRuleHandle){this._StyleRuleHandle=$("<style type='text/css'> </style>",j).appendTo($("head",j))}this._StyleRuleHandle.text(g)}f=b(this,g!==undefined);if(f){d=this.getParam("style_property")||"class";l=this.getParam("values");if(l){k=this.getData();if(this._CurStyleValue){if(d==="class"){f.removeClass(this._CurStyleValue)}}this._CurStyleValue=k}else{k=this.getParam("style_value")||this.getData()}i=this.getParam("style_value");if(i){k=i.replace(/\$_/g,k);if(this._CurStyleValue){this._CurStyleValue=k}}if(d==="class"){f.addClass(k)}else{f.css(d,h?k+h:k)}}},unset:function(d){var e,i,h,g,f;this.__style__unset(d);i=this.getParam("style_property")||"class";g=this.getParam("style_rule_selector")||this.getParam("style_rule");if(g&&this._StyleRuleHandle){this._StyleRuleHandle.text("")}h=b(this,g);if(h){i=this.getParam("style_property")||"class";if(this.getParam("values")){e=this._CurStyleValue}else{e=this.getParam("style_value")||this.getData()}if(e){(i==="class")?h.removeClass(e):h.css(i,"")}}}}};a.filter.register("style",{chain:["onInit","set","unset"]},null,c);a.filter.applyTo({style:["text","select"]})}($axel));(function(a){var d=function d(f){var g=f.match(/^[^&]*/)[0];return g.match(/[^\=\/]*$/)[0]};var b=function b(g,m,h,n){var l=h||{};l.movie=g;if(!l.allowFullScreen){l.allowFullScreen="true"}if(!l.alloscriptaccess){l.alloscriptaccess="always"}var j=xtdom.createElement(n,"object");if(m){j.height=m[0];j.width=m[1]}else{j.height=344;j.width=425}j.style.zIndex=1000;for(var i in l){var f=xtdom.createElement(n,"param");f.name=i;f.value=l[i];j.appendChild(f)}var k=xtdom.createElement(n,"embed");xtdom.setAttribute(k,"src",g);xtdom.setAttribute(k,"type","application/x-shockwave-flash");xtdom.setAttribute(k,"allowfullscreen","true");xtdom.setAttribute(k,"allowscriptaccess","always");xtdom.setAttribute(k,"width","425");xtdom.setAttribute(k,"height","344");k.style.zIndex=1000;if(xtiger.cross.UA.IE){j=k}else{j.appendChild(k)}return j};var c=function c(i){var g=i.getHandle(true);var j=g.nextSibling?g.nextSibling.nextSibling:undefined;var k=false;if(j){var f=xtdom.getLocalName(j);if((f.toLowerCase()=="object")||(f.toLowerCase()=="embed")){k=true}else{if(f.toLowerCase()!="img"){j=undefined}}}return[j,k]};var e={onInit:function(n,i,m){if(!m){var k=this.getHandle();var g=xtdom.createElement(this.getDocument(),"br");var f=xtdom.createElement(this.getDocument(),"img");var l=xtdom.createElement(this.getDocument(),"span");xtdom.addClassName(l,"axel-core-boundary");f.src=xtiger.bundles.video.tvIconURL;var j=k.parentNode;if(k.nextSibling){j.insertBefore(l,k.nextSibling,true);j.insertBefore(f,l,true);j.insertBefore(g,f,true)}else{j.appendChild(g);j.appendChild(f);j.appendChild(l)}}this.__video__onInit(n,i,m)},methods:{_setData:function(k){var m=c(this);var g=k;if(m[0]){if(k!=this.getDefaultData()){var j=this.getData();var h=d(k);var i="http://www.youtube.com/v/"+h;if(j!=i){var l=b(i,null,null,this.getDocument());m[0].parentNode.replaceChild(l,m[0]);g=i}}else{if(m[1]){var f=xtdom.createElement(this.getDocument(),"img");f.src=xtiger.bundles.video.tvIconURL;m[0].parentNode.replaceChild(f,m[0])}}}this.__video___setData(g)},set:function(g){this.__video__set(g);if(this.isOptional()){var f=this.getHandle(true);if(f.nextSibling&&f.nextSibling.nextSibling){xtdom.replaceClassNameBy(f.nextSibling.nextSibling,"axel-option-unset","axel-option-set")}}},unset:function(g){this.__video__unset(g);if(this.isOptional()){var f=this.getHandle(true);if(f.nextSibling&&f.nextSibling.nextSibling){xtdom.replaceClassNameBy(f.nextSibling.nextSibling,"axel-option-set","axel-option-unset")}}}}};a.filter.register("video",{chain:["onInit","set","unset","_setData"]},null,e);a.filter.applyTo({video:"text"})}($axel));(function(a){a.addLocale("en",{errNoXML:function(b){return b.url+" loaded but it contains no XML data"},errLoadDocumentStatus:function(b){return"HTTP error"+(b.url?" while loading "+b.url:"")+" status code "+b.xhr.status},errException:function(b){return"exception "+b.e.name+" "+b.e.message+(b.url?" while loading "+b.url:"")+(b.status?" status code "+b.xhr.status:"")},errTransformNoTarget:function(b){return"transformation aborted because target container "+b.id+" not found in target document"},errTransformIframeSecurity:"the editor could not be generated because browser security restrictions prevented access to window iframe content",errDataSourceUndef:"undefined or missing XML data source",errEmptySet4Template:"cannot load template into empty wrapped set",errNoBundlesPath:"missing bundlesPath declaration to transform template",errNoSerializer:"missing XML serializer algorithm",errNoLoader:"missing XML loader algorithm",errEmptySet4XML:"cannot load XML data source into empty wrapped set",errTemplateNoBody:"Could not get <body> element from the template to transform",errTemplateUndef:"The document containing the template is null or undefined",errNoTemplate:"no template to transform",errTargetNoHead:"cannot inject editor's style sheet because target document has no head section",errDataSourceNoData:"data source empty"})}($axel));